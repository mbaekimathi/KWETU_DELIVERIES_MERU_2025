{% extends "base.html" %}

{% block title %}{% if shop %}{{ shop.name }} - Kwetu Deliveries{% else %}Shop Not Found{% endif %}{% endblock %}

{% block extra_head %}
<style>
    /* Shop View Container */
    .shop-view-container {
        min-height: calc(100vh - 200px);
        padding: 2rem 0;
        max-width: 1400px;
        margin: 0 auto;
        position: relative;
    }

    /* Add top margin to account for fixed header */
    .items-section,
    .delivery-only-announcement {
        margin-top: 0;
    }

    /* Floating Cart Button */
    .cart-fab {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 999;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%);
        color: white;
        border: none;
        box-shadow: 0 8px 24px rgba(255, 107, 53, 0.4), 0 4px 12px rgba(255, 107, 53, 0.3);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        animation: fadeInUp 0.6s ease-out 0.3s backwards;
    }

    .cart-fab:hover {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 12px 32px rgba(255, 107, 53, 0.5), 0 6px 16px rgba(255, 107, 53, 0.4);
    }

    .cart-fab:active {
        transform: translateY(-2px) scale(1.02);
    }

    .cart-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #004E89;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 0.75rem;
        font-weight: 700;
        display: none;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .cart-badge.show {
        display: flex;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 768px) {
        .cart-fab {
            bottom: 1.5rem;
            right: 1.5rem;
            width: 56px;
            height: 56px;
            font-size: 1.5rem;
        }
    }

    /* Shop Header - Profile Style Top Right */
    .shop-header-section {
        position: fixed;
        top: 80px;
        right: 1.5rem;
        z-index: 100;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border-radius: 20px;
        padding: 1.25rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.12), 0 10px 10px -5px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.8);
        animation: fadeInDown 0.6s ease-out;
        max-width: 320px;
        width: 100%;
    }

    .shop-header-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #FF6B35 0%, #FF8C5A 50%, #004E89 100%);
        border-radius: 20px 20px 0 0;
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .shop-header-content {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .shop-image-wrapper {
        width: 80px;
        height: 80px;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        flex-shrink: 0;
        background: linear-gradient(135deg, #FF6B35 0%, #004E89 100%);
        border: 3px solid rgba(255, 255, 255, 0.9);
        margin: 0 auto;
        transition: transform 0.3s ease;
    }

    .shop-image-wrapper:hover {
        transform: scale(1.05);
    }

    .shop-image-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .shop-profile-image {
        display: block;
    }

    .shop-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 3rem;
    }

    .shop-placeholder.hidden {
        display: none;
    }

    .shop-info {
        text-align: center;
    }

    .shop-name {
        font-size: 1.25rem;
        font-weight: 800;
        color: #0f172a;
        margin-bottom: 0.75rem;
        letter-spacing: -0.02em;
        line-height: 1.2;
    }

    .shop-meta {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1rem;
        align-items: center;
    }

    .shop-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.875rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    }

    .shop-status-badge.open {
        background: rgba(34, 197, 94, 0.15);
        color: #16a34a;
        border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .shop-status-badge.closed {
        background: rgba(239, 68, 68, 0.15);
        color: #dc2626;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
        display: inline-block;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    .shop-rating {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        color: #64748b;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .shop-rating .star {
        color: #fbbf24;
        font-size: 1rem;
    }

    .shop-location {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        color: #64748b;
        font-size: 0.8125rem;
    }

    .contact-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        background: linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%);
        color: white;
        border-radius: 12px;
        text-decoration: none;
        font-weight: 700;
        font-size: 0.875rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.35);
        width: 100%;
        justify-content: center;
    }

    .contact-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 107, 53, 0.45);
    }

    .contact-button:active {
        transform: translateY(0);
    }

    /* Delivery Only Announcement */
    .delivery-only-announcement {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(249, 250, 251, 0.95) 100%);
        backdrop-filter: blur(24px);
        -webkit-backdrop-filter: blur(24px);
        border-radius: 32px;
        padding: 4rem 3rem;
        text-align: center;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(0, 0, 0, 0.05);
        animation: fadeInUp 0.8s ease-out;
        border: 1px solid rgba(255, 255, 255, 0.8);
        position: relative;
        overflow: hidden;
    }

    .delivery-only-announcement::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 5px;
        background: linear-gradient(90deg, #FF6B35 0%, #FF8C5A 50%, #004E89 100%);
        border-radius: 32px 32px 0 0;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .delivery-icon {
        font-size: 6rem;
        margin-bottom: 2rem;
        animation: float 3s ease-in-out infinite;
        filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.1));
    }

    @keyframes float {
        0%, 100% {
            transform: translateY(0) scale(1);
        }
        50% {
            transform: translateY(-12px) scale(1.05);
        }
    }

    .delivery-title {
        font-size: 2.5rem;
        font-weight: 800;
        color: #0f172a;
        margin-bottom: 1.25rem;
        letter-spacing: -0.03em;
        line-height: 1.2;
        background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .delivery-message {
        font-size: 1.25rem;
        color: #475569;
        line-height: 1.8;
        margin-bottom: 2.5rem;
        max-width: 650px;
        margin-left: auto;
        margin-right: auto;
        font-weight: 500;
    }

    .delivery-cta {
        display: inline-flex;
        align-items: center;
        gap: 0.875rem;
        padding: 1.125rem 2.5rem;
        background: linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%);
        color: white;
        border-radius: 20px;
        text-decoration: none;
        font-weight: 700;
        font-size: 1.125rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 10px 20px rgba(255, 107, 53, 0.4), 0 4px 8px rgba(255, 107, 53, 0.2);
        position: relative;
        overflow: hidden;
    }

    .delivery-cta::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s ease;
    }

    .delivery-cta:hover::before {
        left: 100%;
    }

    .delivery-cta:hover {
        transform: translateY(-3px);
        box-shadow: 0 14px 28px rgba(255, 107, 53, 0.5), 0 6px 12px rgba(255, 107, 53, 0.3);
    }

    .delivery-cta:active {
        transform: translateY(-1px);
    }

    /* Items Section */
    .items-section {
        margin-top: 3rem;
    }

    .category-section {
        margin-bottom: 4rem;
    }

    .category-title {
        font-size: 2rem;
        font-weight: 800;
        color: #0f172a;
        margin-bottom: 2rem;
        padding: 0 1rem;
        letter-spacing: -0.03em;
        position: relative;
        display: inline-block;
    }

    .category-title::after {
        content: '';
        position: absolute;
        bottom: -0.5rem;
        left: 1rem;
        width: 60px;
        height: 4px;
        background: linear-gradient(90deg, #FF6B35 0%, #FF8C5A 100%);
        border-radius: 2px;
    }

    /* Items Scroll Container */
    .items-scroll-container {
        position: relative;
        overflow-x: auto;
        overflow-y: hidden;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
        padding: 0 1rem;
        margin-bottom: 2.5rem;
        scroll-padding: 0 1rem;
    }

    .items-scroll-container::-webkit-scrollbar {
        display: none;
    }

    .items-row {
        display: flex;
        gap: 1rem;
        padding-bottom: 0.75rem;
        padding-right: 1rem;
        min-width: max-content;
    }

    /* Item Card */
    .item-card {
        position: relative;
        width: 130px;
        height: 180px;
        border-radius: 16px;
        overflow: hidden;
        cursor: pointer;
        flex-shrink: 0;
        background: #f1f5f9;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        animation: fadeInUp 0.6s ease-out backwards;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .item-card:nth-child(1) { animation-delay: 0.1s; }
    .item-card:nth-child(2) { animation-delay: 0.2s; }
    .item-card:nth-child(3) { animation-delay: 0.3s; }
    .item-card:nth-child(4) { animation-delay: 0.4s; }
    .item-card:nth-child(5) { animation-delay: 0.5s; }

    .item-card:hover {
        transform: translateY(-6px) scale(1.03);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
    }

    /* Item Background Image */
    .item-bg-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1;
        display: block;
    }

    .item-bg-fallback {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #FF6B35 0%, #004E89 100%);
        z-index: 1;
    }

    .item-bg-fallback.hidden {
        display: none;
    }

    .item-card:hover .item-bg-image {
        transform: scale(1.1);
    }

    /* Discount Badge */
    .item-discount-badge {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        z-index: 20;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 12px;
        font-size: 0.6875rem;
        font-weight: 800;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.5), 0 2px 4px rgba(239, 68, 68, 0.3);
        display: flex;
        align-items: center;
        gap: 0.375rem;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: pulse-badge 2s ease-in-out infinite;
    }

    @keyframes pulse-badge {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }

    .item-discount-badge::before {
        content: 'üî•';
        font-size: 0.75rem;
    }

    /* Gradient Overlay */
    .item-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 25%;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0.5) 50%, transparent 100%);
        z-index: 2;
    }

    /* Floating Content at Bottom */
    .item-content {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 0.5rem 0.75rem;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(16px) saturate(180%);
        -webkit-backdrop-filter: blur(16px) saturate(180%);
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        z-index: 3;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        min-height: fit-content;
    }

    .item-card:hover .item-content {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px) saturate(200%);
        -webkit-backdrop-filter: blur(20px) saturate(200%);
    }

    .item-name {
        font-size: 0.8125rem;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 0.1875rem;
        line-height: 1.2;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        line-clamp: 1;
        -webkit-box-orient: vertical;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
    }

    .item-description {
        font-size: 0.625rem;
        color: rgba(255, 255, 255, 0.85);
        margin-bottom: 0.25rem;
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        line-clamp: 1;
        -webkit-box-orient: vertical;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .item-price {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        flex-wrap: wrap;
    }

    .item-price-current {
        font-size: 0.9375rem;
        font-weight: 700;
        color: #ffffff;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
    }

    .item-price-original {
        font-size: 0.6875rem;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: line-through;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    /* Error State */
    .error-container {
        text-align: center;
        padding: 5rem 2rem;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.95) 100%);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 32px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.8);
        max-width: 600px;
        margin: 0 auto;
    }

    .error-icon {
        font-size: 5rem;
        margin-bottom: 1.5rem;
        opacity: 0.6;
        animation: float 3s ease-in-out infinite;
    }

    .error-title {
        font-size: 2rem;
        font-weight: 800;
        color: #0f172a;
        margin-bottom: 0.75rem;
        letter-spacing: -0.02em;
    }

    .error-message {
        color: #64748b;
        margin-bottom: 2.5rem;
        font-size: 1.125rem;
        line-height: 1.6;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .shop-header-section {
            position: relative;
            top: auto;
            right: auto;
            max-width: 100%;
            margin-bottom: 2rem;
            padding: 1.5rem;
        }

        .shop-header-content {
            flex-direction: row;
            gap: 1.25rem;
        }

        .shop-image-wrapper {
            width: 90px;
            height: 90px;
        }

        .shop-info {
            text-align: left;
            flex: 1;
        }

        .shop-name {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .shop-meta {
            flex-direction: row;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .delivery-only-announcement {
            padding: 2rem 1.5rem;
        }

        .delivery-icon {
            font-size: 4rem;
        }

        .delivery-title {
            font-size: 1.5rem;
        }

        .delivery-message {
            font-size: 1rem;
        }

        .item-card {
            width: 140px;
            height: 200px;
        }

        .item-content {
            padding: 0.4375rem 0.625rem;
        }

        .item-overlay {
            height: 25%;
        }

        .item-name {
            font-size: 0.75rem;
            margin-bottom: 0.125rem;
        }

        .item-description {
            font-size: 0.5625rem;
            margin-bottom: 0.1875rem;
        }

        .item-price-current {
            font-size: 0.875rem;
        }

        .item-discount-badge {
            top: 0.5rem;
            right: 0.5rem;
            padding: 0.375rem 0.625rem;
            font-size: 0.625rem;
        }
    }

    @media (max-width: 480px) {
        .shop-view-container {
            padding: 1rem 0;
        }

        .shop-header-section {
            position: relative;
            top: auto;
            right: auto;
            max-width: 100%;
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            border-radius: 16px;
        }

        .shop-header-content {
            flex-direction: row;
            gap: 1rem;
        }

        .shop-image-wrapper {
            width: 70px;
            height: 70px;
            border-radius: 12px;
        }

        .shop-name {
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        .shop-meta {
            gap: 0.75rem;
            flex-direction: column;
            align-items: flex-start;
        }

        .delivery-only-announcement {
            padding: 1.5rem 1rem;
        }

        .delivery-icon {
            font-size: 3rem;
        }

        .delivery-title {
            font-size: 1.25rem;
        }

        .item-card {
            width: 110px;
            height: 160px;
        }

        .item-content {
            padding: 0.375rem 0.5rem;
        }

        .item-overlay {
            height: 25%;
        }

        .item-name {
            font-size: 0.6875rem;
            margin-bottom: 0.125rem;
        }

        .item-description {
            font-size: 0.5rem;
            margin-bottom: 0.125rem;
        }

        .item-price-current {
            font-size: 0.8125rem;
        }

        .item-price-original {
            font-size: 0.625rem;
        }

        .item-discount-badge {
            top: 0.25rem;
            right: 0.25rem;
            padding: 0.25rem 0.4375rem;
            font-size: 0.5625rem;
        }

        .item-discount-badge::before {
            font-size: 0.625rem;
        }

        .item-price-current {
            font-size: 0.875rem;
        }

        .item-price-original {
            font-size: 0.6875rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="shop-view-container">
    {% if error %}
        <div class="error-container">
            <div class="error-icon">üè™</div>
            <h1 class="error-title">{{ error }}</h1>
            <p class="error-message">The shop you're looking for doesn't exist or is not available.</p>
            <a href="{{ url_for('index') }}" class="contact-button">Go Home</a>
        </div>
    {% elif shop %}
        <!-- Floating Cart Button -->
        <button class="cart-fab" onclick="openCartModal()" id="cart-fab-btn" aria-label="Open Cart">
            üõí
            <span class="cart-badge" id="cart-badge-fab">0</span>
        </button>

        <!-- Shop Header -->
        <div class="shop-header-section">
            <div class="shop-header-content">
                <div class="shop-image-wrapper">
                    {% if shop.profile_image %}
                        {% set profile_img = shop.profile_image %}
                        {% if profile_img.startswith('uploads/') %}
                            {% set profile_img_path = profile_img %}
                        {% elif profile_img.startswith('profiles/') %}
                            {% set profile_img_path = 'uploads/' + profile_img %}
                        {% else %}
                            {% set profile_img_path = 'uploads/profiles/' + profile_img %}
                        {% endif %}
                        <img src="{{ url_for('static', filename=profile_img_path) }}" 
                             alt="{{ shop.name }}"
                             class="shop-profile-image"
                             onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                    {% endif %}
                    <div class="shop-placeholder{% if shop.profile_image %} hidden{% endif %}">üè™</div>
                </div>
                <div class="shop-info">
                    <h1 class="shop-name">{{ shop.name }}</h1>
                    <div class="shop-meta">
                        <div class="shop-status-badge {{ shop.status }}">
                            <span class="status-dot"></span>
                            <span>{{ shop.status|upper }}</span>
                        </div>
                        {% if shop.rating %}
                            <div class="shop-rating">
                                <span class="star">‚≠ê</span>
                                <span>{{ "%.1f"|format(shop.rating) }}</span>
                            </div>
                        {% endif %}
                        {% if shop.location_name %}
                            <div class="shop-location">
                                <span>üìç</span>
                                <span>{{ shop.location_name }}</span>
                            </div>
                        {% endif %}
                    </div>
                    {% if shop.phone %}
                        <a href="tel:{{ shop.phone }}" class="contact-button">
                            <span>üìû</span>
                            <span>Contact: {{ shop.phone }}</span>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Delivery Mode Logic -->
        {% if shop.delivery_mode == 1 %}
            <!-- Delivery Only Mode -->
            <div class="delivery-only-announcement">
                <div class="delivery-icon">üö¥</div>
                <h2 class="delivery-title">{{ shop.name }} - Delivery Only</h2>
                <p class="delivery-message">
                    This shop accepts delivery orders only. Browse our selection and place your order for fast, convenient delivery to your location.
                </p>
                {% if shop.phone %}
                    <a href="tel:{{ shop.phone }}" class="delivery-cta">
                        <span>üìû</span>
                        <span>Call to Order: {{ shop.phone }}</span>
                    </a>
                {% endif %}
            </div>
        {% else %}
            <!-- Items with Delivery Mode -->
            {% if items_by_category %}
                <div class="items-section">
                    {% for category, items in items_by_category.items() %}
                        <div class="category-section">
                            <h2 class="category-title">{{ category }}</h2>
                            <div class="items-scroll-container">
                                <div class="items-row">
                                    {% for item in items %}
                                        <div class="item-card" data-item-id="{{ item.id }}">
                                            {% if item.item_image %}
                                                {% set item_img = item.item_image %}
                                                {% if item_img.startswith('uploads/') %}
                                                    {% set item_img_path = item_img %}
                                                {% elif item_img.startswith('items/') %}
                                                    {% set item_img_path = 'uploads/' + item_img %}
                                                {% else %}
                                                    {% set item_img_path = 'uploads/items/' + item_img %}
                                                {% endif %}
                                                <img src="{{ url_for('static', filename=item_img_path) }}" 
                                                     alt="{{ item.item_name }}"
                                                     class="item-bg-image"
                                                     onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden');">
                                            {% else %}
                                                <div class="item-bg-fallback"></div>
                                            {% endif %}
                                            
                                            {% if item.discount_price %}
                                                {% set discount_percent = ((item.price - item.discount_price) / item.price * 100)|round %}
                                                <div class="item-discount-badge">
                                                    <span>{{ discount_percent }}% OFF</span>
                                                </div>
                                            {% endif %}
                                            
                                            <div class="item-overlay"></div>
                                            <div class="item-content">
                                                <h3 class="item-name">{{ item.item_name }}</h3>
                                                {% if item.description %}
                                                    <p class="item-description">{{ item.description }}</p>
                                                {% endif %}
                                                <div class="item-price">
                                                    {% if item.discount_price %}
                                                        <span class="item-price-current">KES {{ "%.2f"|format(item.discount_price) }}</span>
                                                        <span class="item-price-original">KES {{ "%.2f"|format(item.price) }}</span>
                                                    {% else %}
                                                        <span class="item-price-current">KES {{ "%.2f"|format(item.price) }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="delivery-only-announcement">
                    <div class="delivery-icon">üì¶</div>
                    <h2 class="delivery-title">No Items Available</h2>
                    <p class="delivery-message">
                        This shop doesn't have any items available at the moment. Please check back later or contact the shop directly.
                    </p>
                    {% if shop.phone %}
                        <a href="tel:{{ shop.phone }}" class="delivery-cta">
                            <span>üìû</span>
                            <span>Contact: {{ shop.phone }}</span>
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        {% endif %}
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Smooth horizontal scrolling for items
    document.querySelectorAll('.items-scroll-container').forEach(container => {
        let wheelTimeout = null;
        let wheelVelocity = 0;
        let wheelMomentum = null;
        let lastWheelTime = 0;
        
        container.addEventListener('wheel', (e) => {
            if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
                e.preventDefault();
                e.stopPropagation();
                
                const now = performance.now();
                const timeDelta = now - lastWheelTime;
                
                if (timeDelta < 100 && timeDelta > 0) {
                    wheelVelocity = wheelVelocity * 0.75 + e.deltaY * 1.2;
                } else {
                    wheelVelocity = e.deltaY * 1.2;
                }
                
                lastWheelTime = now;
                
                if (wheelMomentum) {
                    cancelAnimationFrame(wheelMomentum);
                    wheelMomentum = null;
                }
                
                container.scrollLeft += wheelVelocity;
                
                if (wheelTimeout) {
                    clearTimeout(wheelTimeout);
                }
                
                wheelTimeout = setTimeout(() => {
                    let currentVelocity = wheelVelocity * 0.7;
                    const friction = 0.93;
                    const minVelocity = 0.3;
                    
                    function applyMomentum() {
                        if (Math.abs(currentVelocity) > minVelocity) {
                            container.scrollLeft += currentVelocity;
                            currentVelocity *= friction;
                            wheelMomentum = requestAnimationFrame(applyMomentum);
                        } else {
                            wheelMomentum = null;
                            wheelVelocity = 0;
                        }
                    }
                    
                    wheelMomentum = requestAnimationFrame(applyMomentum);
                }, 60);
            }
        }, { passive: false });
    });

    // Cart Management
    let cart = JSON.parse(localStorage.getItem('cart') || '{}');
    const shopId = {% if shop %}{{ shop.id }}{% else %}null{% endif %};
    
    function updateCart() {
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartUI();
    }
    
    function updateCartUI() {
        const cartCount = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
        const cartBadge = document.getElementById('cart-badge');
        const cartBadgeFab = document.getElementById('cart-badge-fab');
        
        if (cartBadge) {
            cartBadge.textContent = cartCount;
            cartBadge.style.display = cartCount > 0 ? 'flex' : 'none';
        }
        
        if (cartBadgeFab) {
            cartBadgeFab.textContent = cartCount;
            if (cartCount > 0) {
                cartBadgeFab.classList.add('show');
            } else {
                cartBadgeFab.classList.remove('show');
            }
        }
    }
    
    // Add to cart from item cards
    document.querySelectorAll('.item-card').forEach(card => {
        card.addEventListener('click', function() {
            const itemId = this.dataset.itemId;
            if (itemId) {
                const itemName = this.querySelector('.item-name')?.textContent;
                const priceText = this.querySelector('.item-price-current')?.textContent;
                const price = parseFloat(priceText?.replace(/[^\d.]/g, '') || 0);
                const itemImage = this.querySelector('.item-bg-image')?.src || '';
                
                if (!cart[itemId]) {
                    cart[itemId] = {
                        item_id: itemId,
                        item_name: itemName,
                        item_image: itemImage,
                        quantity: 1,
                        unit_price: price,
                        subtotal: price
                    };
                } else {
                    cart[itemId].quantity++;
                    cart[itemId].subtotal = cart[itemId].quantity * cart[itemId].unit_price;
                }
                
                updateCart();
                openCartModal();
            }
        });
    });
    
    // Initialize cart UI
    updateCartUI();
</script>

<!-- Cart Modal -->
<div id="cart-modal" class="checkout-modal">
    <div class="modal-overlay"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h2 class="modal-title">Your Cart</h2>
            <button class="modal-close" onclick="closeModal('cart-modal')">√ó</button>
        </div>
        <div class="modal-body" id="cart-items">
            <!-- Cart items will be populated here -->
        </div>
        <div class="modal-footer">
            <div class="cart-summary">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="cart-subtotal">KES 0.00</span>
                </div>
                <div class="summary-row">
                    <span>Delivery Fee</span>
                    <span id="cart-delivery">KES 0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total</span>
                    <span id="cart-total">KES 0.00</span>
                </div>
            </div>
            <button class="checkout-btn" onclick="openLocationModal()" id="proceed-location-btn" disabled>
                Proceed to Delivery Location
            </button>
        </div>
    </div>
</div>

<!-- Location Selection Modal -->
<div id="location-modal" class="checkout-modal">
    <div class="modal-overlay"></div>
    <div class="modal-container large-modal">
        <div class="modal-header">
            <h2 class="modal-title">Select Delivery Location</h2>
            <button class="modal-close" onclick="closeModal('location-modal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="location-search">
                <input type="text" id="location-search" placeholder="Search your delivery location..." class="search-input">
                <button class="current-location-btn" onclick="getCurrentLocation()">
                    <span>üìç</span>
                    <span>Use Current Location</span>
                </button>
            </div>
            <div id="map-container" class="map-container">
                <!-- Google Maps will be loaded here -->
            </div>
            <div class="location-info">
                <div class="info-item">
                    <span class="info-label">üìç Distance:</span>
                    <span id="delivery-distance">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">‚è± Estimated Time:</span>
                    <span id="delivery-time">-</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="checkout-btn" onclick="confirmLocation()" id="confirm-location-btn" disabled>
                Confirm Location
            </button>
        </div>
    </div>
</div>

<!-- Delivery Summary Modal -->
<div id="summary-modal" class="checkout-modal">
    <div class="modal-overlay"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h2 class="modal-title">Order Summary</h2>
            <button class="modal-close" onclick="closeModal('summary-modal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="summary-section">
                <h3>Items</h3>
                <div id="summary-items"></div>
            </div>
            <div class="summary-section">
                <h3>Delivery Address</h3>
                <p id="summary-address">-</p>
            </div>
            <div class="summary-section">
                <div class="summary-row">
                    <span>Distance</span>
                    <span id="summary-distance">-</span>
                </div>
                <div class="summary-row">
                    <span>Estimated Delivery</span>
                    <span id="summary-time">-</span>
                </div>
                <div class="summary-row">
                    <span>Delivery Fee</span>
                    <span id="summary-delivery-fee">KES 0.00</span>
                </div>
            </div>
            <div class="summary-section">
                <label class="checkbox-label">
                    <input type="checkbox" id="contactless-delivery">
                    <span>Contactless Delivery</span>
                </label>
            </div>
            <div class="summary-section">
                <label>Notes for Rider (Optional)</label>
                <textarea id="delivery-notes" class="notes-input" placeholder="Any special instructions..."></textarea>
            </div>
            <div class="summary-total">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="summary-subtotal">KES 0.00</span>
                </div>
                <div class="summary-row">
                    <span>Delivery Fee</span>
                    <span id="summary-delivery-fee-final">KES 0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Grand Total</span>
                    <span id="summary-grand-total">KES 0.00</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="checkout-btn" onclick="openPaymentModal()">
                Proceed to Payment
            </button>
        </div>
    </div>
</div>

<!-- Payment Modal -->
<div id="payment-modal" class="checkout-modal">
    <div class="modal-overlay"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h2 class="modal-title">Payment</h2>
            <button class="modal-close" onclick="closeModal('payment-modal')">√ó</button>
        </div>
        <div class="modal-body">
            <div class="payment-methods">
                <div class="payment-option" data-method="mpesa" onclick="selectPaymentMethod('mpesa')">
                    <div class="payment-icon">üì±</div>
                    <div class="payment-info">
                        <h3>M-PESA</h3>
                        <p>STK Push</p>
                    </div>
                    <div class="payment-check">‚úì</div>
                </div>
                <div class="payment-option" data-method="cash_on_delivery" onclick="selectPaymentMethod('cash_on_delivery')">
                    <div class="payment-icon">üíµ</div>
                    <div class="payment-info">
                        <h3>Cash on Delivery</h3>
                        <p>Pay when you receive</p>
                    </div>
                    <div class="payment-check">‚úì</div>
                </div>
                <div class="payment-option" data-method="card" onclick="selectPaymentMethod('card')">
                    <div class="payment-icon">üí≥</div>
                    <div class="payment-info">
                        <h3>Card</h3>
                        <p>Credit/Debit Card</p>
                    </div>
                    <div class="payment-check">‚úì</div>
                </div>
            </div>
            <div class="payment-summary">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="payment-subtotal">KES 0.00</span>
                </div>
                <div class="summary-row">
                    <span>Delivery Fee</span>
                    <span id="payment-delivery">KES 0.00</span>
                </div>
                <div class="summary-row">
                    <span>Tax</span>
                    <span id="payment-tax">KES 0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Grand Total</span>
                    <span id="payment-total">KES 0.00</span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="checkout-btn" onclick="processPayment()" id="process-payment-btn">
                Confirm Payment
            </button>
        </div>
    </div>
</div>

<!-- Order Confirmation Modal -->
<div id="confirmation-modal" class="checkout-modal">
    <div class="modal-overlay"></div>
    <div class="modal-container">
        <div class="modal-header">
            <h2 class="modal-title">Order Confirmed! üéâ</h2>
            <button class="modal-close" onclick="closeModal('confirmation-modal')">√ó</button>
        </div>
        <div class="modal-body confirmation-body">
            <div class="confirmation-icon">‚úÖ</div>
            <h3 id="confirmation-order-number">Order #ORD1234567890</h3>
            <p class="confirmation-message">Your order has been placed successfully!</p>
            <div class="confirmation-details">
                <p><strong>Estimated Delivery:</strong> <span id="confirmation-time">-</span></p>
                <p><strong>Total Amount:</strong> <span id="confirmation-total">KES 0.00</span></p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="checkout-btn" onclick="viewReceipt()">
                View Receipt
            </button>
            <button class="checkout-btn secondary" onclick="closeAllModals()">
                Close
            </button>
        </div>
    </div>
</div>

<style>
    /* Checkout Modals */
    .checkout-modal {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .checkout-modal.active {
        display: flex;
    }

    .modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        animation: fadeIn 0.3s ease;
    }

    .modal-container {
        position: relative;
        background: white;
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1001;
    }

    .modal-container.large-modal {
        max-width: 800px;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
    }

    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0f172a;
        margin: 0;
        letter-spacing: -0.02em;
    }

    .modal-close {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background: #f3f4f6;
        color: #6b7280;
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .modal-close:hover {
        background: #e5e7eb;
        color: #374151;
        transform: rotate(90deg);
    }

    .modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 1px solid #e5e7eb;
        background: #f9fafb;
    }

    /* Cart Items */
    .cart-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 12px;
        margin-bottom: 0.75rem;
        align-items: center;
    }

    .cart-item-image {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        object-fit: cover;
        flex-shrink: 0;
    }

    .cart-item-info {
        flex: 1;
        min-width: 0;
    }

    .cart-item-name {
        font-weight: 600;
        color: #0f172a;
        margin-bottom: 0.25rem;
        font-size: 0.9375rem;
    }

    .cart-item-price {
        color: #FF6B35;
        font-weight: 700;
        font-size: 0.875rem;
    }

    .quantity-stepper {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: white;
        border-radius: 8px;
        padding: 0.25rem;
        border: 1px solid #e5e7eb;
    }

    .quantity-btn {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        border: none;
        background: #f3f4f6;
        color: #374151;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .quantity-btn:hover {
        background: #FF6B35;
        color: white;
    }

    .quantity-value {
        min-width: 30px;
        text-align: center;
        font-weight: 600;
        color: #0f172a;
    }

    .cart-summary {
        margin-bottom: 1rem;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        color: #64748b;
        font-size: 0.9375rem;
    }

    .summary-row.total {
        font-size: 1.125rem;
        font-weight: 700;
        color: #0f172a;
        border-top: 2px solid #e5e7eb;
        padding-top: 0.75rem;
        margin-top: 0.5rem;
    }

    .checkout-btn {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, #FF6B35 0%, #FF8C5A 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(255, 107, 53, 0.35);
    }

    .checkout-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(255, 107, 53, 0.45);
    }

    .checkout-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .checkout-btn.secondary {
        background: #f3f4f6;
        color: #374151;
        box-shadow: none;
        margin-top: 0.5rem;
    }

    .checkout-btn.secondary:hover {
        background: #e5e7eb;
    }

    /* Location Modal */
    .location-search {
        margin-bottom: 1rem;
    }

    .search-input {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 1rem;
        margin-bottom: 0.75rem;
        transition: border-color 0.2s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: #FF6B35;
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }

    .current-location-btn {
        width: 100%;
        padding: 0.875rem;
        background: linear-gradient(135deg, #004E89 0%, #1A6BA3 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
    }

    .current-location-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 78, 137, 0.35);
    }

    .map-container {
        width: 100%;
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1rem;
        background: #f3f4f6;
        border: 2px solid #e5e7eb;
    }

    .location-info {
        display: flex;
        gap: 1.5rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 12px;
        margin-bottom: 1rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .info-label {
        font-size: 0.875rem;
        color: #64748b;
    }

    .info-item span:last-child {
        font-weight: 700;
        color: #0f172a;
        font-size: 1rem;
    }

    /* Payment Methods */
    .payment-methods {
        margin-bottom: 1.5rem;
    }

    .payment-option {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .payment-option:hover {
        border-color: #FF6B35;
        background: #fff5f2;
    }

    .payment-option.selected {
        border-color: #FF6B35;
        background: #fff5f2;
    }

    .payment-option .payment-check {
        margin-left: auto;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #FF6B35;
        color: white;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }

    .payment-option.selected .payment-check {
        display: flex;
    }

    .payment-icon {
        font-size: 2rem;
    }

    .payment-info h3 {
        margin: 0 0 0.25rem 0;
        font-size: 1.125rem;
        color: #0f172a;
    }

    .payment-info p {
        margin: 0;
        font-size: 0.875rem;
        color: #64748b;
    }

    .payment-summary {
        background: #f9fafb;
        padding: 1rem;
        border-radius: 12px;
    }

    /* Confirmation */
    .confirmation-body {
        text-align: center;
        padding: 2rem 1.5rem;
    }

    .confirmation-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        animation: scaleIn 0.5s ease;
    }

    @keyframes scaleIn {
        from {
            transform: scale(0);
        }
        to {
            transform: scale(1);
        }
    }

    .confirmation-message {
        color: #64748b;
        margin: 1rem 0;
    }

    .confirmation-details {
        background: #f9fafb;
        padding: 1rem;
        border-radius: 12px;
        margin-top: 1.5rem;
        text-align: left;
    }

    .confirmation-details p {
        margin: 0.5rem 0;
        color: #374151;
    }

    /* Summary Section */
    .summary-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .summary-section:last-of-type {
        border-bottom: none;
    }

    .summary-section h3 {
        font-size: 1.125rem;
        font-weight: 700;
        color: #0f172a;
        margin-bottom: 0.75rem;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
    }

    .checkbox-label input[type="checkbox"] {
        width: 20px;
        height: 20px;
        accent-color: #FF6B35;
        cursor: pointer;
    }

    .notes-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-family: inherit;
        resize: vertical;
        min-height: 80px;
        margin-top: 0.5rem;
    }

    .notes-input:focus {
        outline: none;
        border-color: #FF6B35;
    }

    .summary-total {
        background: #f9fafb;
        padding: 1rem;
        border-radius: 12px;
        margin-top: 1rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .modal-container {
            max-width: 100%;
            max-height: 95vh;
            border-radius: 20px 20px 0 0;
            margin-top: auto;
        }

        .map-container {
            height: 300px;
        }
    }
</style>

<script>
    // Modal Management
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
        document.body.style.overflow = '';
    }

    function closeAllModals() {
        document.querySelectorAll('.checkout-modal').forEach(modal => {
            modal.classList.remove('active');
        });
        document.body.style.overflow = '';
    }

    // Close on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', function() {
            this.closest('.checkout-modal').classList.remove('active');
            document.body.style.overflow = '';
        });
    });

    // Cart Modal Functions
    function openCartModal() {
        renderCartItems();
        openModal('cart-modal');
    }

    function renderCartItems() {
        const container = document.getElementById('cart-items');
        const items = Object.values(cart);
        
        if (items.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 2rem;">Your cart is empty</p>';
            document.getElementById('proceed-location-btn').disabled = true;
            return;
        }

        container.innerHTML = items.map(item => `
            <div class="cart-item">
                <img src="${item.item_image}" alt="${item.item_name}" class="cart-item-image" onerror="this.style.display='none'">
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.item_name}</div>
                    <div class="cart-item-price">KES ${item.subtotal.toFixed(2)}</div>
                </div>
                <div class="quantity-stepper">
                    <button class="quantity-btn" onclick="updateQuantity('${item.item_id}', -1)">‚àí</button>
                    <span class="quantity-value">${item.quantity}</span>
                    <button class="quantity-btn" onclick="updateQuantity('${item.item_id}', 1)">+</button>
                </div>
            </div>
        `).join('');

        updateCartTotals();
        document.getElementById('proceed-location-btn').disabled = false;
    }

    function updateQuantity(itemId, change) {
        if (cart[itemId]) {
            cart[itemId].quantity += change;
            if (cart[itemId].quantity <= 0) {
                delete cart[itemId];
            } else {
                cart[itemId].subtotal = cart[itemId].quantity * cart[itemId].unit_price;
            }
            updateCart();
            renderCartItems();
        }
    }

    function updateCartTotals() {
        const subtotal = Object.values(cart).reduce((sum, item) => sum + item.subtotal, 0);
        const deliveryFee = window.deliveryFee || 0;
        const total = subtotal + deliveryFee;

        document.getElementById('cart-subtotal').textContent = `KES ${subtotal.toFixed(2)}`;
        document.getElementById('cart-delivery').textContent = `KES ${deliveryFee.toFixed(2)}`;
        document.getElementById('cart-total').textContent = `KES ${total.toFixed(2)}`;
    }

    // Location Modal Functions
    let map, marker, selectedLocation = null;
    let mapInitialized = false;
    window.deliveryFee = 0;
    window.distanceKm = 0;
    window.estimatedTime = '';

    // Load Google Maps API
    function loadGoogleMaps(callback) {
        if (typeof google !== 'undefined' && google.maps) {
            if (callback) callback();
            return;
        }
        
        if (document.getElementById('google-maps-script')) {
            // Script is loading, wait for it
            const checkInterval = setInterval(() => {
                if (typeof google !== 'undefined' && google.maps) {
                    clearInterval(checkInterval);
                    if (callback) callback();
                }
            }, 100);
            return;
        }
        
        const GOOGLE_API_KEY = 'AIzaSyD8-l6NrR0CbJvADIXdM7KSGOjGvFWjbT0';
        const script = document.createElement('script');
        script.id = 'google-maps-script';
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&libraries=places&loading=async`;
        script.async = true;
        script.defer = true;
        script.onload = function() {
            if (callback) callback();
        };
        document.head.appendChild(script);
    }

    function openLocationModal() {
        if (Object.keys(cart).length === 0) {
            alert('Your cart is empty');
            return;
        }
        openModal('location-modal');
        
        // Load Google Maps API if not already loaded
        loadGoogleMaps(function() {
            initMap();
        });
    }

    function initMap() {
        const shopLat = {% if shop and shop.latitude %}{{ shop.latitude }}{% else %}null{% endif %};
        const shopLng = {% if shop and shop.longitude %}{{ shop.longitude }}{% else %}null{% endif %};
        
        if (!shopLat || !shopLng) {
            document.getElementById('map-container').innerHTML = '<p style="text-align: center; padding: 2rem; color: #64748b;">Shop location not available</p>';
            return;
        }

        // Initialize Google Maps
        const mapDiv = document.getElementById('map-container');
        mapDiv.innerHTML = '<div id="map" style="width: 100%; height: 100%;"></div>';

        if (typeof google !== 'undefined' && google.maps) {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: parseFloat(shopLat), lng: parseFloat(shopLng) },
                zoom: 13,
                mapTypeControl: false,
                streetViewControl: false
            });

            // Shop marker
            new google.maps.Marker({
                position: { lat: parseFloat(shopLat), lng: parseFloat(shopLng) },
                map: map,
                title: '{% if shop %}{{ shop.name }}{% else %}Shop{% endif %}',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
                }
            });

            // Delivery location marker (draggable)
            marker = new google.maps.Marker({
                position: { lat: parseFloat(shopLat), lng: parseFloat(shopLng) },
                map: map,
                draggable: true,
                title: 'Delivery Location',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                }
            });

            marker.addListener('dragend', function() {
                updateLocation(marker.getPosition());
            });

            map.addListener('click', function(e) {
                marker.setPosition(e.latLng);
                updateLocation(e.latLng);
            });

            // Initialize autocomplete for search
            const searchInput = document.getElementById('location-search');
            if (searchInput && google.maps.places) {
                const autocomplete = new google.maps.places.Autocomplete(searchInput);
                autocomplete.bindTo('bounds', map);
                
                autocomplete.addListener('place_changed', function() {
                    const place = autocomplete.getPlace();
                    if (!place.geometry) {
                        return;
                    }
                    
                    if (place.geometry.viewport) {
                        map.fitBounds(place.geometry.viewport);
                    } else {
                        map.setCenter(place.geometry.location);
                        map.setZoom(17);
                    }
                    
                    marker.setPosition(place.geometry.location);
                    updateLocation(place.geometry.location);
                });
            }
            
            mapInitialized = true;
        } else {
            mapDiv.innerHTML = '<p style="text-align: center; padding: 2rem; color: #64748b;">Loading Google Maps...</p>';
        }
    }

    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Load Google Maps if not loaded
                    loadGoogleMaps(function() {
                        if (map && marker) {
                            const location = new google.maps.LatLng(lat, lng);
                            marker.setPosition(location);
                            map.setCenter(location);
                            map.setZoom(15);
                            updateLocation(location);
                        } else {
                            selectedLocation = { lat, lng };
                            calculateDistance();
                        }
                    });
                },
                function(error) {
                    alert('Unable to get your location. Please select manually.');
                }
            );
        } else {
            alert('Geolocation is not supported by your browser.');
        }
    }

    function updateLocation(location) {
        selectedLocation = {
            lat: location.lat(),
            lng: location.lng()
        };
        calculateDistance();
    }

    function calculateDistance() {
        const shopLat = {% if shop and shop.latitude %}{{ shop.latitude }}{% else %}null{% endif %};
        const shopLng = {% if shop and shop.longitude %}{{ shop.longitude }}{% else %}null{% endif %};
        
        if (!selectedLocation || !shopLat || !shopLng) {
            return;
        }

        // Call API to calculate distance
        fetch('/api/distance/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                origin_lat: shopLat,
                origin_lng: shopLng,
                dest_lat: selectedLocation.lat,
                dest_lng: selectedLocation.lng
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                window.distanceKm = data.distance_km;
                window.estimatedTime = data.estimated_time_range;
                
                // Calculate delivery fee (example: KES 50 per km, minimum KES 100)
                window.deliveryFee = Math.max(100, Math.round(data.distance_km * 50));
                
                document.getElementById('delivery-distance').textContent = `${data.distance_km} km`;
                document.getElementById('delivery-time').textContent = `${data.estimated_time_range} mins`;
                document.getElementById('confirm-location-btn').disabled = false;
            }
        })
        .catch(err => {
            console.error('Distance calculation error:', err);
        });
    }

    function confirmLocation() {
        if (!selectedLocation) {
            alert('Please select a delivery location');
            return;
        }
        closeModal('location-modal');
        openSummaryModal();
    }

    // Summary Modal
    function openSummaryModal() {
        const items = Object.values(cart);
        const subtotal = items.reduce((sum, item) => sum + item.subtotal, 0);
        const deliveryFee = window.deliveryFee || 0;
        const total = subtotal + deliveryFee;

        document.getElementById('summary-items').innerHTML = items.map(item => `
            <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e5e7eb;">
                <span>${item.item_name} x${item.quantity}</span>
                <span>KES ${item.subtotal.toFixed(2)}</span>
            </div>
        `).join('');

        document.getElementById('summary-address').textContent = selectedLocation ? 'Location selected' : '-';
        document.getElementById('summary-distance').textContent = `${window.distanceKm} km`;
        document.getElementById('summary-time').textContent = `${window.estimatedTime} mins`;
        document.getElementById('summary-delivery-fee').textContent = `KES ${deliveryFee.toFixed(2)}`;
        document.getElementById('summary-subtotal').textContent = `KES ${subtotal.toFixed(2)}`;
        document.getElementById('summary-delivery-fee-final').textContent = `KES ${deliveryFee.toFixed(2)}`;
        document.getElementById('summary-grand-total').textContent = `KES ${total.toFixed(2)}`;

        openModal('summary-modal');
    }

    // Payment Modal
    let selectedPaymentMethod = null;

    function openPaymentModal() {
        const items = Object.values(cart);
        const subtotal = items.reduce((sum, item) => sum + item.subtotal, 0);
        const deliveryFee = window.deliveryFee || 0;
        const tax = Math.round(subtotal * 0.08); // 8% tax
        const total = subtotal + deliveryFee + tax;

        document.getElementById('payment-subtotal').textContent = `KES ${subtotal.toFixed(2)}`;
        document.getElementById('payment-delivery').textContent = `KES ${deliveryFee.toFixed(2)}`;
        document.getElementById('payment-tax').textContent = `KES ${tax.toFixed(2)}`;
        document.getElementById('payment-total').textContent = `KES ${total.toFixed(2)}`;

        closeModal('summary-modal');
        openModal('payment-modal');
    }

    function selectPaymentMethod(method) {
        selectedPaymentMethod = method;
        document.querySelectorAll('.payment-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        document.querySelector(`[data-method="${method}"]`).classList.add('selected');
    }

    function processPayment() {
        if (!selectedPaymentMethod) {
            alert('Please select a payment method');
            return;
        }

        const items = Object.values(cart);
        const subtotal = items.reduce((sum, item) => sum + item.subtotal, 0);
        const deliveryFee = window.deliveryFee || 0;
        const tax = Math.round(subtotal * 0.08);
        const total = subtotal + deliveryFee + tax;

        const orderData = {
            shop_id: shopId,
            customer_name: 'Guest', // You can add a form to collect this
            customer_phone: '', // You can add a form to collect this
            customer_email: '',
            items: items.map(item => ({
                item_id: item.item_id,
                item_name: item.item_name,
                item_image: item.item_image,
                quantity: item.quantity,
                unit_price: item.unit_price,
                discount_price: null,
                subtotal: item.subtotal
            })),
            subtotal: subtotal,
            delivery_fee: deliveryFee,
            tax: tax,
            discount: 0,
            total: total,
            payment_method: selectedPaymentMethod,
            delivery_address: 'Selected location', // You can get the actual address from reverse geocoding
            delivery_latitude: selectedLocation.lat,
            delivery_longitude: selectedLocation.lng,
            shop_latitude: {% if shop and shop.latitude %}{{ shop.latitude }}{% else %}null{% endif %},
            shop_longitude: {% if shop and shop.longitude %}{{ shop.longitude }}{% else %}null{% endif %},
            distance_km: window.distanceKm,
            estimated_time_minutes: parseInt(window.estimatedTime.split('-')[0]),
            notes: document.getElementById('delivery-notes')?.value || '',
            contactless_delivery: document.getElementById('contactless-delivery')?.checked ? 1 : 0
        };

        // Show loading
        document.getElementById('process-payment-btn').textContent = 'Processing...';
        document.getElementById('process-payment-btn').disabled = true;

        fetch('/api/orders/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Clear cart
                cart = {};
                updateCart();
                
                // Show confirmation
                document.getElementById('confirmation-order-number').textContent = `Order #${data.order_number}`;
                document.getElementById('confirmation-time').textContent = `${window.estimatedTime} mins`;
                document.getElementById('confirmation-total').textContent = `KES ${total.toFixed(2)}`;
                
                closeModal('payment-modal');
                openModal('confirmation-modal');
                
                // Store order number for receipt
                window.lastOrderNumber = data.order_number;
            } else {
                alert('Error creating order: ' + data.message);
                document.getElementById('process-payment-btn').textContent = 'Confirm Payment';
                document.getElementById('process-payment-btn').disabled = false;
            }
        })
        .catch(err => {
            console.error('Order creation error:', err);
            alert('Error creating order. Please try again.');
            document.getElementById('process-payment-btn').textContent = 'Confirm Payment';
            document.getElementById('process-payment-btn').disabled = false;
        });
    }

    function viewReceipt() {
        if (window.lastOrderNumber) {
            window.location.href = `/order/${window.lastOrderNumber}`;
        }
    }

    // Initialize cart UI on page load
    window.addEventListener('DOMContentLoaded', function() {
        updateCartUI();
    });
</script>
{% endblock %}

