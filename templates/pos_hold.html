{% if employee_role == 'admin' or employee_role == 'manager' or employee_role == 'cashier' or employee_role == 'employee' %}
{% extends "role_base.html" %}
{% else %}
{% extends "base.html" %}
{% endif %}

{% block title %}POS-2 - Hold Orders - Hotel POS System{% endblock %}

{% block content %}
<style>
    /* Custom breakpoint for extra small screens (475px+) */
    @media (min-width: 475px) {
        .xs\:inline { display: inline !important; }
        .xs\:hidden { display: none !important; }
        .xs\:w-24 { width: 6rem !important; }
        .xs\:h-20 { height: 5rem !important; }
        .xs\:text-xs { font-size: 0.75rem !important; }
        .xs\:text-\[10px\] { font-size: 10px !important; }
        .xs\:text-lg { font-size: 1.125rem !important; }
    }
    
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }
    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    #categoryTabs {
        scrollbar-width: thin;
    }
    #categoryTabs::-webkit-scrollbar {
        height: 6px;
    }
    #categoryTabs::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    #categoryTabs::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    #categoryTabs::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    /* Horizontal scroll styling for product categories */
    #productsByCategory .flex {
        scrollbar-width: thin;
        scrollbar-color: #888 #f1f1f1;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        scroll-behavior: smooth;
    }
    #productsByCategory .flex::-webkit-scrollbar {
        height: 8px;
    }
    #productsByCategory .flex::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
        margin: 0 2px;
    }
    #productsByCategory .flex::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    #productsByCategory .flex::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    #productsByCategory .flex::-webkit-scrollbar-thumb:active {
        background: #333;
    }
    
    /* Ensure proper width constraints */
    #productsByCategory > div {
        width: 100%;
        max-width: 100%;
        overflow: hidden;
    }
    
    #productsByCategory .flex {
        width: 100%;
        max-width: 100%;
    }
    
    /* Touch optimization */
    .touch-manipulation {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }
    
    /* Prevent text selection on buttons */
    button {
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
    }
    
    /* Responsive font sizes */
    @media (max-width: 640px) {
        html {
            font-size: 14px;
        }
    }
    
    @media (min-width: 1024px) {
        html {
            font-size: 16px;
        }
    }
    
    /* Ensure page fits screen width */
    body {
        overflow-x: hidden;
        max-width: 100vw;
    }
    
    /* Main container constraints */
    .container, main, [role="main"] {
        max-width: 100%;
        overflow-x: hidden;
    }
    
    /* Product category containers */
    #productsByCategory {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }
    
    /* Ensure horizontal scroll containers work properly */
    #productsByCategory .flex {
        min-width: 0; /* Allow flex items to shrink */
        width: 100%;
    }
    
    /* Prevent horizontal page scroll */
    html, body {
        width: 100%;
        overflow-x: hidden;
    }
</style>

<!-- Employee Code Input Modal (shown if not logged in) -->
<div id="employeeCodeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 {% if employee_id %}hidden{% endif %}">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-2xl relative">
                <button id="closeEmployeeCodeModal" class="absolute top-4 right-4 text-white/80 hover:text-white text-2xl transition-colors" title="Close">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="text-xl font-bold pr-8">Validate Employee</h2>
                <p class="text-sm text-blue-100 mt-1">Enter your 4-digit employee code to validate</p>
            </div>
            <div class="p-6">
                <form id="employeeCodeForm" class="space-y-4">
                    <div class="relative">
                        <label class="block text-gray-700 font-semibold mb-2">Employee Code (4 digits)</label>
                        <input type="text" id="employeeCodeInput" name="employee_code" required maxlength="4"
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-primary-orange focus:border-primary-orange text-center text-2xl font-bold tracking-widest transition-all duration-200"
                               placeholder="0000" autofocus autocomplete="off">
                        <p class="text-xs text-gray-500 mt-2 text-center">Enter your 4-digit employee code</p>
                        <div id="employeeCodeError" class="hidden text-red-600 text-sm mt-2 text-center"></div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Printer Setup Modal -->
<div id="printerSetupModal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold">Printer Setup</h2>
                    <button id="closePrinterSetup" class="text-white/80 hover:text-white text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="p-6">
                <!-- Required Printer Connection Warning -->
                <div id="requiredPrinterWarning" class="hidden mb-4 bg-red-50 border-2 border-red-300 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-red-600 mt-1 mr-3 text-xl"></i>
                        <div class="flex-1">
                            <h4 class="font-bold text-red-900 mb-1">Printer Connection Required</h4>
                            <p class="text-sm text-red-800">
                                You must connect a printer before proceeding with the sale or saving the order. 
                                This modal cannot be closed until a printer is successfully connected.
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Printer Type Selection -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">Select Printer Type</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-blue-500 transition-colors">
                            <input type="radio" name="printer-type" value="bluetooth" class="mr-3">
                            <div>
                                <div class="font-medium">Bluetooth Printer</div>
                                <div class="text-sm text-gray-600">Connect via Bluetooth</div>
                            </div>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-blue-500 transition-colors">
                            <input type="radio" name="printer-type" value="wifi" class="mr-3">
                            <div>
                                <div class="font-medium">WiFi Printer</div>
                                <div class="text-sm text-gray-600">Connect via Network</div>
                            </div>
                        </label>
                        <label class="flex items-center p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-blue-500 transition-colors">
                            <input type="radio" name="printer-type" value="usb" class="mr-3">
                            <div>
                                <div class="font-medium">USB Printer</div>
                                <div class="text-sm text-gray-600">Connect via USB (XPrinter, Epson)</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Scan Section -->
                <div id="scanSection" class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold">Scan for Printers</h3>
                        <button id="scan-printers" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-search mr-2"></i>Scan for Printers
                        </button>
                    </div>
                    <div id="printers-list" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- Scanned printers will appear here -->
                    </div>
                </div>

                <!-- Manual Connection Section (WiFi only) -->
                <div id="manualSection" class="mb-6 hidden">
                    <h3 class="text-lg font-semibold mb-4">Manual Connection (WiFi Only)</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Printer Name</label>
                            <input type="text" id="printer-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter printer name">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">IP Address</label>
                            <input type="text" id="printer-ip" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="192.168.1.100">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Port</label>
                            <input type="text" id="printer-port" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="9100" value="9100">
                        </div>
                        <button id="connect-manual-printer" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg transition-colors">
                            <i class="fas fa-link mr-2"></i>Connect
                        </button>
                    </div>
                </div>
                
                <!-- USB Connection Info -->
                <div id="usbInfoSection" class="mb-6 hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-blue-900 mb-2">USB Printer Connection</h4>
                            <p class="text-sm text-blue-800 mb-2">
                                USB printers (XPrinter, Epson, etc.) must be connected via the "Scan for Printers" button.
                            </p>
                            <p class="text-xs text-blue-700">
                                <strong>Requirements:</strong> Chrome, Edge, or Opera browser with WebUSB support. Make sure your USB printer is plugged in before scanning.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Disconnect Section -->
                <div class="border-t pt-4">
                    <button id="disconnect-printer" class="w-full bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg transition-colors">
                        <i class="fas fa-unlink mr-2"></i>Disconnect All Printers
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modern POS Header -->
<div class="relative overflow-hidden bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 rounded-xl sm:rounded-2xl md:rounded-3xl mb-3 sm:mb-4 md:mb-6 lg:mb-8 shadow-2xl mx-2 sm:mx-0">
    <div class="absolute inset-0 bg-black/20"></div>
    <div class="relative px-3 py-4 sm:px-6 sm:py-6 md:px-8 lg:py-12">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between space-y-3 sm:space-y-4 lg:space-y-0">
            <div class="text-white flex-1">
                <h1 class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-bold mb-1 sm:mb-2 bg-gradient-to-r from-white to-blue-200 bg-clip-text text-transparent">
                    POS-2 - Hold Orders
                </h1>
                <p class="text-blue-100 text-sm sm:text-base md:text-lg font-medium">Compile orders for different clients</p>
                <p id="currentEmployeeInfo" class="text-blue-200 text-xs sm:text-sm mt-1 sm:mt-2 {% if not employee_id %}hidden{% endif %}">
                    <i class="fas fa-user mr-1"></i>Logged in as: <span id="currentEmployeeName">{{ employee_name }}</span> (<span id="currentEmployeeCode">{{ employee_code }}</span>)
                </p>
                {% if not employee_id %}
                <button id="showLoginModalBtn" class="mt-3 sm:mt-4 bg-white/20 hover:bg-white/30 active:bg-white/40 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg transition-colors text-xs sm:text-sm font-semibold touch-manipulation">
                    <i class="fas fa-user-check mr-1 sm:mr-2"></i>Validate Employee
                </button>
                {% endif %}
            </div>
            <!-- Printer Control Buttons -->
            <div class="flex items-center justify-center sm:justify-end space-x-2 bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg sm:rounded-xl p-2 mt-2 sm:mt-3 lg:mt-0">
                <button id="printerSetupBtn" class="group bg-gradient-to-r from-blue-500/80 to-purple-500/80 hover:from-blue-500 hover:to-purple-500 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg transition-all duration-300 hover:scale-105 active:scale-95 hover:shadow-lg flex items-center space-x-1 sm:space-x-2 touch-manipulation" title="Printer Setup">
                    <i class="fas fa-print text-xs sm:text-sm group-hover:animate-pulse"></i>
                    <span class="text-xs sm:text-sm font-medium hidden sm:inline">Printer</span>
                </button>
                <button id="returnBtn" class="group bg-gradient-to-r from-orange-500/80 to-red-500/80 hover:from-orange-500 hover:to-red-500 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg transition-all duration-300 hover:scale-105 active:scale-95 hover:shadow-lg flex items-center space-x-1 sm:space-x-2 touch-manipulation" title="Return Item">
                    <i class="fas fa-undo text-xs sm:text-sm group-hover:animate-spin"></i>
                    <span class="text-xs sm:text-sm font-medium hidden sm:inline">Return</span>
                </button>
                <button id="confirmBtn" class="group bg-gradient-to-r from-green-500/80 to-emerald-500/80 hover:from-green-500 hover:to-emerald-500 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg transition-all duration-300 hover:scale-105 active:scale-95 hover:shadow-lg flex items-center space-x-1 sm:space-x-2 touch-manipulation" title="Confirm Action">
                    <i class="fas fa-check-circle text-xs sm:text-sm group-hover:animate-pulse"></i>
                    <span class="text-xs sm:text-sm font-medium hidden sm:inline">Confirm</span>
                </button>
                <div id="printerStatusBadge" class="flex items-center space-x-1 sm:space-x-2 text-white text-[10px] sm:text-xs">
                    <div class="w-2 h-2 sm:w-3 sm:h-3 bg-red-400 rounded-full animate-pulse"></div>
                    <span id="printerStatusText" class="hidden xs:inline">Not Connected</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Cart Icon Button -->
<button id="cartIconBtn" class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-40 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white p-3 sm:p-4 rounded-full shadow-2xl hover:shadow-3xl transition-all duration-300 hover:scale-110 active:scale-95 flex items-center justify-center group touch-manipulation">
    <i class="fas fa-shopping-cart text-xl sm:text-2xl"></i>
    <span id="cartBadge" class="absolute -top-1 -right-1 sm:-top-2 sm:-right-2 bg-red-500 text-white text-[10px] sm:text-xs font-bold rounded-full w-5 h-5 sm:w-6 sm:h-6 flex items-center justify-center hidden">0</span>
</button>

<!-- Floating Withheld Orders Icon Button -->
<button id="withheldOrdersIconBtn" class="fixed bottom-4 right-20 sm:bottom-6 sm:right-24 md:right-28 z-40 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white p-3 sm:p-4 rounded-full shadow-2xl hover:shadow-3xl transition-all duration-300 hover:scale-110 active:scale-95 flex items-center justify-center group touch-manipulation" title="View Withheld Orders">
    <i class="fas fa-clipboard-list text-xl sm:text-2xl"></i>
    <span id="withheldOrdersBadge" class="absolute -top-1 -right-1 sm:-top-2 sm:-right-2 bg-blue-500 text-white text-[10px] sm:text-xs font-bold rounded-full w-5 h-5 sm:w-6 sm:h-6 flex items-center justify-center hidden">0</span>
    <div id="withheldOrdersTooltip" class="absolute bottom-full right-0 mb-2 hidden sm:block opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none">
        <div class="bg-gray-900 text-white text-xs rounded-lg py-1.5 px-3 whitespace-nowrap shadow-lg">
            <div id="withheldOrdersCount" class="font-semibold">0 Orders</div>
            <div id="withheldOrdersTotal" class="text-gray-300">KSh 0.00</div>
        </div>
    </div>
</button>

<!-- Cart Drawer (Slide-out) -->
<div id="cartDrawer" class="fixed inset-y-0 right-0 w-full sm:w-96 md:w-[28rem] lg:w-96 bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out overflow-hidden flex flex-col">
    <!-- Cart Header -->
    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 sm:p-5 md:p-6 flex items-center justify-between flex-shrink-0">
        <div class="flex items-center space-x-2 sm:space-x-3">
            <i class="fas fa-shopping-cart text-xl sm:text-2xl"></i>
            <h2 class="text-lg sm:text-xl font-bold">Cart</h2>
            <span id="cartItemCount" class="bg-white/20 text-white text-xs sm:text-sm px-2 py-1 rounded-full">0</span>
        </div>
        <button id="closeCartBtn" class="text-white/80 hover:text-white active:text-white/60 text-xl sm:text-2xl transition-colors touch-manipulation p-1">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Cart Content -->
    <div class="flex-1 overflow-y-auto p-3 sm:p-4 md:p-6">
        <!-- Table Number Input -->
        <div class="mb-3 sm:mb-4">
            <label class="block text-gray-700 font-semibold mb-1.5 sm:mb-2 text-xs sm:text-sm">
                Table Number <span class="text-red-500">*</span>
            </label>
            <input type="text" id="tableNumberInput" placeholder="Enter table number (required)" maxlength="10" required
                   class="w-full px-3 py-2 sm:py-2.5 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-orange focus:border-primary-orange text-sm"
                   oninput="validateTableNumber()">
            <p id="tableNumberError" class="hidden text-red-600 text-xs mt-1">Table number is required</p>
        </div>

        <!-- Cart Items -->
        <div id="cartItems" class="space-y-2 sm:space-y-3 mb-3 sm:mb-4">
            <p class="text-gray-500 text-center text-xs sm:text-sm py-6 sm:py-8">Cart is empty</p>
        </div>
    </div>

    <!-- Cart Footer (Sticky) -->
    <div class="border-t border-gray-200 bg-gray-50 p-3 sm:p-4 md:p-6 space-y-3 sm:space-y-4 flex-shrink-0">
        <!-- Cart Summary -->
        <div class="space-y-2">
            <div class="flex justify-between text-sm">
                <span class="text-gray-600">Subtotal:</span>
                <span class="font-semibold" id="cartSubtotal">KSh 0.00</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-600">Tax (8%):</span>
                <span class="font-semibold" id="cartTax">KSh 0.00</span>
            </div>
            <div class="flex justify-between text-lg font-bold border-t border-gray-200 pt-2">
                <span>Total:</span>
                <span id="cartTotal" class="text-blue-600">KSh 0.00</span>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="space-y-2">
            <button id="saveToWithheldBtn" class="w-full bg-blue-600 text-white py-2.5 sm:py-3 px-3 sm:px-4 rounded-xl hover:bg-blue-700 active:bg-blue-800 transition-colors duration-200 font-semibold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center text-sm sm:text-base touch-manipulation" disabled>
                <i class="fas fa-save mr-1.5 sm:mr-2 text-sm sm:text-base"></i><span class="hidden xs:inline">Save to Withheld Orders</span><span class="xs:hidden">Save</span>
            </button>
            <button id="printOrderBtn" class="w-full bg-green-600 text-white py-2.5 sm:py-3 px-3 sm:px-4 rounded-xl hover:bg-green-700 active:bg-green-800 transition-colors duration-200 font-semibold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center text-sm sm:text-base touch-manipulation" disabled>
                <i class="fas fa-print mr-1.5 sm:mr-2 text-sm sm:text-base"></i><span class="hidden xs:inline">Print Order Directly</span><span class="xs:hidden">Print</span>
            </button>
            <button id="updateWithheldBtn" class="w-full bg-purple-600 text-white py-2.5 sm:py-3 px-3 sm:px-4 rounded-xl hover:bg-purple-700 active:bg-purple-800 transition-colors duration-200 font-semibold hidden flex items-center justify-center text-sm sm:text-base touch-manipulation">
                <i class="fas fa-edit mr-1.5 sm:mr-2 text-sm sm:text-base"></i><span class="hidden xs:inline">Update Order</span><span class="xs:hidden">Update</span>
            </button>
            <button id="clearCartBtn" class="w-full bg-red-500 text-white py-2 px-3 sm:px-4 rounded-xl hover:bg-red-600 active:bg-red-700 transition-colors duration-200 text-xs sm:text-sm font-medium touch-manipulation">
                <i class="fas fa-trash mr-1.5 sm:mr-2"></i>Clear Cart
            </button>
        </div>
    </div>
</div>

<!-- Cart Overlay (Backdrop) -->
<div id="cartOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity duration-300"></div>

<!-- Employee Validation Modal for QR Scanner -->
<div id="qrEmployeeValidationModal" class="fixed inset-0 bg-black bg-opacity-75 z-[65] hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-2xl">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold">Employee Validation</h2>
                    <p class="text-sm text-blue-100 mt-1">Enter your 4-digit code to access QR scanner</p>
                </div>
                <button id="closeQrValidationModal" class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">
                    Employee Code <span class="text-red-500">*</span>
                </label>
                <input type="text" id="qrEmployeeCodeInput" maxlength="4" 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center text-2xl font-bold tracking-widest"
                       placeholder="0000" autofocus>
                <p class="text-xs text-gray-500 mt-2 text-center">Enter 4-digit employee code</p>
                <div id="qrValidationError" class="hidden text-red-600 text-sm mt-2 text-center"></div>
                <div id="qrValidationInfo" class="hidden bg-green-50 border border-green-200 rounded-lg p-3 mt-2">
                    <p class="text-sm text-green-800"><strong id="qrValidatedEmployeeName"></strong></p>
                    <p class="text-xs text-green-600" id="qrValidatedEmployeeRole"></p>
                </div>
            </div>
            
            <div class="flex space-x-3">
                <button id="validateQrEmployeeBtn" class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-xl hover:bg-blue-700 transition-colors font-semibold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-check mr-2"></i>Validate
                </button>
                <button id="cancelQrValidationBtn" class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-xl hover:bg-gray-300 transition-colors font-semibold">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div id="qrScannerModal" class="fixed inset-0 bg-black bg-opacity-75 z-[70] hidden flex items-center justify-center p-2 sm:p-4">
    <div class="bg-white rounded-2xl sm:rounded-3xl shadow-2xl w-full max-w-3xl max-h-[95vh] overflow-hidden flex flex-col">
        <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 text-white p-4 sm:p-6 rounded-t-2xl sm:rounded-t-3xl">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-xl sm:text-2xl font-bold" id="qrModalTitle">Scan QR Code</h2>
                    <p class="text-xs sm:text-sm text-blue-100 mt-1" id="qrModalSubtitle">Scan receipt QR code</p>
                </div>
                <button id="closeQrScanner" class="text-white hover:text-gray-200 transition-colors p-2 hover:bg-white/10 rounded-lg">
                    <i class="fas fa-times text-xl sm:text-2xl"></i>
                </button>
            </div>
        </div>
        
        <div class="p-4 sm:p-6 flex-1 overflow-y-auto">
            <div id="qrScannerContent">
                <!-- QR Scanner Container with Modern Design -->
                <div class="relative w-full mb-4">
                    <div id="qrScannerContainer" class="relative w-full bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl sm:rounded-2xl overflow-hidden shadow-2xl" style="min-height: 280px; max-height: 400px;">
                        <!-- Video Element -->
                        <video id="qrVideo" class="w-full h-full object-cover" autoplay playsinline muted></video>
                        
                        <!-- Scanning Overlay -->
                        <div id="qrScanningOverlay" class="absolute inset-0 flex items-center justify-center bg-black/30">
                            <div class="text-center text-white">
                                <div class="relative w-64 h-64 sm:w-80 sm:h-80 mx-auto">
                                    <!-- Scanning Frame -->
                                    <div class="absolute inset-0 border-4 border-blue-400 rounded-xl shadow-lg">
                                        <!-- Corner indicators -->
                                        <div class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-blue-400 rounded-tl-xl"></div>
                                        <div class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-blue-400 rounded-tr-xl"></div>
                                        <div class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-blue-400 rounded-bl-xl"></div>
                                        <div class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-blue-400 rounded-br-xl"></div>
                                        
                                        <!-- Scanning line animation -->
                                        <div id="qrScanLine" class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-blue-400 to-transparent animate-pulse"></div>
                                    </div>
                                    
                                    <!-- Scanning indicator -->
                                    <div class="absolute -bottom-12 left-1/2 transform -translate-x-1/2">
                                        <div class="flex items-center space-x-2 text-white">
                                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></div>
                                            <span class="text-sm font-medium">Scanning...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Camera Error Message -->
                        <div id="qrCameraError" class="hidden absolute inset-0 flex items-center justify-center bg-gray-900 text-white p-4">
                            <div class="text-center">
                                <i class="fas fa-camera-slash text-4xl mb-3 text-gray-400"></i>
                                <p class="text-sm font-medium">Camera not available</p>
                                <p class="text-xs text-gray-400 mt-1">Please use manual input below</p>
                            </div>
                        </div>
                        
                        <!-- Canvas for QR detection (hidden) -->
                        <canvas id="qrCanvas" class="hidden"></canvas>
                    </div>
                    
                    <!-- Camera Controls -->
                    <div class="flex items-center justify-center space-x-3 mt-3">
                        <button id="switchCameraBtn" class="hidden px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors text-sm font-medium">
                            <i class="fas fa-sync-alt mr-2"></i>Switch Camera
                        </button>
                        <button id="toggleFlashBtn" class="hidden px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors text-sm font-medium">
                            <i class="fas fa-flash mr-2"></i>Flash
                        </button>
                    </div>
                </div>
                
                <!-- Manual input option with improved design -->
                <div class="mb-4 bg-gray-50 rounded-xl p-4 border-2 border-dashed border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-gray-700 font-semibold text-sm sm:text-base">
                            <i class="fas fa-keyboard mr-2 text-gray-500"></i>Or Enter Manually
                        </label>
                        <button id="toggleManualInput" class="text-xs text-blue-600 hover:text-blue-700 font-medium">
                            <i class="fas fa-chevron-down" id="manualInputIcon"></i>
                        </button>
                    </div>
                    <div id="manualInputSection" class="hidden">
                        <input type="text" id="manualReceiptInput" 
                               class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                               placeholder="Enter receipt URL (e.g., /receipt/123) or ID">
                        <button id="processManualInput" class="mt-2 w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2.5 px-4 rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all font-semibold text-sm sm:text-base shadow-md hover:shadow-lg">
                            <i class="fas fa-search mr-2"></i>Process Receipt
                        </button>
                    </div>
                </div>
                
                <!-- Scanned receipt display -->
                <div id="scannedReceiptDisplay" class="hidden">
                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                        <h3 class="font-bold text-gray-800 mb-2">Receipt Details</h3>
                        <div id="receiptDetails"></div>
                    </div>
                </div>
                
                <!-- Return items selection (for return mode) -->
                <div id="returnItemsSelection" class="hidden">
                    <h3 class="font-bold text-gray-800 mb-3">Select Items to Return</h3>
                    <div id="returnItemsList" class="space-y-2 mb-4"></div>
                    <button id="processReturnBtn" class="w-full bg-orange-600 text-white py-3 px-4 rounded-lg hover:bg-orange-700 transition-colors font-semibold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-undo mr-2"></i>Process Return
                    </button>
                </div>
                
                <!-- Confirm button (for confirm mode) -->
                <div id="confirmReceiptSection" class="hidden">
                    <button id="confirmReceiptBtn" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                        <i class="fas fa-check-circle mr-2"></i>Confirm Receipt
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content (Full Width) -->
<div class="w-full max-w-full overflow-hidden mb-4 sm:mb-6 px-2 sm:px-0">
    <!-- Products Section -->
    <div class="bg-white rounded-xl sm:rounded-2xl shadow-xl p-3 sm:p-4 md:p-6 w-full max-w-full overflow-hidden">
        <!-- Search and Filter Bar -->
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between mb-4 sm:mb-6 gap-3 sm:gap-4">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Products</h2>
            <div class="w-full sm:w-auto flex items-center space-x-2">
                <div class="relative flex-1 sm:flex-initial sm:w-64">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                    <input type="text" id="productSearch" placeholder="Search products..." 
                           class="w-full pl-9 sm:pl-10 pr-3 sm:pr-4 py-2 sm:py-2.5 border-2 border-gray-300 rounded-lg sm:rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-sm sm:text-base">
                </div>
            </div>
        </div>
        
        <!-- Category Tabs -->
        <div id="categoryTabs" class="flex space-x-2 mb-4 sm:mb-6 overflow-x-auto pb-2 scrollbar-hide -mx-3 sm:-mx-0 px-3 sm:px-0">
            <button class="category-tab active bg-gradient-to-r from-blue-600 to-purple-600 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg sm:rounded-xl font-semibold whitespace-nowrap shadow-md hover:shadow-lg transition-all duration-200 hover:scale-105 active:scale-95 text-xs sm:text-sm touch-manipulation" data-category="all">
                All Items
            </button>
            <!-- Categories will be loaded here -->
        </div>
        
        <!-- Products Grid -->
        <div id="productsByCategory" class="space-y-4 sm:space-y-6 md:space-y-8 w-full max-w-full overflow-x-hidden">
            <!-- Products will be loaded here by category -->
        </div>
    </div>
</div>

<!-- Withheld Orders Section -->
<div id="withheldOrdersSection" class="bg-white rounded-xl sm:rounded-2xl shadow-xl p-3 sm:p-4 md:p-6 mb-4 sm:mb-6 px-2 sm:px-0 scroll-mt-4">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-3 sm:mb-4 gap-2 sm:gap-0">
        <div class="flex items-center space-x-3">
            <h2 class="text-lg sm:text-xl font-bold text-gray-800">Withheld Orders</h2>
            <div id="withheldOrdersSummary" class="flex items-center space-x-2 bg-gradient-to-r from-orange-50 to-red-50 border border-orange-200 rounded-lg px-2 sm:px-3 py-1">
                <span class="text-xs sm:text-sm font-semibold text-orange-700">
                    <span id="withheldOrdersCountDisplay">0</span> Orders
                </span>
                <span class="text-xs sm:text-sm font-bold text-orange-600">
                    KSh <span id="withheldOrdersTotalDisplay">0.00</span>
                </span>
            </div>
        </div>
        <button id="refreshWithheldBtn" class="text-blue-600 hover:text-blue-800 active:text-blue-900 text-xs sm:text-sm transition-colors touch-manipulation flex items-center">
            <i class="fas fa-sync-alt mr-1 text-xs sm:text-sm"></i>Refresh
        </button>
    </div>
    <div id="withheldOrdersList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4">
        <!-- Withheld orders will be loaded here -->
    </div>
</div>

<!-- Notification Container -->
<div id="notificationContainer" class="fixed top-2 right-2 sm:top-4 sm:right-4 z-50 space-y-2 max-w-[calc(100vw-1rem)] sm:max-w-sm"></div>

<!-- Manager Approval Modal for Item Return -->
<div id="itemReturnApprovalModal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white p-6 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold">Item Return Approval</h2>
                    <button id="closeItemReturnModal" class="text-white/80 hover:text-white text-2xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="p-6">
                <div class="mb-6">
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mt-1 mr-3"></i>
                            <div>
                                <h4 class="font-semibold text-yellow-900 mb-2">Return Item Request</h4>
                                <p class="text-sm text-yellow-800 mb-2">
                                    <strong>Item:</strong> <span id="returnItemName"></span>
                                </p>
                                <p class="text-sm text-yellow-800 mb-2">
                                    <strong>Current Quantity:</strong> <span id="returnCurrentQuantity"></span>
                                </p>
                                <p class="text-sm text-yellow-800">
                                    <strong>Return Quantity:</strong> <span id="returnQuantity"></span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-sm text-gray-600 mb-4">
                        This action requires approval from a <strong>Cashier</strong>, <strong>Admin</strong>, or <strong>Manager</strong>.
                    </p>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Approver 4-Digit Code</label>
                        <input type="text" id="approverCodeInput" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-center text-2xl tracking-widest" 
                               placeholder="0000" 
                               maxlength="4"
                               pattern="[0-9]{4}">
                        <p class="text-xs text-gray-500 mt-1">Enter the 4-digit code of the approving employee</p>
                    </div>
                    
                    <div id="approverInfo" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-user-check text-blue-600 mr-2"></i>
                            <div>
                                <p class="text-sm font-semibold text-blue-900" id="approverName"></p>
                                <p class="text-xs text-blue-700" id="approverRole"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="approverError" class="hidden bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                            <p class="text-sm text-red-800" id="approverErrorMessage"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="bg-gray-50 px-6 py-4 rounded-b-2xl flex justify-end space-x-3">
                <button id="cancelItemReturnBtn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button id="confirmItemReturnBtn" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-check mr-2"></i>Approve Return
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- jsQR Library for QR Code Scanning -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
    let currentCart = [];
    let currentEmployee = null;
    let allProducts = [];
    let currentEditingOrderId = null;
    let printingSettings = {};
    let includeTax = true; // Default to true, will be loaded from hotel settings

    // Define printer connection functions globally so they're available everywhere
    function savePrinterConnections() {
        // Save Bluetooth printer connections
        if (window.bluetoothPrinterManager) {
            try {
                const bluetoothPrinters = window.bluetoothPrinterManager.getConnectedPrinters();
                if (bluetoothPrinters.length > 0) {
                    const printerData = bluetoothPrinters.map(p => ({
                        id: p.id,
                        name: p.name,
                        type: 'bluetooth'
                    }));
                    localStorage.setItem('saved_bluetooth_printers', JSON.stringify(printerData));
                    console.log('Saved Bluetooth printer connections:', printerData);
                }
            } catch (e) {
                console.warn('Error saving Bluetooth printers:', e);
            }
        }
        
        // Save USB printer connections
        if (window.usbPrinterManager) {
            try {
                window.usbPrinterManager.savePersistedConnections();
            } catch (e) {
                console.warn('Error saving USB printers:', e);
            }
        }
        
        // Save WiFi printer connections
        if (window.wifiPrinterManager) {
            try {
                const wifiPrinters = window.wifiPrinterManager.getConnectedPrinters();
                if (wifiPrinters.length > 0) {
                    const printerData = wifiPrinters.map(p => ({
                        id: p.id,
                        name: p.name,
                        ip: p.ip,
                        port: p.port,
                        type: 'wifi'
                    }));
                    localStorage.setItem('saved_wifi_printers', JSON.stringify(printerData));
                    console.log('Saved WiFi printer connections:', printerData);
                }
            } catch (e) {
                console.warn('Error saving WiFi printers:', e);
            }
        }
    }

    async function restorePrinterConnections() {
        // Restore Bluetooth printer connections
        try {
            const savedBluetooth = localStorage.getItem('saved_bluetooth_printers');
            if (savedBluetooth && window.bluetoothPrinterManager) {
                const printers = JSON.parse(savedBluetooth);
                console.log('Restoring Bluetooth printer connections:', printers);
                // Note: Bluetooth connections may need to be re-established due to browser security
                // The saved state helps maintain awareness of what was connected
            }
        } catch (e) {
            console.warn('Error restoring Bluetooth printers:', e);
        }
        
        // Restore WiFi printer connections - WITH CONNECTIVITY VERIFICATION
        try {
            const savedWiFi = localStorage.getItem('saved_wifi_printers');
            if (savedWiFi && window.wifiPrinterManager) {
                const printers = JSON.parse(savedWiFi);
                console.log('Restoring WiFi printer connections:', printers);
                
                // CRITICAL: Verify connectivity before marking as connected
                for (const printer of printers) {
                    if (printer.ip && printer.port) {
                        try {
                            // Add printer to manager (but don't mark as connected yet)
                            const printerId = window.wifiPrinterManager.addPrinter(
                                printer.name || `WiFi Printer at ${printer.ip}`,
                                printer.ip,
                                printer.port
                            );
                            
                            // CRITICAL: Verify printer is actually reachable before connecting
                            console.log(`Verifying connectivity to ${printer.ip}:${printer.port}...`);
                            const isReachable = await verifyPrinterConnectivity(printer.ip, printer.port);
                            
                            if (isReachable) {
                                // Only connect if printer is actually reachable
                                await window.wifiPrinterManager.connectPrinter(printerId);
                                console.log(`✅ Verified and reconnected to WiFi printer: ${printer.name}`);
                            } else {
                                // Printer not reachable - mark as disconnected
                                const printerObj = window.wifiPrinterManager.connectedPrinters.get(printerId);
                                if (printerObj) {
                                    printerObj.status = 'disconnected';
                                    window.wifiPrinterManager.savePersistedConnections();
                                }
                                console.warn(`❌ Printer ${printer.name} (${printer.ip}:${printer.port}) is not reachable - NOT connecting`);
                            }
                        } catch (e) {
                            console.warn(`Failed to reconnect to ${printer.name}:`, e);
                            // Mark as disconnected if connection fails
                            try {
                                const printerId = window.wifiPrinterManager.findPrinterByAddress(printer.ip, printer.port);
                                if (printerId) {
                                    const printerObj = window.wifiPrinterManager.connectedPrinters.get(printerId);
                                    if (printerObj) {
                                        printerObj.status = 'disconnected';
                                        window.wifiPrinterManager.savePersistedConnections();
                                    }
                                }
                            } catch (err) {
                                // Ignore errors during cleanup
                            }
                        }
                    }
                }
                
                // Update printer status after restoration
                if (window.updatePrinterStatus) {
                    updatePrinterStatus();
                }
            }
        } catch (e) {
            console.warn('Error restoring WiFi printers:', e);
        }
    }
    
    // Verify printer connectivity before connecting
    async function verifyPrinterConnectivity(ip, port) {
        try {
            // Test connection via backend API
            const response = await fetch('/api/test-wifi-printer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ip: ip, port: port })
            });
            
            if (response.ok) {
                const data = await response.json();
                return data.success === true;
            }
            return false;
        } catch (error) {
            console.warn(`Connectivity check failed for ${ip}:${port}:`, error);
            return false;
        }
    }

    // Check if employee is logged in
    document.addEventListener('DOMContentLoaded', function() {
        {% if employee_id %}
        currentEmployee = {
            id: {{ employee_id }},
            name: '{{ employee_name }}',
            code: '{{ employee_code }}'
        };
        {% endif %}

        // Always load products (even when not logged in)
        loadProducts();
        loadPrintingSettings();
        
        // Initialize USB printer manager if available
        if (typeof window.USBPrinterManager !== 'undefined' && !window.usbPrinterManager) {
            window.usbPrinterManager = new window.USBPrinterManager();
            console.log('USB printer manager initialized');
        }
        
        // Restore printer connections on page load
        setTimeout(() => {
            restorePrinterConnections();
            updatePrinterStatus();
        }, 1000); // Wait for printer managers to initialize
        
        // Initialize printer controls
        initializePrinterControls();
        
        // Update printer status periodically
        setInterval(updatePrinterStatus, 2000);
        
        // Clean up unreachable printers periodically (every 5 minutes)
        setInterval(async () => {
            if (window.wifiPrinterManager && typeof window.wifiPrinterManager.cleanupUnreachablePrinters === 'function') {
                await window.wifiPrinterManager.cleanupUnreachablePrinters();
                updatePrinterStatus();
            }
        }, 5 * 60 * 1000); // Every 5 minutes
        
        // Initialize item return modal controls
        initializeItemReturnModal();
        
        // Only load withheld orders and show employee info if logged in
        if (currentEmployee) {
            loadWithheldOrders();
        } else {
            document.getElementById('employeeCodeModal').classList.remove('hidden');
        }
        
        // Cart Drawer Event Listeners
        const cartIconBtn = document.getElementById('cartIconBtn');
        const closeCartBtn = document.getElementById('closeCartBtn');
        const cartOverlay = document.getElementById('cartOverlay');
        
        if (cartIconBtn) {
            cartIconBtn.addEventListener('click', openCartDrawer);
        }
        
        if (closeCartBtn) {
            closeCartBtn.addEventListener('click', closeCartDrawer);
        }
        
        if (cartOverlay) {
            cartOverlay.addEventListener('click', closeCartDrawer);
        }

        // Validate Employee button event listener
        const showLoginBtn = document.getElementById('showLoginModalBtn');
        if (showLoginBtn) {
            showLoginBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Validate Employee button clicked');
                showEmployeeLoginModal();
            });
        }

        // Close modal button
        const closeBtn = document.getElementById('closeEmployeeCodeModal');
        if (closeBtn) {
            closeBtn.addEventListener('click', function() {
                closeEmployeeCodeModal();
            });
        }

        // Close modal when clicking outside
        const modal = document.getElementById('employeeCodeModal');
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEmployeeCodeModal();
                }
            });
        }

        // Employee code input - live validation after 4th digit
        const employeeCodeInput = document.getElementById('employeeCodeInput');
        const employeeCodeContainer = employeeCodeInput.parentElement;
        
        employeeCodeInput.addEventListener('input', function(e) {
            // Only allow digits and limit to 4
            this.value = this.value.replace(/\D/g, '').slice(0, 4);
            
            // Hide error message when typing
            const errorDiv = document.getElementById('employeeCodeError');
            if (errorDiv) {
                errorDiv.classList.add('hidden');
            }
            
            // Remove any previous loading/success indicators
            const existingIndicator = employeeCodeContainer.querySelector('#loadingIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            // Validate when 4 digits entered
            if (this.value.length === 4) {
                // Disable input during validation
                this.disabled = true;
                this.classList.add('opacity-50', 'cursor-not-allowed');
                
                // Add loading indicator
                const loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'loadingIndicator';
                loadingIndicator.className = 'absolute right-3 top-1/2 transform -translate-y-1/2';
                loadingIndicator.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-primary-orange"></div>';
                employeeCodeContainer.classList.add('relative');
                employeeCodeContainer.appendChild(loadingIndicator);
                
                // First validate the code
                validateEmployeeCode(this.value);
            } else {
                // Remove success styling if not 4 digits
                this.classList.remove('border-green-500', 'bg-green-50');
            }
        });

        // Handle paste events
        employeeCodeInput.addEventListener('paste', function(e) {
            setTimeout(() => {
                this.value = this.value.replace(/\D/g, '').slice(0, 4);
                if (this.value.length === 4) {
                    this.dispatchEvent(new Event('input'));
                }
            }, 10);
        });

        // Prevent form submission (we handle it via input event)
        document.getElementById('employeeCodeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (employeeCodeInput.value.length === 4) {
                validateEmployeeCode(employeeCodeInput.value);
            }
        });

        async function validateEmployeeCode(employeeCode) {
            if (employeeCode.length !== 4) {
                const errorDiv = document.getElementById('employeeCodeError');
                if (errorDiv) {
                    errorDiv.textContent = 'Please enter a 4-digit employee code';
                    errorDiv.classList.remove('hidden');
                }
                resetLoginInput();
                return;
            }

            try {
                // First validate the code
                const validateResponse = await fetch('/api/employee/validate-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employee_code: employeeCode })
                });

                const validateData = await validateResponse.json();
                
                // Remove loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                if (validateData.success) {
                    // Code is valid - show success and allow continuation
                    employeeCodeInput.classList.remove('opacity-50', 'cursor-not-allowed');
                    employeeCodeInput.classList.add('border-green-500', 'bg-green-50');
                    
                    // Store validated employee info (not logged in yet)
                    const validatedEmployee = validateData.employee;
                    
                    // Show continue button or auto-proceed
                    showValidationSuccess(validatedEmployee, employeeCode);
                } else {
                    // Invalid code - show error and reset
                    const errorDiv = document.getElementById('employeeCodeError');
                    if (errorDiv) {
                        errorDiv.textContent = validateData.message || 'Invalid employee code';
                        errorDiv.classList.remove('hidden');
                    }
                    resetLoginInput();
                }
            } catch (error) {
                // Remove loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                const errorDiv = document.getElementById('employeeCodeError');
                if (errorDiv) {
                    errorDiv.textContent = 'Connection error. Please try again.';
                    errorDiv.classList.remove('hidden');
                }
                resetLoginInput();
            }
        }

        async function showValidationSuccess(employee, employeeCode) {
            // Log in the employee and create session
            try {
                const response = await fetch('/api/employee/login-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employee_code: employeeCode })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Success - set current employee
                    currentEmployee = data.employee;
                    
                    // Update UI to show logged in employee
                    document.getElementById('employeeCodeModal').classList.add('hidden');
                    document.getElementById('currentEmployeeInfo').classList.remove('hidden');
                    document.getElementById('currentEmployeeName').textContent = currentEmployee.name;
                    document.getElementById('currentEmployeeCode').textContent = currentEmployee.code;
                    
                    // Hide validate employee button
                    const showLoginBtn = document.getElementById('showLoginModalBtn');
                    if (showLoginBtn) {
                        showLoginBtn.classList.add('hidden');
                    }
                    
                    // Load data for logged in employee
                    await loadProducts();
                    await loadWithheldOrders();
                    await loadPrintingSettings();
                    
                    // Restore printer connections after login
                    setTimeout(() => {
                        restorePrinterConnections();
                    }, 500);
                    
                    showNotification(`Welcome, ${currentEmployee.name}!`, 'success');
                } else {
                    // Login failed - show error
                    const employeeCodeInput = document.getElementById('employeeCodeInput');
                    const errorDiv = document.getElementById('employeeCodeError');
                    
                    if (errorDiv) {
                        errorDiv.textContent = data.message || 'Failed to log in';
                        errorDiv.classList.remove('hidden');
                        errorDiv.classList.remove('text-green-600');
                        errorDiv.classList.add('text-red-600');
                    }
                    
                    employeeCodeInput.classList.remove('border-green-500', 'bg-green-50');
                    employeeCodeInput.classList.add('border-red-500', 'bg-red-50');
                    resetLoginInput();
                }
            } catch (error) {
                console.error('Login error:', error);
                const employeeCodeInput = document.getElementById('employeeCodeInput');
                const errorDiv = document.getElementById('employeeCodeError');
                
                if (errorDiv) {
                    errorDiv.textContent = 'Connection error. Please try again.';
                    errorDiv.classList.remove('hidden');
                    errorDiv.classList.remove('text-green-600');
                    errorDiv.classList.add('text-red-600');
                }
                
                employeeCodeInput.classList.remove('border-green-500', 'bg-green-50');
                resetLoginInput();
            }
        }


        function resetLoginInput() {
            const input = document.getElementById('employeeCodeInput');
            input.value = '';
            input.disabled = false;
            input.classList.remove('opacity-50', 'cursor-not-allowed', 'border-green-500', 'bg-green-50');
            
            // Hide continue button
            const continueBtn = document.getElementById('continueToPOS2Btn');
            if (continueBtn) {
                continueBtn.classList.add('hidden');
            }
            
            input.focus();
        }

        function closeEmployeeCodeModal() {
            // Hide the modal
            document.getElementById('employeeCodeModal').classList.add('hidden');
            
            // Reset input
            resetLoginInput();
            
            // Clear any error messages
            const errorDiv = document.getElementById('employeeCodeError');
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.classList.add('hidden');
            }
            
            // Show login button in header if not logged in
            const showLoginBtn = document.getElementById('showLoginModalBtn');
            if (showLoginBtn && !currentEmployee) {
                showLoginBtn.classList.remove('hidden');
            }
        }

        function showEmployeeLoginModal() {
            console.log('showEmployeeLoginModal function called');
            const modal = document.getElementById('employeeCodeModal');
            if (!modal) {
                console.error('Employee code modal not found');
                return;
            }
            
            // Show the validation modal
            modal.classList.remove('hidden');
            console.log('Modal should be visible now');
            
            // Hide validate employee button
            const showLoginBtn = document.getElementById('showLoginModalBtn');
            if (showLoginBtn) {
                showLoginBtn.classList.add('hidden');
            }
            
            // Reset input state
            const input = document.getElementById('employeeCodeInput');
            if (input) {
                input.value = '';
                input.disabled = false;
                input.classList.remove('opacity-50', 'cursor-not-allowed', 'border-green-500', 'bg-green-50', 'border-red-500');
                input.classList.add('border-gray-300');
            }
            
            // Clear any error messages
            const errorDiv = document.getElementById('employeeCodeError');
            if (errorDiv) {
                errorDiv.textContent = '';
                errorDiv.classList.add('hidden');
            }
            
            // Remove any continue buttons
            const continueBtn = document.getElementById('continueToPOS2Btn');
            if (continueBtn) {
                continueBtn.remove();
            }
            
            // Remove any confirmation popups
            const confirmationPopup = document.getElementById('loginConfirmationPopup');
            if (confirmationPopup) {
                confirmationPopup.classList.add('hidden');
            }
            
            // Focus on input
            setTimeout(() => {
                if (input) {
                    input.focus();
                }
            }, 100);
        }
        
        // Make function globally accessible
        window.showEmployeeLoginModal = showEmployeeLoginModal;

        // Cart management
        document.getElementById('clearCartBtn').addEventListener('click', clearCart);
        document.getElementById('saveToWithheldBtn').addEventListener('click', saveToWithheldOrders);
        document.getElementById('printOrderBtn').addEventListener('click', printOrderDirectly);
        document.getElementById('updateWithheldBtn').addEventListener('click', updateWithheldOrder);
        document.getElementById('refreshWithheldBtn').addEventListener('click', loadWithheldOrders);
        document.getElementById('productSearch').addEventListener('input', filterProducts);
        
        // Withheld Orders Icon Button Event Listener
        const withheldOrdersIconBtn = document.getElementById('withheldOrdersIconBtn');
        if (withheldOrdersIconBtn) {
            withheldOrdersIconBtn.addEventListener('click', scrollToWithheldOrders);
        }
        
        // Initialize withheld orders summary on page load
        updateWithheldOrdersSummary(0, 0);
        
        // Load hotel settings to check tax toggle
        loadHotelSettings();
    });

    // Load hotel settings to check if tax is enabled
    async function loadHotelSettings() {
        try {
            const response = await fetch('/api/pos/hotel-settings');
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    includeTax = data.include_tax === true || data.include_tax === 1 || data.include_tax === '1' || 
                                data.include_tax === 'True' || data.include_tax === 'true';
                    console.log('Tax toggle from hotel settings:', includeTax);
                    // Update cart display if cart is already populated
                    if (currentCart.length > 0) {
                        updateCartDisplay();
                    }
                }
            }
        } catch (error) {
            console.error('Error loading hotel settings:', error);
            // Default to true if error
            includeTax = true;
        }
    }

    async function loadProducts() {
        try {
            const response = await fetch('/api/pos/items');
            const data = await response.json();
            if (data.success) {
                allProducts = data.items;
                displayProductsByCategory(allProducts);
                setupCategoryTabs(allProducts);
            }
        } catch (error) {
            showNotification('Failed to load products', 'error');
        }
    }

    function setupCategoryTabs(products) {
        const categories = ['all', ...new Set(products.map(p => p.category || 'Uncategorized'))];
        const tabsContainer = document.getElementById('categoryTabs');
        
        tabsContainer.innerHTML = categories.map(category => `
            <button class="category-tab ${category === 'all' ? 'active bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'} px-4 py-2 rounded-xl font-semibold whitespace-nowrap transition-all duration-200 hover:scale-105" data-category="${category}">
                ${category === 'all' ? 'All Items' : category}
            </button>
        `).join('');

        // Add click handlers
        tabsContainer.querySelectorAll('.category-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                tabsContainer.querySelectorAll('.category-tab').forEach(t => {
                    t.classList.remove('active', 'bg-gradient-to-r', 'from-blue-600', 'to-purple-600', 'text-white', 'shadow-md');
                    t.classList.add('bg-gray-100', 'text-gray-700');
                });
                this.classList.add('active', 'bg-gradient-to-r', 'from-blue-600', 'to-purple-600', 'text-white', 'shadow-md');
                this.classList.remove('bg-gray-100', 'text-gray-700');
                
                const category = this.dataset.category;
                filterByCategory(category);
            });
        });
    }

    function filterByCategory(category) {
        const filtered = category === 'all' 
            ? allProducts 
            : allProducts.filter(p => (p.category || 'Uncategorized') === category);
        displayProductsByCategory(filtered, category);
    }

    function displayProductsByCategory(products, selectedCategory = 'all') {
        const container = document.getElementById('productsByCategory');
        
        if (selectedCategory === 'all') {
            // Group by category
            const grouped = {};
            products.forEach(product => {
                const category = product.category || 'Uncategorized';
                if (!grouped[category]) grouped[category] = [];
                grouped[category].push(product);
            });

            container.innerHTML = Object.keys(grouped).map(category => `
                <div class="mb-4 sm:mb-6 w-full">
                    <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-2 sm:mb-3 flex items-center sticky top-0 bg-white z-10 py-1.5 sm:py-2 px-1 -mx-1 sm:mx-0">
                        <span class="w-0.5 sm:w-1 h-4 sm:h-5 bg-gradient-to-b from-blue-600 to-purple-600 rounded-full mr-1.5 sm:mr-2"></span>
                        ${category}
                    </h3>
                    <div class="flex space-x-2 sm:space-x-3 overflow-x-auto pb-2 sm:pb-3 -mx-2 sm:mx-0 px-2 sm:px-0" style="scrollbar-width: thin; scrollbar-color: #888 #f1f1f1;">
                        ${grouped[category].map(product => `
                            <div class="bg-white rounded-lg shadow-sm hover:shadow-md active:shadow-sm border border-gray-100 overflow-hidden cursor-pointer transform transition-all duration-200 hover:scale-105 active:scale-95 flex-shrink-0 w-20 xs:w-24 sm:w-28 touch-manipulation group" onclick="addToCart(${product.id})">
                                <div class="relative w-20 xs:w-24 sm:w-28 h-16 xs:h-20 sm:h-24 bg-gradient-to-br from-gray-50 to-gray-100 overflow-hidden">
                                    ${product.image_url ? 
                                        `<img src="${product.image_url}" alt="${product.name}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-200">` : 
                                        `<div class="w-full h-full flex items-center justify-center"><i class="fas fa-image text-gray-300 text-base xs:text-lg sm:text-xl"></i></div>`
                                    }
                                </div>
                                <div class="p-1.5 sm:p-2">
                                    <h3 class="font-semibold text-[10px] xs:text-xs text-gray-800 mb-0.5 sm:mb-1 line-clamp-2 min-h-[1.75rem] sm:min-h-[2rem] leading-tight">${product.name}</h3>
                                    <p class="text-blue-600 font-bold text-[10px] xs:text-xs mb-0.5 sm:mb-1">KSh ${parseFloat(product.price).toFixed(2)}</p>
                                    ${product.stock_update_enabled && product.stock !== null ? `
                                        <div class="flex items-center justify-between mt-0.5 sm:mt-1">
                                            <span class="text-[9px] xs:text-[10px] text-gray-500">Stock:</span>
                                            <span class="text-[9px] xs:text-[10px] font-semibold ${product.stock > 10 ? 'text-green-600' : product.stock > 0 ? 'text-yellow-600' : 'text-red-600'}">${product.stock}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        } else {
            // Show single category with horizontal scroll
            container.innerHTML = `
                <div class="w-full max-w-full overflow-hidden">
                    <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-2 sm:mb-3 flex items-center sticky top-0 bg-white z-10 py-1.5 sm:py-2 px-1 -mx-1 sm:mx-0">
                        <span class="w-0.5 sm:w-1 h-4 sm:h-5 bg-gradient-to-b from-blue-600 to-purple-600 rounded-full mr-1.5 sm:mr-2"></span>
                        ${selectedCategory}
                    </h3>
                    <div class="flex space-x-2 sm:space-x-3 overflow-x-auto pb-2 sm:pb-3 -mx-2 sm:mx-0 px-2 sm:px-0" style="scrollbar-width: thin; scrollbar-color: #888 #f1f1f1;">
                        ${products.map(product => `
                            <div class="bg-white rounded-lg shadow-sm hover:shadow-md active:shadow-sm border border-gray-100 overflow-hidden cursor-pointer transform transition-all duration-200 hover:scale-105 active:scale-95 flex-shrink-0 w-20 xs:w-24 sm:w-28 touch-manipulation group" onclick="addToCart(${product.id})">
                                <div class="relative w-20 xs:w-24 sm:w-28 h-16 xs:h-20 sm:h-24 bg-gradient-to-br from-gray-50 to-gray-100 overflow-hidden">
                                    ${product.image_url ? 
                                        `<img src="${product.image_url}" alt="${product.name}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-200">` : 
                                        `<div class="w-full h-full flex items-center justify-center"><i class="fas fa-image text-gray-300 text-base xs:text-lg sm:text-xl"></i></div>`
                                    }
                                </div>
                                <div class="p-1.5 sm:p-2">
                                    <h3 class="font-semibold text-[10px] xs:text-xs text-gray-800 mb-0.5 sm:mb-1 line-clamp-2 min-h-[1.75rem] sm:min-h-[2rem] leading-tight">${product.name}</h3>
                                    <p class="text-blue-600 font-bold text-[10px] xs:text-xs mb-0.5 sm:mb-1">KSh ${parseFloat(product.price).toFixed(2)}</p>
                                    ${product.stock_update_enabled && product.stock !== null ? `
                                        <div class="flex items-center justify-between mt-0.5 sm:mt-1">
                                            <span class="text-[9px] xs:text-[10px] text-gray-500">Stock:</span>
                                            <span class="text-[9px] xs:text-[10px] font-semibold ${product.stock > 10 ? 'text-green-600' : product.stock > 0 ? 'text-yellow-600' : 'text-red-600'}">${product.stock}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
    }

    function filterProducts() {
        const searchTerm = document.getElementById('productSearch').value.toLowerCase();
        if (searchTerm) {
            const filtered = allProducts.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                (p.category && p.category.toLowerCase().includes(searchTerm))
            );
            displayProductsByCategory(filtered);
        } else {
            // Reset to current category
            const activeTab = document.querySelector('.category-tab.active');
            if (activeTab) {
                filterByCategory(activeTab.dataset.category);
            } else {
                displayProductsByCategory(allProducts);
            }
        }
    }

    // Make addToCart globally accessible
    window.addToCart = function(productId) {
        if (!currentEmployee) {
            showNotification('Please login first to add items to cart', 'error');
            // Show login modal
            showEmployeeLoginModal();
            return;
        }

        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        const existingItem = currentCart.find(item => item.id === productId);
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            currentCart.push({
                id: product.id,
                name: product.name,
                price: parseFloat(product.price),
                quantity: 1
            });
        }

        updateCartDisplay();
        
        // Open cart drawer when item is added
        setTimeout(() => {
            openCartDrawer();
        }, 300); // Small delay for smooth animation
    }

    function removeFromCart(productId) {
        // Only allow removal if not editing an order, or if it's a new item
        const item = currentCart.find(item => item.id === productId);
        if (currentEditingOrderId && item && item.originalQuantity !== undefined) {
            // Existing item in order - require approval
            requestItemRemoval(productId, item);
        } else {
            // New item or not editing - allow removal
            currentCart = currentCart.filter(item => item.id !== productId);
            updateCartDisplay();
        }
    }

    function updateQuantity(productId, change, orderItemId = null) {
        const item = currentCart.find(item => item.id === productId);
        if (!item) {
            console.warn('Item not found in cart:', productId);
            return;
        }
        
        // Calculate new quantity
        const newQuantity = item.quantity + change;
        
        // Allow reducing to 0 (which removes the item)
        if (newQuantity <= 0) {
            // Request approval to remove item from cart
            requestCartItemRemoval(productId, item);
            return; // Exit early - removal will happen after approval
        } else {
            // Update quantity normally
            item.quantity = newQuantity;
            updateCartDisplay();
        }
    }

    function showQuantityDecreaseApprovalModal(productId, item, orderItemId) {
        // Create or get approval modal
        let modal = document.getElementById('approvalModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'approvalModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] hidden';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                        <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white p-6 rounded-t-2xl">
                            <h2 class="text-xl font-bold">Approval Required</h2>
                            <p class="text-sm text-orange-100 mt-1">Manager/Admin/Cashier validation needed</p>
                        </div>
                        <div class="p-6">
                            <div id="approvalModalContent">
                                <!-- Content will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        const newQuantity = item.quantity - 1; // Decrease by 1
        const decreaseAmount = 1;
        
        const content = `
            <div class="mb-6">
                <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-orange-500 text-xl mr-3"></i>
                        <div>
                            <p class="font-semibold text-orange-800">Decrease Item Quantity</p>
                            <p class="text-sm text-orange-700">This action requires manager approval</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <p class="font-semibold text-gray-800 mb-2">Item Details:</p>
                    <p class="text-sm text-gray-700"><strong>Name:</strong> ${item.name}</p>
                    <p class="text-sm text-gray-700"><strong>Current Quantity:</strong> ${item.quantity}</p>
                    <p class="text-sm text-gray-700"><strong>New Quantity:</strong> ${newQuantity}</p>
                    <p class="text-sm text-gray-700"><strong>Decrease Amount:</strong> ${decreaseAmount}</p>
                    ${item.originalQuantity ? `<p class="text-sm text-blue-600 mt-2"><i class="fas fa-info-circle mr-1"></i>Original Quantity: ${item.originalQuantity}</p>` : ''}
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">
                        Manager/Admin/Cashier Code <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="approvalCodeInput" maxlength="4" 
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-center text-2xl font-bold tracking-widest"
                           placeholder="0000" autofocus>
                    <p class="text-xs text-gray-500 mt-2 text-center">Enter 4-digit approval code</p>
                    <div id="approvalError" class="hidden text-red-600 text-sm mt-2 text-center"></div>
                </div>
                
                <div class="flex space-x-3">
                    <button id="confirmApprovalBtn" class="flex-1 bg-orange-600 text-white py-3 px-4 rounded-xl hover:bg-orange-700 transition-colors font-semibold">
                        <i class="fas fa-check mr-2"></i>Approve
                    </button>
                    <button id="cancelApprovalBtn" class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-xl hover:bg-gray-300 transition-colors font-semibold">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById('approvalModalContent').innerHTML = content;
        modal.classList.remove('hidden');
        
        const approvalInput = document.getElementById('approvalCodeInput');
        approvalInput.focus();
        
        // Auto-validate on 4th digit
        approvalInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').slice(0, 4);
            document.getElementById('approvalError').classList.add('hidden');
        });
        
        // Confirm button
        document.getElementById('confirmApprovalBtn').onclick = async () => {
            const approvalCode = approvalInput.value;
            if (!approvalCode || approvalCode.length !== 4) {
                document.getElementById('approvalError').textContent = 'Please enter a valid 4-digit code';
                document.getElementById('approvalError').classList.remove('hidden');
                return;
            }
            
            await processQuantityDecrease(productId, item, orderItemId, newQuantity, decreaseAmount, approvalCode);
        };
        
        // Cancel button
        document.getElementById('cancelApprovalBtn').onclick = () => {
            modal.classList.add('hidden');
        };
        
        // Close on outside click
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                modal.classList.add('hidden');
            }
        });
    }


    function showItemRemovalApprovalModal(productId, item) {
        if (!currentEditingOrderId) {
            // Not editing - allow normal removal
            currentCart = currentCart.filter(cartItem => cartItem.id !== productId);
            updateCartDisplay();
            return;
        }
        
        // Create or get approval modal
        let modal = document.getElementById('approvalModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'approvalModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] hidden';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                        <div class="bg-gradient-to-r from-red-600 to-pink-600 text-white p-6 rounded-t-2xl">
                            <h2 class="text-xl font-bold">Approval Required</h2>
                            <p class="text-sm text-red-100 mt-1">Manager/Admin/Cashier validation needed</p>
                        </div>
                        <div class="p-6">
                            <div id="approvalModalContent">
                                <!-- Content will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        const content = `
            <div class="mb-6">
                <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-500 text-xl mr-3"></i>
                        <div>
                            <p class="font-semibold text-red-800">Remove Item from Order</p>
                            <p class="text-sm text-red-700">This action requires manager approval</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <p class="font-semibold text-gray-800 mb-2">Item Details:</p>
                    <p class="text-sm text-gray-700"><strong>Name:</strong> ${item.name}</p>
                    <p class="text-sm text-gray-700"><strong>Quantity:</strong> ${item.quantity}</p>
                    <p class="text-sm text-gray-700"><strong>Unit Price:</strong> KSh ${item.price.toFixed(2)}</p>
                    <p class="text-sm text-gray-700"><strong>Total:</strong> KSh ${(item.price * item.quantity).toFixed(2)}</p>
                    <p class="text-sm text-red-600 mt-2 font-semibold">⚠️ This item will be restocked if stock update is enabled</p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">
                        Manager/Admin/Cashier Code <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="approvalCodeInput" maxlength="4" 
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 text-center text-2xl font-bold tracking-widest"
                           placeholder="0000" autofocus>
                    <p class="text-xs text-gray-500 mt-2 text-center">Enter 4-digit approval code</p>
                    <div id="approvalError" class="hidden text-red-600 text-sm mt-2 text-center"></div>
                </div>
                
                <div class="flex space-x-3">
                    <button id="confirmApprovalBtn" class="flex-1 bg-red-600 text-white py-3 px-4 rounded-xl hover:bg-red-700 transition-colors font-semibold">
                        <i class="fas fa-trash mr-2"></i>Remove Item
                    </button>
                    <button id="cancelApprovalBtn" class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-xl hover:bg-gray-300 transition-colors font-semibold">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById('approvalModalContent').innerHTML = content;
        modal.classList.remove('hidden');
        
        const approvalInput = document.getElementById('approvalCodeInput');
        approvalInput.focus();
        
        // Auto-validate on 4th digit
        approvalInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').slice(0, 4);
            document.getElementById('approvalError').classList.add('hidden');
        });
        
        // Confirm button
        document.getElementById('confirmApprovalBtn').onclick = async () => {
            const approvalCode = approvalInput.value;
            if (!approvalCode || approvalCode.length !== 4) {
                document.getElementById('approvalError').textContent = 'Please enter a valid 4-digit code';
                document.getElementById('approvalError').classList.remove('hidden');
                return;
            }
            
            await processItemRemoval(productId, item, approvalCode);
        };
        
        // Cancel button
        document.getElementById('cancelApprovalBtn').onclick = () => {
            modal.classList.add('hidden');
        };
        
        // Close on outside click
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                modal.classList.add('hidden');
            }
        });
    }
    
    function requestCartItemRemoval(productId, item) {
        // Create or get approval modal
        let modal = document.getElementById('approvalModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'approvalModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] hidden';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                        <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white p-6 rounded-t-2xl">
                            <h2 class="text-xl font-bold">Approval Required</h2>
                            <p class="text-sm text-orange-100 mt-1">Manager/Admin/Cashier validation needed</p>
                        </div>
                        <div class="p-6">
                            <div id="approvalModalContent">
                                <!-- Content will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        const content = `
            <div class="mb-6">
                <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-orange-600 text-2xl mr-3"></i>
                        <div>
                            <p class="font-semibold text-orange-800">Remove Item from Cart</p>
                            <p class="text-sm text-orange-700">This action requires manager approval</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <p class="font-semibold text-gray-800 mb-2">Item Details:</p>
                    <p class="text-sm text-gray-700"><strong>Name:</strong> ${item.name}</p>
                    <p class="text-sm text-gray-700"><strong>Quantity:</strong> ${item.quantity}</p>
                    <p class="text-sm text-gray-700"><strong>Unit Price:</strong> KSh ${item.price.toFixed(2)}</p>
                    <p class="text-sm text-gray-700"><strong>Total:</strong> KSh ${(item.price * item.quantity).toFixed(2)}</p>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">
                        Manager/Admin/Cashier Code <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="approvalCodeInput" maxlength="4" 
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-center text-2xl font-bold tracking-widest"
                           placeholder="0000" autofocus>
                    <p class="text-xs text-gray-500 mt-2 text-center">Enter 4-digit approval code</p>
                    <div id="approverInfo" class="hidden bg-green-50 border border-green-200 rounded-lg p-3 mt-2">
                        <p class="text-sm text-green-800"><strong id="approverName"></strong></p>
                        <p class="text-xs text-green-600" id="approverRole"></p>
                    </div>
                    <div id="approvalError" class="hidden text-red-600 text-sm mt-2 text-center"></div>
                    <p id="approvalErrorMessage" class="text-xs text-red-600 mt-1"></p>
                </div>
                
                <div class="flex space-x-3">
                    <button id="confirmApprovalBtn" class="flex-1 bg-orange-600 text-white py-3 px-4 rounded-xl hover:bg-orange-700 transition-colors font-semibold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-trash mr-2"></i>Remove Item
                    </button>
                    <button id="cancelApprovalBtn" class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-xl hover:bg-gray-300 transition-colors font-semibold">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </div>
        `;
        
        document.getElementById('approvalModalContent').innerHTML = content;
        modal.classList.remove('hidden');
        
        const approvalInput = document.getElementById('approvalCodeInput');
        approvalInput.focus();
        
        // Live validation on input
        approvalInput.addEventListener('input', async function() {
            this.value = this.value.replace(/\D/g, '').slice(0, 4);
            document.getElementById('approvalError').classList.add('hidden');
            document.getElementById('approverInfo').classList.add('hidden');
            document.getElementById('confirmApprovalBtn').disabled = true;
            
            if (this.value.length === 4) {
                const validation = await validateApproverCodeForCartRemoval();
                if (validation.valid) {
                    // Auto-approve and remove item
                    await processCartItemRemoval(productId, item, this.value);
                }
            }
        });
        
        // Confirm button (backup if auto-approval doesn't work)
        document.getElementById('confirmApprovalBtn').onclick = async () => {
            const approvalCode = approvalInput.value;
            if (!approvalCode || approvalCode.length !== 4) {
                document.getElementById('approvalError').classList.remove('hidden');
                document.getElementById('approvalErrorMessage').textContent = 'Please enter a valid 4-digit code';
                return;
            }
            
            await processCartItemRemoval(productId, item, approvalCode);
        };
        
        // Cancel button
        document.getElementById('cancelApprovalBtn').onclick = () => {
            modal.classList.add('hidden');
        };
        
        // Close on outside click
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                modal.classList.add('hidden');
            }
        });
    }
    
    async function validateApproverCodeForCartRemoval() {
        const codeInput = document.getElementById('approvalCodeInput');
        const code = codeInput?.value.trim();
        
        if (!code || code.length !== 4 || !/^\d{4}$/.test(code)) {
            return { valid: false };
        }
        
        try {
            const response = await fetch('/employee/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ employee_code: code })
            });
            
            const data = await response.json();
            
            if (data.success && data.employee) {
                const employee = data.employee;
                const validRoles = ['cashier', 'admin', 'manager'];
                
                if (validRoles.includes(employee.role.toLowerCase())) {
                    // Show approver info
                    const infoDiv = document.getElementById('approverInfo');
                    const nameEl = document.getElementById('approverName');
                    const roleEl = document.getElementById('approverRole');
                    
                    if (infoDiv) infoDiv.classList.remove('hidden');
                    if (nameEl) nameEl.textContent = employee.name;
                    if (roleEl) roleEl.textContent = `Role: ${employee.role.charAt(0).toUpperCase() + employee.role.slice(1)}`;
                    
                    // Hide error
                    document.getElementById('approvalError')?.classList.add('hidden');
                    
                    // Enable confirm button
                    document.getElementById('confirmApprovalBtn').disabled = false;
                    
                    return { valid: true, employee: employee };
                } else {
                    // Show error - invalid role
                    const errorDiv = document.getElementById('approvalError');
                    const errorMsg = document.getElementById('approvalErrorMessage');
                    
                    if (errorDiv) errorDiv.classList.remove('hidden');
                    if (errorMsg) errorMsg.textContent = `Employee role "${employee.role}" is not authorized. Only Cashier, Admin, or Manager can approve.`;
                    
                    document.getElementById('approverInfo')?.classList.add('hidden');
                    document.getElementById('confirmApprovalBtn').disabled = true;
                    
                    return { valid: false, message: 'Invalid role' };
                }
            } else {
                // Show error - invalid code
                const errorDiv = document.getElementById('approvalError');
                const errorMsg = document.getElementById('approvalErrorMessage');
                
                if (errorDiv) errorDiv.classList.remove('hidden');
                if (errorMsg) errorMsg.textContent = data.message || 'Invalid employee code';
                
                document.getElementById('approverInfo')?.classList.add('hidden');
                document.getElementById('confirmApprovalBtn').disabled = true;
                
                return { valid: false, message: data.message || 'Invalid code' };
            }
        } catch (error) {
            console.error('Error validating approver code:', error);
            return { valid: false, message: 'Error validating code' };
        }
    }
    
    async function processCartItemRemoval(productId, item, approvalCode) {
        const modal = document.getElementById('approvalModal');
        const confirmBtn = document.getElementById('confirmApprovalBtn');
        const approvalInput = document.getElementById('approvalCodeInput');
        
        // Disable button during processing
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        
        // Validate approver first
        const validation = await validateApproverCodeForCartRemoval();
        if (!validation.valid) {
            document.getElementById('approvalError').classList.remove('hidden');
            document.getElementById('approvalErrorMessage').textContent = validation.message || 'Invalid approval code';
            approvalInput.value = '';
            approvalInput.focus();
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-trash mr-2"></i>Remove Item';
            return;
        }
        
        try {
            // Remove item from cart
            const itemIndex = currentCart.findIndex(cartItem => cartItem.id !== productId);
            if (itemIndex !== -1) {
                currentCart.splice(itemIndex, 1);
            }
            
            // Update cart display
            updateCartDisplay();
            
            // Close modal
            modal.classList.add('hidden');
            
            // Show success notification
            showNotification('Item removed from cart with approval', 'success');
        } catch (error) {
            document.getElementById('approvalError').classList.remove('hidden');
            document.getElementById('approvalErrorMessage').textContent = 'Error processing request. Please try again.';
            approvalInput.focus();
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-trash mr-2"></i>Remove Item';
        }
    }

    async function processItemRemoval(productId, item, approvalCode) {
        const modal = document.getElementById('approvalModal');
        const confirmBtn = document.getElementById('confirmApprovalBtn');
        const approvalInput = document.getElementById('approvalCodeInput');
        
        // Disable button during processing
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        
        try {
            const response = await fetch(`/api/withheld-orders/${currentEditingOrderId}/remove-item`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    order_item_id: item.orderItemId,
                    item_id: productId,
                    quantity: item.quantity,
                    approval_code: approvalCode
                })
            });
            
            const data = await response.json();
            if (data.success) {
                modal.classList.add('hidden');
                // Reload order to get updated data
                await editWithheldOrder(currentEditingOrderId);
                showNotification('Item removed successfully and restocked!', 'success');
                
                // Logout employee after removing item (printer connections will be saved and restored by logoutEmployee)
                setTimeout(() => {
                    logoutEmployee();
                }, 300);
            } else {
                document.getElementById('approvalError').textContent = data.message || 'Invalid approval code';
                document.getElementById('approvalError').classList.remove('hidden');
                approvalInput.value = '';
                approvalInput.focus();
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-trash mr-2"></i>Remove Item';
            }
        } catch (error) {
            document.getElementById('approvalError').textContent = 'Error processing request. Please try again.';
            document.getElementById('approvalError').classList.remove('hidden');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-trash mr-2"></i>Remove Item';
        }
    }

    function clearCart() {
        currentCart = [];
        currentEditingOrderId = null;
        document.getElementById('updateWithheldBtn').classList.add('hidden');
        document.getElementById('saveToWithheldBtn').classList.remove('hidden');
        document.getElementById('printOrderBtn').classList.remove('hidden');
        // Update button states based on printer connection and cart
        updatePrinterStatus();
        document.getElementById('tableNumberInput').value = '';
        // Clear table number validation
        document.getElementById('tableNumberError').classList.add('hidden');
        document.getElementById('tableNumberInput').classList.remove('border-red-500');
        updateCartDisplay();
    }

    function validateTableNumber() {
        const tableNumber = document.getElementById('tableNumberInput').value.trim();
        const errorDiv = document.getElementById('tableNumberError');
        const input = document.getElementById('tableNumberInput');
        
        if (tableNumber) {
            errorDiv.classList.add('hidden');
            input.classList.remove('border-red-500');
            input.classList.add('border-gray-300');
        } else {
            // Don't show error while typing, only on submit
            input.classList.remove('border-red-500');
        }
    }

    function updateCartDisplay() {
        const cartItemsDiv = document.getElementById('cartItems');
        const cartBadge = document.getElementById('cartBadge');
        const cartItemCount = document.getElementById('cartItemCount');
        const totalItems = currentCart.reduce((sum, item) => sum + item.quantity, 0);
        
        // Update cart badge
        if (totalItems > 0) {
            cartBadge.textContent = totalItems;
            cartBadge.classList.remove('hidden');
            cartItemCount.textContent = totalItems;
        } else {
            cartBadge.classList.add('hidden');
            cartItemCount.textContent = '0';
        }
        
        if (currentCart.length === 0) {
            cartItemsDiv.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-shopping-cart text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 text-sm font-medium">Cart is empty</p>
                    <p class="text-gray-400 text-xs mt-1">Add items to get started</p>
                </div>
            `;
            document.getElementById('saveToWithheldBtn').disabled = true;
            document.getElementById('printOrderBtn').disabled = true;
        } else {
            // Check if editing a withheld order
            const isEditingOrder = currentEditingOrderId !== null;
            
            cartItemsDiv.innerHTML = currentCart.map(item => {
                // Check if this item exists in the original order (for editing)
                const isExistingItem = isEditingOrder && item.originalQuantity !== undefined;
                const itemTotal = item.price * item.quantity;
                
                return `
                <div class="bg-white border border-gray-200 rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800 text-sm mb-1">${item.name}</h4>
                            <p class="text-xs text-gray-500">KSh ${item.price.toFixed(2)} each</p>
                            ${isExistingItem ? `
                                <div class="mt-2 flex items-center text-xs text-blue-600">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <span>Original: ${item.originalQuantity}</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-blue-600 text-sm">KSh ${itemTotal.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                        <span class="text-xs text-gray-500">Quantity</span>
                        <div class="flex items-center space-x-3">
                            <button onclick="updateQuantity(${item.id}, -1)" 
                                    class="bg-gray-100 hover:bg-gray-200 active:bg-gray-300 w-8 h-8 rounded-lg flex items-center justify-center text-gray-700 font-semibold transition-colors" 
                                    title="Decrease quantity">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <span class="font-bold text-gray-800 w-8 text-center">${item.quantity}</span>
                            <button onclick="updateQuantity(${item.id}, 1)" 
                                    class="bg-blue-500 hover:bg-blue-600 active:bg-blue-700 w-8 h-8 rounded-lg flex items-center justify-center text-white font-semibold transition-colors">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            const subtotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = includeTax ? subtotal * 0.08 : 0;
            const total = subtotal + tax;

            document.getElementById('cartSubtotal').textContent = `KSh ${subtotal.toFixed(2)}`;
            // Show/hide tax row based on includeTax setting
            const taxRow = document.querySelector('#cartTax').closest('.flex');
            if (taxRow) {
                taxRow.style.display = includeTax ? 'flex' : 'none';
            }
            document.getElementById('cartTax').textContent = `KSh ${tax.toFixed(2)}`;
            document.getElementById('cartTotal').textContent = `KSh ${total.toFixed(2)}`;
            
            // CRITICAL: Update button states based on printer connection and cart contents
            updatePrinterStatus();
        }
    }
    
    // Cart Drawer Functions
    function openCartDrawer() {
        const drawer = document.getElementById('cartDrawer');
        const overlay = document.getElementById('cartOverlay');
        drawer.classList.remove('translate-x-full');
        overlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
    
    function closeCartDrawer() {
        const drawer = document.getElementById('cartDrawer');
        const overlay = document.getElementById('cartOverlay');
        drawer.classList.add('translate-x-full');
        overlay.classList.add('hidden');
        document.body.style.overflow = ''; // Restore scrolling
    }

    async function saveToWithheldOrders() {
        // CRITICAL: Check printer connection FIRST - BLOCK if not connected
        if (!isPrinterConnected()) {
            console.log('❌ PRINTER NOT CONNECTED - BLOCKING ACTION');
            showPrinterSetupModal(true); // Show modal in required mode (non-dismissible)
            showNotification('⚠️ Printer Required: Please connect a printer first to save orders', 'warning');
            return; // STOP - DO NOT PROCEED
        }
        
        // Validate other requirements
        if (!currentEmployee || currentCart.length === 0) {
            showNotification('Please add items to cart', 'error');
            return;
        }

        const tableNumber = document.getElementById('tableNumberInput').value.trim();
        
        // Validate table number is required
        if (!tableNumber) {
            document.getElementById('tableNumberError').classList.remove('hidden');
            document.getElementById('tableNumberInput').classList.add('border-red-500');
            document.getElementById('tableNumberInput').focus();
            showNotification('Table number is required', 'error');
            return;
        }

        // Clear error if table number is valid
        document.getElementById('tableNumberError').classList.add('hidden');
        document.getElementById('tableNumberInput').classList.remove('border-red-500');

        // CRITICAL: Final check right before API call - do not proceed if no printer
        if (!isPrinterConnected()) {
            console.log('❌ PRINTER CHECK FAILED RIGHT BEFORE API CALL - BLOCKING SAVE');
            showPrinterSetupModal(true);
            showNotification('❌ Printer connection lost. Please reconnect before saving.', 'error');
            return; // STOP - DO NOT PROCEED
        }

        try {
            // Save printer connections before saving order
            savePrinterConnections();
            
            const response = await fetch('/api/withheld-orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    items: currentCart,
                    table_number: tableNumber
                })
            });

            const data = await response.json();
            if (data.success) {
                showNotification('Order saved to withheld orders!', 'success');
                
                // Print unpaid receipt showing only the new items
                const itemsToPrint = currentCart.map(item => ({
                    item_name: item.name,
                    name: item.name,
                    quantity: item.quantity,
                    unit_price: item.price,
                    price: item.price
                }));
                await printUnpaidReceipt(data.order, itemsToPrint);
                
                clearCart();
                await loadWithheldOrders();
                
                // Logout employee after saving (printer connections will be saved and restored by logoutEmployee)
                setTimeout(() => {
                    logoutEmployee();
                }, 300);
            } else {
                showNotification(data.message || 'Failed to save order', 'error');
            }
        } catch (error) {
            showNotification('Error saving order', 'error');
        }
    }

    async function printOrderDirectly() {
        // CRITICAL: Check printer connection FIRST - BLOCK if not connected
        if (!isPrinterConnected()) {
            console.log('❌ PRINTER NOT CONNECTED - BLOCKING ACTION');
            showPrinterSetupModal(true); // Show modal in required mode (non-dismissible)
            showNotification('⚠️ Printer Required: Please connect a printer first to print orders', 'warning');
            return; // STOP - DO NOT PROCEED
        }
        
        // Validate other requirements
        if (!currentEmployee || currentCart.length === 0) {
            showNotification('Please add items to cart', 'error');
            return;
        }
        
        // Save printer connections before printing
        savePrinterConnections();

        const tableNumber = document.getElementById('tableNumberInput').value.trim();
        
        // Validate table number is required
        if (!tableNumber) {
            document.getElementById('tableNumberError').classList.remove('hidden');
            document.getElementById('tableNumberInput').classList.add('border-red-500');
            document.getElementById('tableNumberInput').focus();
            showNotification('Table number is required', 'error');
            return;
        }

        // Clear error if table number is valid
        document.getElementById('tableNumberError').classList.add('hidden');
        document.getElementById('tableNumberInput').classList.remove('border-red-500');

        // FINAL CHECK: Verify printer is still connected before API call
        if (!isPrinterConnected()) {
            console.log('❌ PRINTER DISCONNECTED BEFORE PRINT - BLOCKING');
            showPrinterSetupModal(true); // Show modal in required mode (non-dismissible)
            showNotification('❌ Printer disconnected. Please reconnect and try again.', 'error');
            return; // STOP - DO NOT PROCEED
        }

        // CRITICAL: Final check right before API call - do not proceed if no printer
        if (!isPrinterConnected()) {
            console.log('❌ PRINTER CHECK FAILED RIGHT BEFORE API CALL - BLOCKING PRINT');
            showPrinterSetupModal(true);
            showNotification('❌ Printer connection lost. Please reconnect before completing sale.', 'error');
            return; // STOP - DO NOT PROCEED
        }

        try {
            
            // Calculate totals
            const subtotal = currentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const taxAmount = includeTax ? subtotal * 0.08 : 0; // 8% tax if enabled
            const totalAmount = subtotal + taxAmount;
            
            // Prepare items for sale
            const saleItems = currentCart.map(item => ({
                id: item.id,
                name: item.name,
                quantity: item.quantity,
                price: item.price
            }));
            
            // Complete the sale directly (no withheld order)
            const saleResponse = await fetch('/api/pos/process-sale', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    items: saleItems,
                    subtotal: subtotal,
                    tax_amount: taxAmount,
                    total_amount: totalAmount,
                    tax_included: true,
                    sale_type: 'sale',
                    table_number: tableNumber
                })
            });

            const saleData = await saleResponse.json();
            if (saleData.success) {
                showNotification('Sale completed and receipt printed!', 'success');
                
                // Print complete receipt for the sale
                if (saleData.sale) {
                    await printCompleteReceipt(saleData.sale);
                } else {
                    // Fallback: create sale object from response
                    const sale = {
                        receipt_number: saleData.receipt_number,
                        employee_name: currentEmployee.name,
                        subtotal: subtotal,
                        tax_amount: taxAmount,
                        total_amount: totalAmount,
                        sale_date: new Date().toISOString(),
                        items: saleItems.map(item => ({
                            item_name: item.name,
                            name: item.name,
                            quantity: item.quantity,
                            unit_price: item.price,
                            price: item.price
                        }))
                    };
                    await printCompleteReceipt(sale);
                }
                
                clearCart();
                
                // Logout employee after printing (printer connections will be saved and restored by logoutEmployee)
                setTimeout(() => {
                    logoutEmployee();
                }, 300);
            } else {
                showNotification(saleData.message || 'Failed to complete sale', 'error');
            }
        } catch (error) {
            console.error('Error processing sale:', error);
            showNotification('Error processing sale: ' + (error.message || 'Unknown error'), 'error');
        }
    }

    async function updateWithheldOrder() {
        // Validate printer connection
        if (!isPrinterConnected()) {
            showNotification('Please connect a printer first before updating orders', 'error');
            return;
        }
        
        if (!currentEditingOrderId || currentCart.length === 0) {
            showNotification('Please select an order to update', 'error');
            return;
        }

        const tableNumber = document.getElementById('tableNumberInput').value.trim() || 'No Table';

        try {
            // Get original order to compare items and check for quantity decreases
            let originalOrder = null;
            try {
                const orderResponse = await fetch(`/api/withheld-orders/${currentEditingOrderId}`);
                const orderData = await orderResponse.json();
                if (orderData.success) {
                    originalOrder = orderData.order;
                }
            } catch (e) {
                console.warn('Error fetching original order:', e);
            }
            
            // Check if any quantities were decreased - requires approval
            const originalItems = originalOrder?.items || [];
            const originalItemsMap = new Map(originalItems.map(item => [item.item_id || item.id, {
                quantity: item.quantity,
                name: item.item_name || item.name,
                orderItemId: item.id
            }]));
            
            const decreasedItems = [];
            currentCart.forEach(item => {
                const originalItem = originalItemsMap.get(item.id);
                if (originalItem && item.quantity < originalItem.quantity) {
                    decreasedItems.push({
                        item_id: item.id,
                        item_name: item.name,
                        original_quantity: originalItem.quantity,
                        new_quantity: item.quantity,
                        decrease_amount: originalItem.quantity - item.quantity,
                        order_item_id: originalItem.orderItemId
                    });
                }
            });
            
            // If quantities were decreased, require approval
            if (decreasedItems.length > 0) {
                showQuantityDecreaseApprovalModalForUpdate(decreasedItems, tableNumber, originalOrder);
                return;
            }
            
            // No decreases - proceed with update
            await proceedWithOrderUpdate(tableNumber, originalOrder);
            
        } catch (error) {
            console.error('Error updating order:', error);
            showNotification('Error updating order: ' + (error.message || 'Unknown error'), 'error');
        }
    }
    
    async function proceedWithOrderUpdate(tableNumber, originalOrder) {
        try {
            // Save printer connections before updating order
            savePrinterConnections();
            
            const response = await fetch(`/api/withheld-orders/${currentEditingOrderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    table_number: tableNumber,
                    items: currentCart.map(item => ({
                        item_id: item.id,
                        quantity: item.quantity,
                        unit_price: item.price,
                        total_price: item.price * item.quantity
                    }))
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}: ${response.statusText}` }));
                showNotification(errorData.message || 'Failed to update order', 'error');
                console.error('Update order error:', errorData);
                return;
            }

            const data = await response.json();
            if (data.success) {
                showNotification('Order updated!', 'success');
                
                // Find only NEW items (not in original) or items with INCREASED quantities
                // Only print the difference for increased quantities, not the full quantity
                const originalItems = originalOrder?.items || [];
                const originalItemsMap = new Map(originalItems.map(item => [item.item_id || item.id, item.quantity]));
                
                const itemsToPrint = [];
                currentCart.forEach(item => {
                    const originalQty = originalItemsMap.get(item.id) || 0;
                    const newQty = item.quantity;
                    
                    if (originalQty === 0) {
                        // Item is completely new - print full quantity
                        itemsToPrint.push({
                            item_name: item.name,
                            name: item.name,
                            quantity: newQty,
                            unit_price: item.price,
                            price: item.price
                        });
                    } else if (newQty > originalQty) {
                        // Quantity increased - only print the difference (added amount)
                        const addedQty = newQty - originalQty;
                        itemsToPrint.push({
                            item_name: item.name,
                            name: item.name,
                            quantity: addedQty, // Only the added quantity
                            unit_price: item.price,
                            price: item.price
                        });
                    }
                    // If quantity decreased or stayed the same, don't print (already printed before)
                });
                
                // Print unpaid receipt showing only newly added items
                if (itemsToPrint.length > 0) {
                    await printUnpaidReceipt(data.order, itemsToPrint);
                }
                
                clearCart();
                await loadWithheldOrders();
                
                // Logout employee after updating (printer connections will be saved and restored by logoutEmployee)
                setTimeout(() => {
                    logoutEmployee();
                }, 300);
            } else {
                showNotification(data.message || 'Failed to update order', 'error');
                console.error('Update order failed:', data);
            }
        } catch (error) {
            console.error('Error updating order:', error);
            showNotification('Error updating order: ' + (error.message || 'Unknown error'), 'error');
        }
    }

    async function loadWithheldOrders() {
        if (!currentEmployee) return;

        try {
            const response = await fetch('/api/withheld-orders');
            const data = await response.json();
            if (data.success) {
                displayWithheldOrders(data.orders);
            }
        } catch (error) {
            showNotification('Failed to load withheld orders', 'error');
        }
    }

    function displayWithheldOrders(orders) {
        const listDiv = document.getElementById('withheldOrdersList');
        
        // Calculate totals
        const orderCount = orders.length;
        const totalAmount = orders.reduce((sum, order) => sum + parseFloat(order.total_amount || 0), 0);
        
        // Update badge and summary
        updateWithheldOrdersSummary(orderCount, totalAmount);
        
        if (orders.length === 0) {
            listDiv.innerHTML = '<p class="text-gray-500 text-center col-span-full py-8">No withheld orders</p>';
            return;
        }

        listDiv.innerHTML = orders.map(order => {
            const items = order.items || [];
            const itemsList = items.length > 0 ? items.map(item => {
                const itemId = item.item_id || item.id;
                const itemName = (item.item_name || item.name || '').replace(/'/g, "\\'");
                const quantity = item.quantity || 0;
                return `
                <div class="flex items-center justify-between py-2 border-b border-gray-200 last:border-b-0">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">${item.item_name || item.name}</p>
                        <p class="text-xs text-gray-500">Qty: ${quantity} × KSh ${parseFloat(item.unit_price || item.price || 0).toFixed(2)}</p>
                    </div>
                    <button onclick="requestItemReturn(${order.id}, ${itemId}, '${itemName}', ${quantity})" 
                            class="ml-2 px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs hover:bg-orange-200 transition-colors" 
                            title="Return Item (Requires Approval)">
                        <i class="fas fa-minus-circle"></i>
                    </button>
                </div>
            `;
            }).join('') : '<p class="text-xs text-gray-500">No items</p>';
            
            return `
            <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-gray-800">${order.order_number}</h3>
                    <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full">Withheld</span>
                </div>
                <p class="text-sm text-gray-600 mb-2"><strong>Table:</strong> ${order.table_number || 'No Table'}</p>
                <div class="mb-3">
                    <p class="text-sm font-semibold text-gray-700 mb-2">Items:</p>
                    <div class="bg-white rounded-lg p-2 max-h-40 overflow-y-auto">
                        ${itemsList}
                    </div>
                </div>
                <p class="text-sm text-gray-600 mb-3"><strong>Total:</strong> KSh ${parseFloat(order.total_amount).toFixed(2)}</p>
                <div class="flex space-x-2">
                    <button onclick="editWithheldOrder(${order.id})" class="flex-1 bg-blue-600 text-white py-2 px-3 rounded-lg hover:bg-blue-700 text-sm font-semibold">
                        <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                    <button onclick="finishWithheldOrder(${order.id})" class="flex-1 bg-green-600 text-white py-2 px-3 rounded-lg hover:bg-green-700 text-sm font-semibold">
                        <i class="fas fa-check mr-1"></i>Finish
                    </button>
                </div>
            </div>
        `;
        }).join('');
    }
    
    function updateWithheldOrdersSummary(count, total) {
        // Update badge
        const badge = document.getElementById('withheldOrdersBadge');
        if (badge) {
            badge.textContent = count;
            if (count > 0) {
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
        
        // Update summary display in section header
        const countDisplay = document.getElementById('withheldOrdersCountDisplay');
        const totalDisplay = document.getElementById('withheldOrdersTotalDisplay');
        if (countDisplay) countDisplay.textContent = count;
        if (totalDisplay) totalDisplay.textContent = total.toFixed(2);
        
        // Update tooltip
        const tooltipCount = document.getElementById('withheldOrdersCount');
        const tooltipTotal = document.getElementById('withheldOrdersTotal');
        if (tooltipCount) tooltipCount.textContent = `${count} ${count === 1 ? 'Order' : 'Orders'}`;
        if (tooltipTotal) tooltipTotal.textContent = `KSh ${total.toFixed(2)}`;
    }
    
    function scrollToWithheldOrders() {
        const section = document.getElementById('withheldOrdersSection');
        if (section) {
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Add a highlight effect
            section.classList.add('ring-4', 'ring-orange-300', 'ring-opacity-50');
            setTimeout(() => {
                section.classList.remove('ring-4', 'ring-orange-300', 'ring-opacity-50');
            }, 2000);
        }
    }
    
    // Quantity decrease approval modal for order updates
    function showQuantityDecreaseApprovalModalForUpdate(decreasedItems, tableNumber, originalOrder) {
        // Create or get approval modal
        let modal = document.getElementById('approvalModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'approvalModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-[60] hidden';
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div class="bg-gradient-to-r from-orange-600 to-red-600 text-white p-6 rounded-t-2xl">
                            <h2 class="text-xl font-bold">Approval Required</h2>
                            <p class="text-sm text-orange-100 mt-1">Manager/Admin/Cashier validation needed</p>
                        </div>
                        <div class="p-6">
                            <div id="approvalModalContent">
                                <!-- Content will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        const itemsList = decreasedItems.map(item => `
            <div class="bg-gray-50 rounded-lg p-3 mb-2">
                <p class="font-semibold text-gray-800 text-sm">${item.item_name}</p>
                <p class="text-xs text-gray-600">Original: ${item.original_quantity} → New: ${item.new_quantity} (Decrease: ${item.decrease_amount})</p>
            </div>
        `).join('');
        
        const content = `
            <div class="mb-6">
                <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-orange-500 text-xl mr-3"></i>
                        <div>
                            <p class="font-semibold text-orange-800">Quantity Decrease Detected</p>
                            <p class="text-sm text-orange-700">This action requires manager approval</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <p class="font-semibold text-gray-800 mb-2">Items with Decreased Quantities:</p>
                    ${itemsList}
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">
                        Manager/Admin/Cashier Code <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="approvalCodeInput" maxlength="4" 
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-center text-2xl font-bold tracking-widest"
                           placeholder="0000" autofocus>
                    <p class="text-xs text-gray-500 mt-2 text-center">Enter 4-digit approval code (auto-validates)</p>
                </div>
                
                <div id="approverInfo" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-user-check text-blue-600 mr-2"></i>
                        <div>
                            <p class="text-sm font-semibold text-blue-900" id="approverName"></p>
                            <p class="text-xs text-blue-700" id="approverRole"></p>
                        </div>
                    </div>
                </div>
                
                <div id="approvalError" class="hidden bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                    <p class="text-sm text-red-800" id="approvalErrorMessage"></p>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button id="cancelApprovalBtn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
            </div>
        `;
        
        document.getElementById('approvalModalContent').innerHTML = content;
        modal.classList.remove('hidden');
        
        // Store decreased items for processing
        window.pendingDecreasedItems = decreasedItems;
        window.pendingTableNumber = tableNumber;
        window.pendingOriginalOrder = originalOrder;
        
        const approvalInput = document.getElementById('approvalCodeInput');
        approvalInput.focus();
        
        // Live validation on input - auto-validate after 4th digit
        let validationTimeout;
        approvalInput.addEventListener('input', async function() {
            // Only allow numbers
            this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4);
            
            // Clear previous timeout
            clearTimeout(validationTimeout);
            
            // Hide previous messages
            document.getElementById('approverInfo')?.classList.add('hidden');
            document.getElementById('approvalError')?.classList.add('hidden');
            
            // If 4 digits entered, validate immediately
            if (this.value.length === 4) {
                const validation = await validateApproverCodeForUpdate();
                if (validation.valid) {
                    // Auto-approve if valid
                    await processOrderUpdateWithApproval(this.value);
                }
            }
        });
        
        // Cancel button
        document.getElementById('cancelApprovalBtn').onclick = () => {
            modal.classList.add('hidden');
            window.pendingDecreasedItems = null;
            window.pendingTableNumber = null;
            window.pendingOriginalOrder = null;
        };
        
        // Close on outside click
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                modal.classList.add('hidden');
                window.pendingDecreasedItems = null;
                window.pendingTableNumber = null;
                window.pendingOriginalOrder = null;
            }
        });
    }
    
    async function validateApproverCodeForUpdate() {
        const codeInput = document.getElementById('approvalCodeInput');
        const code = codeInput?.value.trim();
        
        if (!code || code.length !== 4 || !/^\d{4}$/.test(code)) {
            return { valid: false };
        }
        
        try {
            const response = await fetch('/employee/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ employee_code: code })
            });
            
            const data = await response.json();
            
            if (data.success && data.employee) {
                const employee = data.employee;
                const validRoles = ['cashier', 'admin', 'manager'];
                
                if (validRoles.includes(employee.role.toLowerCase())) {
                    // Show approver info
                    const infoDiv = document.getElementById('approverInfo');
                    const nameEl = document.getElementById('approverName');
                    const roleEl = document.getElementById('approverRole');
                    
                    if (infoDiv) infoDiv.classList.remove('hidden');
                    if (nameEl) nameEl.textContent = employee.name;
                    if (roleEl) roleEl.textContent = `Role: ${employee.role.charAt(0).toUpperCase() + employee.role.slice(1)}`;
                    
                    // Hide error
                    document.getElementById('approvalError')?.classList.add('hidden');
                    
                    return { valid: true, employee: employee };
                } else {
                    // Show error - invalid role
                    const errorDiv = document.getElementById('approvalError');
                    const errorMsg = document.getElementById('approvalErrorMessage');
                    
                    if (errorDiv) errorDiv.classList.remove('hidden');
                    if (errorMsg) errorMsg.textContent = `Employee role "${employee.role}" is not authorized. Only Cashier, Admin, or Manager can approve.`;
                    
                    document.getElementById('approverInfo')?.classList.add('hidden');
                    
                    return { valid: false, message: 'Invalid role' };
                }
            } else {
                // Show error - invalid code
                const errorDiv = document.getElementById('approvalError');
                const errorMsg = document.getElementById('approvalErrorMessage');
                
                if (errorDiv) errorDiv.classList.remove('hidden');
                if (errorMsg) errorMsg.textContent = data.message || 'Invalid employee code';
                
                document.getElementById('approverInfo')?.classList.add('hidden');
                
                return { valid: false, message: data.message || 'Invalid code' };
            }
        } catch (error) {
            console.error('Error validating approver code:', error);
            return { valid: false, message: 'Error validating code' };
        }
    }
    
    async function processOrderUpdateWithApproval(approvalCode) {
        const modal = document.getElementById('approvalModal');
        const errorDiv = document.getElementById('approvalError');
        const errorMsg = document.getElementById('approvalErrorMessage');
        
        // Show processing state
        const modalContent = document.getElementById('approvalModalContent');
        const originalContent = modalContent.innerHTML;
        modalContent.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-4xl text-orange-600 mb-4"></i>
                <p class="text-gray-700 font-semibold">Processing update...</p>
            </div>
        `;
        
        try {
            // Save printer connections before updating order
            savePrinterConnections();
            
            // Get original order for comparison
            const originalOrder = window.pendingOriginalOrder;
            
            // Update order with approval code
            const response = await fetch(`/api/withheld-orders/${currentEditingOrderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    table_number: window.pendingTableNumber || document.getElementById('tableNumberInput').value.trim() || 'No Table',
                    items: currentCart.map(item => ({
                        item_id: item.id,
                        quantity: item.quantity,
                        unit_price: item.price,
                        total_price: item.price * item.quantity
                    })),
                    approver_code: approvalCode,
                    decreased_items: window.pendingDecreasedItems || []
                })
            });
            
            const data = await response.json();
            if (data.success) {
                modal.classList.add('hidden');
                showNotification('Order updated successfully!', 'success');
                
                // Don't print receipt for updates with decreases
                
                clearCart();
                await loadWithheldOrders();
                
                // Clear pending data
                window.pendingDecreasedItems = null;
                window.pendingTableNumber = null;
                window.pendingOriginalOrder = null;
                
                // Logout employee after updating (printer connections will be saved and restored by logoutEmployee)
                setTimeout(() => {
                    logoutEmployee();
                }, 300);
            } else {
                // Restore original content
                modalContent.innerHTML = originalContent;
                
                // Re-setup event listeners
                const approvalInput = document.getElementById('approvalCodeInput');
                approvalInput.value = approvalCode;
                
                // Setup input listener again
                approvalInput.addEventListener('input', async function() {
                    this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4);
                    document.getElementById('approverInfo')?.classList.add('hidden');
                    document.getElementById('approvalError')?.classList.add('hidden');
                    
                    if (this.value.length === 4) {
                        const validation = await validateApproverCodeForUpdate();
                        if (validation.valid) {
                            await processOrderUpdateWithApproval(this.value);
                        }
                    }
                });
                
                // Setup cancel button
                document.getElementById('cancelApprovalBtn').onclick = () => {
                    modal.classList.add('hidden');
                    window.pendingDecreasedItems = null;
                    window.pendingTableNumber = null;
                    window.pendingOriginalOrder = null;
                };
                
                errorDiv.classList.remove('hidden');
                if (errorMsg) errorMsg.textContent = data.message || 'Invalid approval code or failed to update order';
                approvalInput.focus();
            }
        } catch (error) {
            console.error('Error processing order update:', error);
            
            // Restore original content
            modalContent.innerHTML = originalContent;
            
            // Re-setup event listeners
            const approvalInput = document.getElementById('approvalCodeInput');
            approvalInput.value = approvalCode;
            
            // Setup input listener again
            approvalInput.addEventListener('input', async function() {
                this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4);
                document.getElementById('approverInfo')?.classList.add('hidden');
                document.getElementById('approvalError')?.classList.add('hidden');
                
                if (this.value.length === 4) {
                    const validation = await validateApproverCodeForUpdate();
                    if (validation.valid) {
                        await processOrderUpdateWithApproval(this.value);
                    }
                }
            });
            
            // Setup cancel button
            document.getElementById('cancelApprovalBtn').onclick = () => {
                modal.classList.add('hidden');
                window.pendingDecreasedItems = null;
                window.pendingTableNumber = null;
                window.pendingOriginalOrder = null;
            };
            
            errorDiv.classList.remove('hidden');
            if (errorMsg) errorMsg.textContent = 'Error processing request. Please try again.';
            approvalInput.focus();
        }
    }

    // Item return functionality
    let currentReturnRequest = null;
    
    async function requestItemReturn(orderId, itemId, itemName, currentQuantity) {
        if (!currentEmployee) {
            showNotification('Please log in to return items', 'error');
            return;
        }
        
        // Store return request details
        currentReturnRequest = {
            orderId: orderId,
            itemId: itemId,
            itemName: itemName,
            currentQuantity: currentQuantity,
            returnQuantity: 1 // Default to return 1 item
        };
        
        // Show approval modal
        showItemReturnApprovalModal();
    }
    
    function showItemReturnApprovalModal() {
        if (!currentReturnRequest) return;
        
        const modal = document.getElementById('itemReturnApprovalModal');
        const itemNameEl = document.getElementById('returnItemName');
        const currentQtyEl = document.getElementById('returnCurrentQuantity');
        const returnQtyEl = document.getElementById('returnQuantity');
        
        if (itemNameEl) itemNameEl.textContent = currentReturnRequest.itemName;
        if (currentQtyEl) currentQtyEl.textContent = currentReturnRequest.currentQuantity;
        if (returnQtyEl) returnQtyEl.textContent = currentReturnRequest.returnQuantity;
        
        // Reset form
        const codeInput = document.getElementById('approverCodeInput');
        if (codeInput) {
            codeInput.value = '';
            codeInput.focus();
        }
        
        // Hide info/error messages
        document.getElementById('approverInfo')?.classList.add('hidden');
        document.getElementById('approverError')?.classList.add('hidden');
        document.getElementById('confirmItemReturnBtn').disabled = true;
        
        if (modal) {
            modal.classList.remove('hidden');
        }
    }
    
    function hideItemReturnApprovalModal() {
        const modal = document.getElementById('itemReturnApprovalModal');
        if (modal) {
            modal.classList.add('hidden');
        }
        currentReturnRequest = null;
    }
    
    async function validateApproverCode() {
        const codeInput = document.getElementById('approverCodeInput');
        const code = codeInput?.value.trim();
        
        if (!code || code.length !== 4 || !/^\d{4}$/.test(code)) {
            return false;
        }
        
        try {
            const response = await fetch('/employee/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ employee_code: code })
            });
            
            const data = await response.json();
            
            if (data.success && data.employee) {
                const employee = data.employee;
                const validRoles = ['cashier', 'admin', 'manager'];
                
                if (validRoles.includes(employee.role.toLowerCase())) {
                    // Show approver info
                    const infoDiv = document.getElementById('approverInfo');
                    const nameEl = document.getElementById('approverName');
                    const roleEl = document.getElementById('approverRole');
                    
                    if (infoDiv) infoDiv.classList.remove('hidden');
                    if (nameEl) nameEl.textContent = employee.name;
                    if (roleEl) roleEl.textContent = `Role: ${employee.role.charAt(0).toUpperCase() + employee.role.slice(1)}`;
                    
                    // Hide error
                    document.getElementById('approverError')?.classList.add('hidden');
                    
                    // Enable confirm button
                    document.getElementById('confirmItemReturnBtn').disabled = false;
                    
                    return { valid: true, employee: employee };
                } else {
                    // Show error - invalid role
                    const errorDiv = document.getElementById('approverError');
                    const errorMsg = document.getElementById('approverErrorMessage');
                    
                    if (errorDiv) errorDiv.classList.remove('hidden');
                    if (errorMsg) errorMsg.textContent = `Employee role "${employee.role}" is not authorized. Only Cashier, Admin, or Manager can approve returns.`;
                    
                    document.getElementById('approverInfo')?.classList.add('hidden');
                    document.getElementById('confirmItemReturnBtn').disabled = true;
                    
                    return { valid: false, message: 'Invalid role' };
                }
            } else {
                // Show error - invalid code
                const errorDiv = document.getElementById('approverError');
                const errorMsg = document.getElementById('approverErrorMessage');
                
                if (errorDiv) errorDiv.classList.remove('hidden');
                if (errorMsg) errorMsg.textContent = data.message || 'Invalid employee code';
                
                document.getElementById('approverInfo')?.classList.add('hidden');
                document.getElementById('confirmItemReturnBtn').disabled = true;
                
                return { valid: false, message: data.message || 'Invalid code' };
            }
        } catch (error) {
            console.error('Error validating approver code:', error);
            return { valid: false, message: 'Error validating code' };
        }
    }
    
    async function confirmItemReturn() {
        if (!currentReturnRequest) return;
        
        const codeInput = document.getElementById('approverCodeInput');
        const code = codeInput?.value.trim();
        
        if (!code || code.length !== 4) {
            showNotification('Please enter a valid 4-digit code', 'error');
            return;
        }
        
        // Validate approver first
        const validation = await validateApproverCode();
        if (!validation.valid) {
            return;
        }
        
        const confirmBtn = document.getElementById('confirmItemReturnBtn');
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        
        try {
            const response = await fetch(`/api/withheld-orders/${currentReturnRequest.orderId}/return-item`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    item_id: currentReturnRequest.itemId,
                    return_quantity: currentReturnRequest.returnQuantity,
                    approver_code: code
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification('Item returned successfully and restocked!', 'success');
                hideItemReturnApprovalModal();
                await loadWithheldOrders(); // Reload orders
                
                // Logout employee after returning item (printer connections will be saved and restored by logoutEmployee)
                setTimeout(() => {
                    logoutEmployee();
                }, 300);
            } else {
                const errorDiv = document.getElementById('approverError');
                const errorMsg = document.getElementById('approverErrorMessage');
                
                if (errorDiv) errorDiv.classList.remove('hidden');
                if (errorMsg) errorMsg.textContent = data.message || 'Failed to return item';
                
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Approve Return';
            }
        } catch (error) {
            console.error('Error returning item:', error);
            const errorDiv = document.getElementById('approverError');
            const errorMsg = document.getElementById('approverErrorMessage');
            
            if (errorDiv) errorDiv.classList.remove('hidden');
            if (errorMsg) errorMsg.textContent = 'Error processing return. Please try again.';
            
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Approve Return';
        }
    }

    async function editWithheldOrder(orderId) {
        try {
            const response = await fetch('/api/withheld-orders');
            const data = await response.json();
            if (data.success) {
                const order = data.orders.find(o => o.id === orderId);
                if (order) {
                    currentCart = order.items.map(item => ({
                        id: item.item_id,
                        name: item.item_name,
                        price: parseFloat(item.unit_price),
                        quantity: item.quantity,
                        originalQuantity: item.quantity, // Store original quantity
                        orderItemId: item.id // Store order item ID for updates
                    }));
                    currentEditingOrderId = orderId;
                    document.getElementById('tableNumberInput').value = order.table_number || '';
                    document.getElementById('updateWithheldBtn').classList.remove('hidden');
                    document.getElementById('saveToWithheldBtn').classList.add('hidden');
                    document.getElementById('printOrderBtn').classList.add('hidden');
                    updateCartDisplay();
                    
                    // Open cart drawer immediately to show the order for editing
                    setTimeout(() => {
                        openCartDrawer();
                    }, 100); // Small delay to ensure cart display is updated
                    
                    showNotification('Order loaded for editing. You can adjust quantities freely. Approval will be required when updating if quantities are decreased.', 'info');
                }
            }
        } catch (error) {
            showNotification('Error loading order', 'error');
        }
    }

    async function finishWithheldOrder(orderId) {
        // Validate printer connection
        if (!isPrinterConnected()) {
            showNotification('Please connect a printer first before finishing orders', 'error');
            return;
        }
        
        if (!confirm('Finish this order? This will complete the sale and convert it to a completed sale.')) return;

        try {
            // Save printer connections before finishing order
            savePrinterConnections();
            
            const response = await fetch(`/api/withheld-orders/${orderId}/finish`, {
                method: 'POST'
            });

            const data = await response.json();
            if (data.success) {
                showNotification('Order completed successfully! Converted to sale.', 'success');
                
                // Print complete receipt for finished order
                await printCompleteReceipt(data.sale);
                
                await loadWithheldOrders(); // This will refresh and the order should be gone
                
                // Logout employee after finishing (printer connections will be saved and restored by logoutEmployee)
                setTimeout(() => {
                    logoutEmployee();
                }, 300);
            } else {
                showNotification(data.message || 'Failed to finish order', 'error');
            }
        } catch (error) {
            showNotification('Error finishing order', 'error');
        }
    }

    // Generate and print complete receipt for finished order
    async function printCompleteReceipt(sale) {
        if (!sale) {
            console.warn('No sale data provided for receipt printing');
            return;
        }
        
        // Fetch printing settings
        let printingSettings = {};
        try {
            const settingsResponse = await fetch('/api/pos/printing-settings');
            const settingsData = await settingsResponse.json();
            if (settingsData.success) {
                printingSettings = settingsData.settings;
            }
        } catch (e) {
            console.warn('Error fetching printing settings:', e);
        }
        
        // Generate receipt content using the same logic as pos.html
        const receiptContent = await generateReceiptContentFromSale(sale, null, printingSettings);
        if (!receiptContent) {
            showNotification('Failed to generate receipt content', 'error');
            return;
        }
        
        // Apply double printing setting from database
        const doublePrint = printingSettings.double_print;
        
        let results;
        if (doublePrint) {
            // Print twice for backup - first as Customer Copy, second as Company Copy
            const customerReceipt = await generateReceiptContentFromSale(sale, 'Customer Copy', printingSettings);
            const companyReceipt = await generateReceiptContentFromSale(sale, 'Company Copy', printingSettings);
            
            const firstPrint = await printToAllAvailablePrinters(customerReceipt);
            const secondPrint = await printToAllAvailablePrinters(companyReceipt);
            
            // Combine results
            results = firstPrint.map((result, index) => ({
                ...result,
                success: result.success && secondPrint[index]?.success
            }));
        } else {
            // Print once using unified printer system
            results = await printToAllAvailablePrinters(receiptContent);
        }
        
        const successCount = results.filter(r => r.success).length;
        const failCount = results.filter(r => !r.success).length;
        
        if (successCount > 0) {
            const printMessage = doublePrint ? 
                `Customer & Company copies printed to ${successCount} printer(s) successfully!` : 
                `Receipt sent to ${successCount} printer(s) successfully!`;
            showNotification(printMessage, 'success');
        } else {
            showNotification('Failed to print receipt. Please check printer connections.', 'error');
        }
    }

    // Generate QR code ESC/POS commands
    function generateQRCodeESC_POS(data) {
        // ESC/POS QR code commands for thermal printers
        // Model: 2, Error Correction: L (48), Size: 6
        
        // Step 1: Set QR code model (Model 2)
        let qrCommand = '\x1D\x28\x6B\x04\x00\x31\x41\x32\x00';
        
        // Step 2: Set QR code size (1-16, we use 6 for good visibility)
        qrCommand += '\x1D\x28\x6B\x03\x00\x31\x43\x06';
        
        // Step 3: Set error correction level (L=48, M=49, Q=50, H=51)
        // L level (7% recovery) is fastest and sufficient for URLs
        qrCommand += '\x1D\x28\x6B\x03\x00\x31\x45\x30';
        
        // Step 4: Store QR code data
        // pL pH fn a m nL nH d1...dk
        const dataLength = data.length + 3;
        const pL = dataLength & 0xFF;
        const pH = (dataLength >> 8) & 0xFF;
        qrCommand += '\x1D\x28\x6B' + String.fromCharCode(pL) + String.fromCharCode(pH) + '\x31\x50\x30';
        qrCommand += data;
        
        // Step 5: Print the QR code
        qrCommand += '\x1D\x28\x6B\x03\x00\x31\x51\x30';
        
        return qrCommand;
    }

    async function generateReceiptContentFromSale(sale, copyType = null, printingSettings = null) {
        if (!sale) {
            return null;
        }

        const subtotal = parseFloat(sale.subtotal || 0);
        const taxAmount = parseFloat(sale.tax_amount || 0);
        const totalAmount = parseFloat(sale.total_amount || 0);
        
        // Check include_tax from hotel settings (already loaded globally)
        // If not set, fallback to printing settings
        let receiptIncludeTax = includeTax;
        if (printingSettings && printingSettings.hasOwnProperty('include_tax')) {
            receiptIncludeTax = printingSettings.include_tax;
        }
        
        const now = new Date(sale.sale_date || sale.created_at || new Date());
        // Format date and time properly
        const dateStr = now.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
        const timeStr = now.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
        
        // ESC/POS commands for thermal printer
        let receipt = '';
        
        // Initialize printer
        receipt += '\x1B\x40'; // ESC @ - Initialize printer
        
        // Fetch hotel settings and receipt settings from database
        let hotelSettings = {};
        let receiptSettings = window.receiptSettings || {};
        
        try {
            const [hotelResponse, receiptResponse] = await Promise.all([
                fetch('/api/pos/hotel-settings'),
                fetch('/api/pos/receipt-settings')
            ]);
            
            const hotelData = await hotelResponse.json();
            const receiptData = await receiptResponse.json();
            
            if (hotelData.success) {
                hotelSettings = hotelData;
                // Override receiptIncludeTax with hotel settings if available
                if (hotelSettings.hasOwnProperty('include_tax')) {
                    receiptIncludeTax = hotelSettings.include_tax === true || hotelSettings.include_tax === 1 || 
                                       hotelSettings.include_tax === '1' || hotelSettings.include_tax === 'True' || 
                                       hotelSettings.include_tax === 'true';
                }
            }
            if (receiptData.success) {
                receiptSettings = receiptData.settings;
                window.receiptSettings = receiptSettings;
            }
        } catch (error) {
            console.error('Error fetching settings for receipt:', error);
            if (!receiptSettings || Object.keys(receiptSettings).length === 0) {
                receiptSettings = {
                    receipt_width: '58mm',
                    receipt_font_size: 'medium',
                    receipt_bold_headers: true,
                    receipt_number_format: 'sequential',
                    receipt_number_prefix: 'POS',
                    receipt_starting_number: 1001,
                    receipt_header_title: '',
                    receipt_header_subtitle: '',
                    receipt_header_message: '',
                    receipt_show_logo: false,
                    receipt_show_address: true,
                    receipt_show_contact: true,
                    receipt_footer_message: '',
                    receipt_show_datetime: true,
                    receipt_show_cashier: true,
                    receipt_show_payment: true,
                    receipt_qr_text: '',
                    receipt_show_qr: false
                };
            }
        }
        
        // Get display name (use receipt header title if set, otherwise hotel name)
        const hotelName = hotelSettings.hotel_name || 'Hotel';
        let displayHotelName = receiptSettings.receipt_header_title || hotelName;
        
        // Header section with receipt settings
        receipt += '\x1B\x61\x01'; // ESC a 1 - Center alignment
        
        // Apply font size based on settings
        if (receiptSettings.receipt_font_size === 'large') {
            receipt += '\x1B\x21\x30'; // ESC ! 0x30 - Double height and width
        } else if (receiptSettings.receipt_font_size === 'small') {
            receipt += '\x1B\x21\x08'; // ESC ! 0x08 - Small font
        } else {
            receipt += '\x1B\x21\x00'; // ESC ! 0x00 - Normal text
        }
        
        // Apply bold headers if enabled
        if (receiptSettings.receipt_bold_headers) {
            receipt += '\x1B\x45\x01'; // ESC E 1 - Bold on
        }
        
        receipt += displayHotelName + '\n';
        
        // Reset formatting
        receipt += '\x1B\x21\x00'; // ESC ! 0x00 - Normal text
        receipt += '\x1B\x45\x00'; // ESC E 0 - Bold off
        
        // Add subtitle if set
        if (receiptSettings.receipt_header_subtitle) {
            receipt += receiptSettings.receipt_header_subtitle + '\n';
        }
        
        // Add address if enabled
        if (receiptSettings.receipt_show_address) {
            const address = receiptSettings.receipt_address || hotelSettings.hotel_address;
            if (address) {
                receipt += address + '\n';
            }
        }
        
        // Add contact info if enabled
        if (receiptSettings.receipt_show_contact) {
            const phone = receiptSettings.receipt_phone || hotelSettings.company_phone;
            if (phone) {
                receipt += `Phone: ${phone}\n`;
            }
            const email = receiptSettings.receipt_email || hotelSettings.company_email;
            if (email) {
                receipt += `Email: ${email}\n`;
            }
        }
        
        // Add header message if set
        if (receiptSettings.receipt_header_message) {
            receipt += receiptSettings.receipt_header_message + '\n';
        }
        
        receipt += '\x1B\x61\x00'; // ESC a 0 - Left alignment
        
        // Separator line
        receipt += '================================\n';
        
        // Copy type label (if specified)
        if (copyType) {
            receipt += '\x1B\x61\x01'; // Center alignment
            receipt += '\x1B\x21\x10'; // ESC ! 0x10 - Double height
            receipt += `*** ${copyType.toUpperCase()} ***\n`;
            receipt += '\x1B\x21\x00'; // ESC ! 0x00 - Normal text
            receipt += '\x1B\x61\x00'; // Left alignment
            receipt += '--------------------------------\n';
        }
        
        // Order details with receipt settings
        const receiptNumber = sale.receipt_number || sale.order_number || 'N/A';
        // Check if receipt number is already formatted (contains prefix)
        const prefix = receiptSettings.receipt_number_prefix || 'POS';
        let formattedReceiptNumber = receiptNumber.toString();
        
        // Check if receipt number already starts with prefix (already formatted from API)
        if (formattedReceiptNumber.startsWith(prefix)) {
            // Already formatted, use as-is
            formattedReceiptNumber = formattedReceiptNumber;
        } else if (receiptSettings.receipt_number_format === 'sequential') {
            // Format sequential: PREFIX + number (padded)
            formattedReceiptNumber = `${prefix}${receiptNumber.toString().padStart(4, '0')}`;
        } else if (receiptSettings.receipt_number_format === 'date_time') {
            // Format date_time: PREFIX + YYYYMMDDHHMM
            const now = new Date();
            formattedReceiptNumber = `${prefix}${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
        } else {
            // Default: add prefix if not present
            if (!formattedReceiptNumber.startsWith(prefix)) {
                formattedReceiptNumber = `${prefix}${formattedReceiptNumber}`;
            }
        }
        
        // Receipt number in bold with proper spacing
        receipt += '\x1B\x45\x01'; // ESC E 1 - Bold on
        receipt += `Receipt #: ${formattedReceiptNumber}\n`;
        receipt += '\x1B\x45\x00'; // ESC E 0 - Bold off
        
        // Add date/time if enabled - time below date
        if (receiptSettings.receipt_show_datetime) {
            receipt += `Date: ${dateStr}\n`;
            receipt += `Time: ${timeStr}\n`;
        }
        
        // Add cashier if enabled
        if (receiptSettings.receipt_show_cashier) {
            receipt += `Served by: ${sale.employee_name || 'N/A'}\n`;
        }
        
        // Add credit sale information if this is a credit sale
        if (sale.sale_type === 'credit' && sale.credit_company_id) {
            receipt += '--------------------------------\n';
            receipt += '\x1B\x21\x10'; // ESC ! 0x10 - Double height
            receipt += '*** CREDIT SALE ***\n';
            receipt += '\x1B\x21\x00'; // ESC ! 0x00 - Normal text
            
            // Fetch credit company information
            try {
                const companyResponse = await fetch(`/api/credit-companies/${sale.credit_company_id}`);
                if (companyResponse.ok) {
                    const companyData = await companyResponse.json();
                    if (companyData.success && companyData.company) {
                        const company = companyData.company;
                        receipt += `Company: ${company.name}\n`;
                        receipt += `Phone: ${company.phone_number}\n`;
                        if (company.company_id) {
                            receipt += `ID: ${company.company_id}\n`;
                        }
                        if (company.email) {
                            receipt += `Email: ${company.email}\n`;
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching credit company info:', error);
                receipt += `Company ID: ${sale.credit_company_id}\n`;
            }
            receipt += '--------------------------------\n';
        }
        
        // Items
        receipt += 'ITEMS:\n';
        if (sale.items && sale.items.length > 0) {
            sale.items.forEach(item => {
                const unitPrice = parseFloat(item.unit_price || item.price || 0);
                const quantity = parseInt(item.quantity || 1);
                const itemTotal = unitPrice * quantity;
                receipt += `${item.item_name || item.name}\n`;
                receipt += `  ${quantity} x KSh ${unitPrice.toFixed(2)} = KSh ${itemTotal.toFixed(2)}\n`;
            });
        }
        
        receipt += '--------------------------------\n';
        
        // Totals
        receipt += `Subtotal:     KSh ${subtotal.toFixed(2)}\n`;
        if (receiptIncludeTax && taxAmount > 0) {
            receipt += `Tax (8%):     KSh ${taxAmount.toFixed(2)}\n`;
        }
        receipt += '--------------------------------\n';
        receipt += `TOTAL:        KSh ${totalAmount.toFixed(2)}\n`;
        
        // Payment Methods Section (only if Show Till setting is enabled)
        let showTill = false;
        if (printingSettings && printingSettings.hasOwnProperty('show_till')) {
            showTill = printingSettings.show_till;
        }
        
        if (showTill) {
            receipt += '\n';
            receipt += 'PAYMENT METHODS:\n';
            receipt += '--------------------------------\n';
            
            // M-Pesa payment information
            if (hotelSettings.payment_method === 'buy_goods' && hotelSettings.till_number) {
                receipt += `M-Pesa Buy Goods:\n`;
                receipt += `Till Number: ${hotelSettings.till_number}\n`;
                receipt += '\n';
            } else if (hotelSettings.payment_method === 'paybill' && hotelSettings.business_number) {
                receipt += `M-Pesa Paybill:\n`;
                receipt += `Business No: ${hotelSettings.business_number}\n`;
                if (hotelSettings.account_number) {
                    receipt += `Account: ${hotelSettings.account_number}\n`;
                }
                receipt += '\n';
            }
            
            // Always add cash payment
            receipt += 'Cash Payment: Available\n';
            receipt += '\n';
        }
        
        // Footer with receipt settings
        receipt += '\x1B\x61\x01'; // Center alignment
        
        // Use custom footer message if set, otherwise default
        if (receiptSettings.receipt_footer_message) {
            receipt += receiptSettings.receipt_footer_message + '\n';
        } else {
            receipt += 'Thank you for your business!\n';
            receipt += 'Visit us again soon!\n';
        }
        
        // Add QR code if enabled in hotel settings
        const showQR = receiptSettings.receipt_show_qr === true || receiptSettings.receipt_show_qr === 1 || 
                      receiptSettings.receipt_show_qr === '1' || receiptSettings.receipt_show_qr === 'True' || 
                      receiptSettings.receipt_show_qr === 'true';
        
        if (showQR) {
            receipt += '\n';
            receipt += '\x1B\x61\x01'; // Center alignment for QR code
            const baseUrl = window.location.origin;
            // Use the original receipt number (not formatted) for the URL
            const qrUrl = `${baseUrl}/receipt/${receiptNumber}`;
            receipt += generateQRCodeESC_POS(qrUrl);
            receipt += '\n\n'; // Add some space after QR code
            receipt += '\x1B\x61\x00'; // Reset to left alignment
        }
        
        receipt += '\x1B\x61\x00'; // Left alignment
        
        // Cut paper
        receipt += '\n\n\n';
        receipt += '\x1D\x56\x00'; // GS V 0 - Full cut
        
        return receipt;
    }

    async function returnOrderItem(orderId, orderItemId, itemId, quantity, itemName) {
        // Show approval modal
        const approvalCode = prompt(`Return item: ${itemName}\nQuantity: ${quantity}\n\nPlease enter Manager/Admin/Cashier 4-digit code for approval:`);
        
        if (!approvalCode || approvalCode.length !== 4) {
            showNotification('Invalid approval code', 'error');
            return;
        }

        try {
            const response = await fetch(`/api/withheld-orders/${orderId}/return-item`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    order_item_id: orderItemId,
                    item_id: itemId,
                    quantity: quantity,
                    approval_code: approvalCode
                })
            });

            const data = await response.json();
            if (data.success) {
                showNotification('Item returned successfully and restocked!', 'success');
                loadWithheldOrders();
            } else {
                showNotification(data.message || 'Failed to return item', 'error');
            }
        } catch (error) {
            showNotification('Error returning item', 'error');
        }
    }

    function logoutEmployee() {
        // Save printer connections before logging out to ensure they're retained
        savePrinterConnections();
        
        // Clear current employee
        currentEmployee = null;
        currentCart = [];
        currentEditingOrderId = null;
        
        // Clear session via API
        fetch('/api/employee/logout', {
            method: 'POST'
        }).catch(err => console.error('Logout error:', err));
        
        // Show login modal
        document.getElementById('employeeCodeModal').classList.remove('hidden');
        document.getElementById('currentEmployeeInfo').classList.add('hidden');
        
        // Reset login input - clear value and all styling
        const input = document.getElementById('employeeCodeInput');
        const errorDiv = document.getElementById('employeeCodeError');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        // Clear input value
        input.value = '';
        
        // Remove all styling classes
        input.classList.remove('opacity-50', 'cursor-not-allowed', 'border-green-500', 'bg-green-50', 'border-red-500', 'bg-red-50');
        
        // Reset input state
        input.disabled = false;
        input.classList.add('border-gray-300');
        
        // Clear error message
        if (errorDiv) {
            errorDiv.textContent = '';
            errorDiv.classList.add('hidden');
        }
        
        // Remove loading indicator if present
        if (loadingIndicator) {
            loadingIndicator.remove();
        }
        
        // Focus on input for next employee
        setTimeout(() => {
            input.focus();
        }, 100);
        
        // Clear cart display
        clearCart();
        
        // Restore printer connections after logout (they're saved in localStorage)
        setTimeout(() => {
            restorePrinterConnections();
            updatePrinterStatus();
            
            // Reload products and withheld orders to refresh the page
            loadProducts();
            // Note: loadWithheldOrders() requires currentEmployee, so it won't run here
            // The withheld orders will be reloaded when the next employee logs in
        }, 500);
        
        showNotification('Employee logged out. Printer connections retained.', 'info');
    }

    async function printUnpaidReceipt(order, items = null) {
        // Check if printer is connected
        if (!isPrinterConnected()) {
            showNotification('No printer connected. Please connect a printer first.', 'error');
            return false;
        }
        
        // Generate receipt content for unpaid order - showing only new/updated items
        const receiptContent = await generateUnpaidReceiptContent(order, items);
        if (receiptContent) {
            try {
                const results = await printToAllAvailablePrinters(receiptContent);
                const successCount = results.filter(r => r.success).length;
                const failCount = results.filter(r => !r.success).length;
                
                if (successCount > 0) {
                    showNotification(`Unpaid receipt printed successfully to ${successCount} printer(s)`, 'success');
                    return true;
                } else {
                    showNotification('Failed to print unpaid receipt', 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error printing unpaid receipt:', error);
                showNotification('Error printing unpaid receipt', 'error');
                return false;
            }
        }
        return false;
    }

    // Check if printer is connected - STRICT VALIDATION
    function isPrinterConnected() {
        console.log('🔍 Checking printer connection status...');
        let connectedCount = 0;
        let printerDetails = [];
        
        // Check unified manager first (preferred method)
        if (window.unifiedPrinterManager) {
            try {
                const printers = window.unifiedPrinterManager.getAllConnectedPrinters();
                if (printers && printers.all && Array.isArray(printers.all) && printers.all.length > 0) {
                    // Verify printers are actually connected (not just in the list)
                    const verifiedPrinters = printers.all.filter(p => {
                        // Check if printer has status 'connected' or is actually connected
                        return p && (p.status === 'connected' || p.connected === true || p.status === undefined);
                    });
                    if (verifiedPrinters.length > 0) {
                        connectedCount += verifiedPrinters.length;
                        printerDetails.push(...verifiedPrinters.map(p => `Unified: ${p.name || p.id}`));
                        console.log(`✅ Found ${verifiedPrinters.length} connected printer(s) via unified manager`);
                        return true;
                    }
                }
            } catch (e) {
                console.warn('Error checking unified printer manager:', e);
            }
        }
        
        // Fallback: Check individual managers - MUST have at least one connected
        let hasConnected = false;
        
        // Check Bluetooth printers
        if (window.bluetoothPrinterManager) {
            try {
                const bluetoothPrinters = window.bluetoothPrinterManager.getConnectedPrinters();
                if (Array.isArray(bluetoothPrinters) && bluetoothPrinters.length > 0) {
                    // Verify printers are actually connected
                    const verified = bluetoothPrinters.filter(p => {
                        return p && (p.status === 'connected' || p.connected === true || 
                                (p.device && p.server && p.server.connected));
                    });
                    if (verified.length > 0) {
                        hasConnected = true;
                        connectedCount += verified.length;
                        printerDetails.push(...verified.map(p => `Bluetooth: ${p.name || p.id}`));
                        console.log(`✅ Found ${verified.length} connected Bluetooth printer(s)`);
                    }
                }
            } catch (e) {
                console.warn('Error checking Bluetooth printers:', e);
            }
        }
        
        // Check WiFi printers
        if (window.wifiPrinterManager) {
            try {
                const wifiPrinters = window.wifiPrinterManager.getConnectedPrinters();
                if (Array.isArray(wifiPrinters) && wifiPrinters.length > 0) {
                    // Verify printers are actually connected (status must be 'connected')
                    const verified = wifiPrinters.filter(p => {
                        return p && p.status === 'connected';
                    });
                    if (verified.length > 0) {
                        hasConnected = true;
                        connectedCount += verified.length;
                        printerDetails.push(...verified.map(p => `WiFi: ${p.name || p.ip}`));
                        console.log(`✅ Found ${verified.length} connected WiFi printer(s)`);
                    }
                }
            } catch (e) {
                console.warn('Error checking WiFi printers:', e);
            }
        }
        
        // Check WiFi Thermal printers
        if (window.wifiThermalPrinterManager) {
            try {
                const thermalPrinters = window.wifiThermalPrinterManager.getConnectedPrinters();
                if (Array.isArray(thermalPrinters) && thermalPrinters.length > 0) {
                    // Verify printers are actually connected (status must be 'connected')
                    const verified = thermalPrinters.filter(p => {
                        return p && p.status === 'connected';
                    });
                    if (verified.length > 0) {
                        hasConnected = true;
                        connectedCount += verified.length;
                        printerDetails.push(...verified.map(p => `WiFi Thermal: ${p.name || p.ip}`));
                        console.log(`✅ Found ${verified.length} connected WiFi Thermal printer(s)`);
                    }
                }
            } catch (e) {
                console.warn('Error checking WiFi Thermal printers:', e);
            }
        }
        
        // Check USB printers
        if (window.usbPrinterManager) {
            try {
                if (typeof window.usbPrinterManager.isConnected === 'function') {
                    if (window.usbPrinterManager.isConnected()) {
                        const usbPrinters = window.usbPrinterManager.getConnectedPrinters();
                        if (Array.isArray(usbPrinters) && usbPrinters.length > 0) {
                            hasConnected = true;
                            connectedCount += usbPrinters.length;
                            printerDetails.push(...usbPrinters.map(p => `USB: ${p.name || p.id}`));
                            console.log(`✅ Found ${usbPrinters.length} connected USB printer(s)`);
                        }
                    }
                }
            } catch (e) {
                console.warn('Error checking USB printers:', e);
            }
        }
        
        if (hasConnected) {
            console.log(`✅ Printer connection verified: ${connectedCount} printer(s) connected`);
            console.log('Connected printers:', printerDetails);
            return true;
        } else {
            console.log('❌ NO PRINTERS CONNECTED - All checks returned false');
            console.log('Printer connection check details:', {
                unifiedManager: window.unifiedPrinterManager ? 'exists' : 'missing',
                bluetoothManager: window.bluetoothPrinterManager ? 'exists' : 'missing',
                wifiManager: window.wifiPrinterManager ? 'exists' : 'missing',
                wifiThermalManager: window.wifiThermalPrinterManager ? 'exists' : 'missing',
                usbManager: window.usbPrinterManager ? 'exists' : 'missing'
            });
            return false;
        }
    }

    // Print to all available printers
    async function printToAllAvailablePrinters(content) {
        console.log('=== RECEIPT PRINTING DEBUG ===');
        console.log('Content length:', content ? content.length : 'null');
        
        // Try unified manager first (preferred method)
        if (window.unifiedPrinterManager && window.unifiedPrinterManager.printToAllPrinters) {
            try {
                console.log('Using unified printer manager for receipt printing...');
                const results = await window.unifiedPrinterManager.printToAllPrinters(content);
                console.log('Unified printer manager results:', results);
                return results;
            } catch (error) {
                console.warn('Unified printer manager failed, trying fallback:', error);
            }
        }
        
        // Fallback: Print to individual managers
        const results = [];
        
        // Print to Bluetooth printers
        if (window.bluetoothPrinterManager) {
            try {
                console.log('Trying Bluetooth printer manager...');
                const bluetoothResult = await window.bluetoothPrinterManager.printToAllPrinters(content);
                results.push(...bluetoothResult);
                console.log('Bluetooth printing results:', bluetoothResult);
            } catch (error) {
                console.warn('Bluetooth printing failed:', error);
                results.push({ printerId: 'bluetooth', success: false, error: error.message });
            }
        }
        
        // Print to WiFi printers
        if (window.wifiPrinterManager) {
            try {
                console.log('Trying WiFi printer manager...');
                const wifiResult = await window.wifiPrinterManager.printToAllPrinters(content);
                results.push(...wifiResult);
                console.log('WiFi printing results:', wifiResult);
            } catch (error) {
                console.warn('WiFi printing failed:', error);
                results.push({ printerId: 'wifi', success: false, error: error.message });
            }
        }
        
        // Print to USB printers
        if (window.usbPrinterManager) {
            try {
                console.log('Trying USB printer manager...');
                const usbResult = await window.usbPrinterManager.printToAllPrinters(content);
                results.push(...usbResult);
                console.log('USB printing results:', usbResult);
            } catch (error) {
                console.warn('USB printing failed:', error);
                results.push({ printerId: 'usb', success: false, error: error.message });
            }
        }
        
        // If no results, return a failure result
        if (results.length === 0) {
            return [{ printerId: 'none', success: false, error: 'No printers available' }];
        }
        
        return results;
    }

    function updatePrinterStatus() {
        const statusBadge = document.getElementById('printerStatusBadge');
        const statusText = document.getElementById('printerStatusText');
        const statusIndicator = statusBadge?.querySelector('.w-3') || statusBadge?.querySelector('.w-2');
        const saveBtn = document.getElementById('saveToWithheldBtn');
        const printBtn = document.getElementById('printOrderBtn');
        
        const connected = isPrinterConnected();
        
        // Update status badge
        if (statusBadge && statusText && statusIndicator) {
            if (connected) {
                statusText.textContent = 'Connected';
                statusIndicator.className = 'w-3 h-3 bg-green-400 rounded-full';
                statusIndicator.classList.remove('animate-pulse');
            } else {
                statusText.textContent = 'Not Connected';
                statusIndicator.className = 'w-3 h-3 bg-red-400 rounded-full animate-pulse';
            }
        }
        
        // CRITICAL: Enable/disable save and print buttons based on printer connection
        if (saveBtn) {
            if (connected && currentEmployee && currentCart.length > 0) {
                saveBtn.disabled = false;
                saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                saveBtn.disabled = true;
                saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        
        if (printBtn) {
            if (connected && currentEmployee && currentCart.length > 0) {
                printBtn.disabled = false;
                printBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                printBtn.disabled = true;
                printBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }
        
        console.log(`Printer status updated: ${connected ? 'CONNECTED' : 'NOT CONNECTED'} - Buttons ${connected ? 'ENABLED' : 'DISABLED'}`);
    }

    async function generateUnpaidReceiptContent(order, items = null) {
        // Generate receipt content for unpaid order - showing only new/updated items
        let receipt = '\x1B\x40'; // Initialize printer
        receipt += '\x1B\x61\x01'; // Center alignment
        receipt += '\x1B\x21\x30'; // Double height and width
        receipt += '*** UNPAID ORDER ***\n';
        receipt += '\x1B\x21\x00'; // Normal text
        receipt += '\x1B\x61\x00'; // Left alignment
        receipt += '================================\n';
        
        // Fetch hotel settings
        let hotelName = 'Hotel';
        try {
            const response = await fetch('/api/hotel-settings');
            const data = await response.json();
            if (data.success && data.settings) {
                hotelName = data.settings.hotel_name || 'Hotel';
            }
        } catch (e) {
            console.warn('Error fetching hotel settings:', e);
        }
        
        receipt += `\x1B\x61\x01`; // Center
        receipt += `${hotelName}\n`;
        receipt += `\x1B\x61\x00`; // Left
        receipt += '================================\n';
        receipt += `Order: ${order.order_number}\n`;
        receipt += `Table: ${order.table_number || 'No Table'}\n`;
        // Add employee name if available
        if (order.employee_name) {
            receipt += `Employee: ${order.employee_name}\n`;
        } else if (currentEmployee && currentEmployee.name) {
            receipt += `Employee: ${currentEmployee.name}\n`;
        }
        receipt += `Date: ${new Date().toLocaleString()}\n`;
        receipt += '================================\n';
        receipt += 'NEW/ADDED ITEMS:\n';
        receipt += '--------------------------------\n';
        
        // Use provided items or fetch from order
        let itemsToPrint = items;
        if (!itemsToPrint && order.items) {
            itemsToPrint = order.items;
        } else if (!itemsToPrint) {
            // Fetch items from API
            try {
                const response = await fetch(`/api/withheld-orders/${order.id}`);
                const data = await response.json();
                if (data.success && data.order && data.order.items) {
                    itemsToPrint = data.order.items;
                }
            } catch (e) {
                console.warn('Error fetching order items:', e);
            }
        }
        
        if (itemsToPrint && itemsToPrint.length > 0) {
            itemsToPrint.forEach(item => {
                const itemTotal = parseFloat(item.unit_price || item.price || 0) * parseInt(item.quantity || 1);
                receipt += `${item.item_name || item.name}\n`;
                receipt += `  ${item.quantity} x KSh ${parseFloat(item.unit_price || item.price || 0).toFixed(2)} = KSh ${itemTotal.toFixed(2)}\n`;
            });
        }
        
        receipt += '--------------------------------\n';
        receipt += `Total: KSh ${parseFloat(order.total_amount || 0).toFixed(2)}\n`;
        receipt += '\n';
        receipt += '\x1B\x61\x01'; // Center
        receipt += '*** UNPAID - NOT COMPLETED ***\n';
        receipt += '\x1B\x61\x00'; // Left
        receipt += '\n\n\n';
        return receipt;
    }

    async function loadPrintingSettings() {
        try {
            const response = await fetch('/api/pos/printing-settings');
            const data = await response.json();
            if (data.success) {
                printingSettings = data.settings;
            }
        } catch (error) {
            console.error('Error loading printing settings:', error);
        }
    }

    function showNotification(message, type = 'info') {
        // Create notification container if it doesn't exist
        let container = document.getElementById('notificationContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notificationContainer';
            container.className = 'fixed top-4 right-4 z-50 space-y-2';
            document.body.appendChild(container);
        }
        
        const notification = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
        notification.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2`;
        notification.innerHTML = `
            <span>${message}</span>
            <button onclick="this.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
    }

    // Initialize item return modal controls
    function initializeItemReturnModal() {
        // Close modal button
        const closeBtn = document.getElementById('closeItemReturnModal');
        if (closeBtn) {
            closeBtn.addEventListener('click', hideItemReturnApprovalModal);
        }
        
        // Cancel button
        const cancelBtn = document.getElementById('cancelItemReturnBtn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', hideItemReturnApprovalModal);
        }
        
        // Confirm button
        const confirmBtn = document.getElementById('confirmItemReturnBtn');
        if (confirmBtn) {
            confirmBtn.addEventListener('click', confirmItemReturn);
        }
        
        // Approver code input - validate on input
        const codeInput = document.getElementById('approverCodeInput');
        if (codeInput) {
            // Only allow numbers
            codeInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 4);
                
                // Auto-validate when 4 digits are entered
                if (e.target.value.length === 4) {
                    validateApproverCode();
                } else {
                    // Hide info/error when code is incomplete
                    document.getElementById('approverInfo')?.classList.add('hidden');
                    document.getElementById('approverError')?.classList.add('hidden');
                    document.getElementById('confirmItemReturnBtn').disabled = true;
                }
            });
            
            // Validate on Enter key
            codeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && codeInput.value.length === 4) {
                    validateApproverCode().then(validation => {
                        if (validation.valid) {
                            confirmItemReturn();
                        }
                    });
                }
            });
        }
        
        // Close modal when clicking outside
        const modal = document.getElementById('itemReturnApprovalModal');
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target.id === 'itemReturnApprovalModal') {
                    hideItemReturnApprovalModal();
                }
            });
        }
    }

    // Initialize printer control buttons
    function initializePrinterControls() {
        // Printer setup button - show setup modal
        const printerSetupBtn = document.getElementById('printerSetupBtn');
        if (printerSetupBtn) {
            printerSetupBtn.addEventListener('click', () => {
                showPrinterSetupModal();
            });
        }
        
        // Return button - show return options
        const returnBtn = document.getElementById('returnBtn');
        if (returnBtn) {
            returnBtn.addEventListener('click', () => {
                showReturnOptions();
            });
        }
        
        // Confirm button - confirm current action
        const confirmBtn = document.getElementById('confirmBtn');
        if (confirmBtn) {
            confirmBtn.addEventListener('click', () => {
                handleConfirmAction();
            });
        }
        
        // Setup modal controls
        setupPrinterModalControls();
    }
    
    let pendingQrScannerMode = null; // Store the mode (confirm/return) after validation
    
    function showReturnOptions() {
        // Show validation modal first
        showQrEmployeeValidationModal('return');
    }
    
    function handleConfirmAction() {
        // Show validation modal first
        showQrEmployeeValidationModal('confirm');
    }
    
    function showQrEmployeeValidationModal(mode) {
        pendingQrScannerMode = mode;
        const modal = document.getElementById('qrEmployeeValidationModal');
        const title = modal.querySelector('h2');
        const subtitle = modal.querySelector('p');
        
        if (mode === 'confirm') {
            title.textContent = 'Confirm Receipt - Employee Validation';
            subtitle.textContent = 'Enter your 4-digit code to confirm receipts';
        } else {
            title.textContent = 'Return Items - Employee Validation';
            subtitle.textContent = 'Enter your 4-digit code to return items';
        }
        
        // Reset UI
        document.getElementById('qrEmployeeCodeInput').value = '';
        document.getElementById('qrValidationError').classList.add('hidden');
        document.getElementById('qrValidationInfo').classList.add('hidden');
        document.getElementById('validateQrEmployeeBtn').disabled = true;
        
        modal.classList.remove('hidden');
        document.getElementById('qrEmployeeCodeInput').focus();
    }
    
    function closeQrEmployeeValidationModal() {
        const modal = document.getElementById('qrEmployeeValidationModal');
        if (modal) {
            modal.classList.add('hidden');
        }
        // Don't clear pendingQrScannerMode here - it's needed for proceedToQrScanner
    }
    
    async function validateQrEmployeeCode() {
        const codeInput = document.getElementById('qrEmployeeCodeInput');
        if (!codeInput) return { valid: false };
        
        const code = codeInput.value.trim();
        const errorDiv = document.getElementById('qrValidationError');
        const infoDiv = document.getElementById('qrValidationInfo');
        const validateBtn = document.getElementById('validateQrEmployeeBtn');
        
        if (!code || code.length !== 4 || !/^\d{4}$/.test(code)) {
            if (errorDiv) {
                errorDiv.textContent = 'Please enter a valid 4-digit code';
                errorDiv.classList.remove('hidden');
            }
            if (infoDiv) infoDiv.classList.add('hidden');
            if (validateBtn) validateBtn.disabled = true;
            return { valid: false };
        }
        
        try {
            const response = await fetch('/employee/validate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ employee_code: code })
            });
            
            const data = await response.json();
            
            if (data.success && data.employee) {
                const employee = data.employee;
                const validRoles = ['cashier', 'admin', 'manager'];
                
                if (validRoles.includes(employee.role.toLowerCase())) {
                    // Valid employee with correct role - now log them in to set session
                    try {
                        // Log in the employee to set the Flask session
                        const loginResponse = await fetch('/api/employee/login-code', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ employee_code: code })
                        });
                        
                        const loginData = await loginResponse.json();
                        
                        if (loginData.success && loginData.employee) {
                            // Session is now set, update UI
                            const nameEl = document.getElementById('qrValidatedEmployeeName');
                            const roleEl = document.getElementById('qrValidatedEmployeeRole');
                            
                            if (nameEl) nameEl.textContent = loginData.employee.name;
                            if (roleEl) roleEl.textContent = `Role: ${loginData.employee.role.charAt(0).toUpperCase() + loginData.employee.role.slice(1)}`;
                            
                            if (errorDiv) errorDiv.classList.add('hidden');
                            if (infoDiv) infoDiv.classList.remove('hidden');
                            if (validateBtn) validateBtn.disabled = false;
                            
                            // Set currentEmployee for use in processReturn and confirmReceipt
                            currentEmployee = {
                                id: loginData.employee.id,
                                name: loginData.employee.name,
                                code: loginData.employee.code
                            };
                            
                            // Auto-proceed to QR scanner immediately after validation
                            console.log('Employee validated and logged in, proceeding to QR scanner. Mode:', pendingQrScannerMode);
                            proceedToQrScanner(loginData.employee);
                            
                            return { valid: true, employee: loginData.employee };
                        } else {
                            // Login failed
                            if (errorDiv) {
                                errorDiv.textContent = loginData.message || 'Failed to log in employee';
                                errorDiv.classList.remove('hidden');
                            }
                            if (infoDiv) infoDiv.classList.add('hidden');
                            if (validateBtn) validateBtn.disabled = true;
                            return { valid: false, message: loginData.message || 'Login failed' };
                        }
                    } catch (loginError) {
                        console.error('Error logging in employee:', loginError);
                        if (errorDiv) {
                            errorDiv.textContent = 'Error logging in. Please try again.';
                            errorDiv.classList.remove('hidden');
                        }
                        if (infoDiv) infoDiv.classList.add('hidden');
                        if (validateBtn) validateBtn.disabled = true;
                        return { valid: false, message: 'Login error' };
                    }
                } else {
                    // Invalid role
                    if (errorDiv) {
                        errorDiv.textContent = `Employee role "${employee.role}" is not authorized. Only Cashier, Admin, or Manager can access QR scanner.`;
                        errorDiv.classList.remove('hidden');
                    }
                    if (infoDiv) infoDiv.classList.add('hidden');
                    if (validateBtn) validateBtn.disabled = true;
                    return { valid: false, message: 'Invalid role' };
                }
            } else {
                // Invalid code
                if (errorDiv) {
                    errorDiv.textContent = data.message || 'Invalid employee code';
                    errorDiv.classList.remove('hidden');
                }
                if (infoDiv) infoDiv.classList.add('hidden');
                if (validateBtn) validateBtn.disabled = true;
                return { valid: false, message: data.message || 'Invalid code' };
            }
        } catch (error) {
            console.error('Error validating employee code:', error);
            if (errorDiv) {
                errorDiv.textContent = 'Error validating code. Please try again.';
                errorDiv.classList.remove('hidden');
            }
            if (infoDiv) infoDiv.classList.add('hidden');
            if (validateBtn) validateBtn.disabled = true;
            return { valid: false, message: 'Error validating code' };
        }
    }
    
    function proceedToQrScanner(validatedEmployee) {
        console.log('proceedToQrScanner called, pendingQrScannerMode:', pendingQrScannerMode);
        
        // Store the mode before closing modal
        const modeToOpen = pendingQrScannerMode;
        
        // Close validation modal
        const validationModal = document.getElementById('qrEmployeeValidationModal');
        if (validationModal) {
            validationModal.classList.add('hidden');
        }
        
        // Open QR scanner with the stored mode after a small delay to ensure modal is closed
        if (modeToOpen) {
            console.log('Opening QR scanner with mode:', modeToOpen);
            setTimeout(() => {
                openQRScanner(modeToOpen);
            }, 300);
        } else {
            console.error('No pending QR scanner mode found');
            showNotification('Error: No scanner mode specified', 'error');
        }
    }
    
    // QR Scanner functionality
    let qrScannerMode = null; // 'confirm' or 'return'
    let qrStream = null;
    let qrScanInterval = null;
    let currentScannedReceipt = null;
    
    function openQRScanner(mode) {
        console.log('openQRScanner called with mode:', mode);
        qrScannerMode = mode;
        const modal = document.getElementById('qrScannerModal');
        
        if (!modal) {
            console.error('QR Scanner modal not found');
            showNotification('QR Scanner modal not found. Please refresh the page.', 'error');
            return;
        }
        
        console.log('QR Scanner modal found, updating content');
        const title = document.getElementById('qrModalTitle');
        const subtitle = document.getElementById('qrModalSubtitle');
        
        if (title && subtitle) {
            if (mode === 'confirm') {
                title.textContent = 'Confirm Receipt - Scan QR Code';
                subtitle.textContent = 'Scan receipt QR code to confirm order status';
            } else {
                title.textContent = 'Return Items - Scan QR Code';
                subtitle.textContent = 'Scan receipt QR code to return items';
            }
        }
        
        // Reset UI
        const scannedDisplay = document.getElementById('scannedReceiptDisplay');
        const returnSelection = document.getElementById('returnItemsSelection');
        const confirmSection = document.getElementById('confirmReceiptSection');
        const manualInput = document.getElementById('manualReceiptInput');
        
        if (scannedDisplay) scannedDisplay.classList.add('hidden');
        if (returnSelection) returnSelection.classList.add('hidden');
        if (confirmSection) confirmSection.classList.add('hidden');
        if (manualInput) manualInput.value = '';
        
        // Show modal
        console.log('Showing QR scanner modal');
        modal.classList.remove('hidden');
        
        // Initialize QR scanner
        setTimeout(() => {
            initializeQRScanner();
        }, 100);
    }
    
    function closeQRScanner() {
        const modal = document.getElementById('qrScannerModal');
        modal.classList.add('hidden');
        
        // Stop camera
        stopQRScanner();
        
        // Reset state
        qrScannerMode = null;
        currentScannedReceipt = null;
    }
    
    function initializeQRScanner() {
        // Check if browser supports camera
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showCameraError();
            showNotification('Camera access not supported. Please use manual input.', 'warning');
            const manualInput = document.getElementById('manualReceiptInput');
            if (manualInput) manualInput.focus();
            return;
        }
        
        const video = document.getElementById('qrVideo');
        const canvas = document.getElementById('qrCanvas');
        const scanningOverlay = document.getElementById('qrScanningOverlay');
        const cameraError = document.getElementById('qrCameraError');
        
        if (!video || !canvas) {
            console.error('QR scanner elements not found');
            return;
        }
        
        // Hide error, show scanning overlay
        if (cameraError) cameraError.classList.add('hidden');
        if (scanningOverlay) scanningOverlay.classList.remove('hidden');
        
        const context = canvas.getContext('2d');
        
        // Request camera access with better constraints
        const constraints = {
            video: {
                facingMode: 'environment', // Use back camera on mobile
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };
        
        navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
            qrStream = stream;
            video.srcObject = stream;
            
            video.onloadedmetadata = () => {
                video.play();
                startQRCodeScanning(video, canvas, context);
                showNotification('Camera activated. Position QR code in the frame.', 'success');
            };
        })
        .catch(error => {
            console.error('Error accessing camera:', error);
            showCameraError();
            let errorMessage = 'Could not access camera. ';
            if (error.name === 'NotAllowedError') {
                errorMessage += 'Please allow camera access in your browser settings.';
            } else if (error.name === 'NotFoundError') {
                errorMessage += 'No camera found on this device.';
            } else {
                errorMessage += 'Please use manual input.';
            }
            showNotification(errorMessage, 'warning');
            const manualInput = document.getElementById('manualReceiptInput');
            if (manualInput) {
                manualInput.focus();
                // Show manual input section
                const manualSection = document.getElementById('manualInputSection');
                if (manualSection) manualSection.classList.remove('hidden');
            }
        });
    }
    
    function showCameraError() {
        const scanningOverlay = document.getElementById('qrScanningOverlay');
        const cameraError = document.getElementById('qrCameraError');
        if (scanningOverlay) scanningOverlay.classList.add('hidden');
        if (cameraError) cameraError.classList.remove('hidden');
    }
    
    function startQRCodeScanning(video, canvas, context) {
        // Check if jsQR library is loaded
        if (typeof jsQR === 'undefined') {
            console.warn('jsQR library not loaded, using manual input only');
            return;
        }
        
        function scanQRCode() {
            // Check if video is ready and stream is active
            if (!qrStream || !qrStream.active) {
                console.log('QR stream not active, stopping scan');
                return;
            }
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                try {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        console.log('QR Code detected:', code.data);
                        // Stop scanning
                        stopQRScanner();
                        
                        // Process the scanned QR code
                        processReceiptInput(code.data);
                        return; // Don't continue scanning after detection
                    }
                } catch (error) {
                    console.error('Error during QR scan:', error);
                }
            }
            
            // Continue scanning if stream is still active
            if (qrStream && qrStream.active) {
                requestAnimationFrame(scanQRCode);
            }
        }
        
        // Start scanning loop
        scanQRCode();
    }
    
    function stopQRScanner() {
        if (qrScanInterval) {
            clearInterval(qrScanInterval);
            qrScanInterval = null;
        }
        
        if (qrStream) {
            qrStream.getTracks().forEach(track => track.stop());
            qrStream = null;
        }
        
        const video = document.getElementById('qrVideo');
        if (video.srcObject) {
            video.srcObject = null;
        }
    }
    
    function extractReceiptIdentifierFromUrl(url) {
        // Extract receipt identifier from URL like: http://domain/receipt/123 or /receipt/POS0001
        // Try to match /receipt/ followed by either a number or alphanumeric (receipt number)
        const match = url.match(/\/receipt\/([^\/\?#]+)/);
        if (match && match[1]) {
            return match[1]; // Return the identifier (could be ID or receipt_number)
        }
        
        // If it's just a number, return it as string (will be parsed as ID)
        const num = parseInt(url);
        if (!isNaN(num)) {
            return num.toString();
        }
        
        // If it contains letters (like POS0001), return as is
        if (/[a-zA-Z]/.test(url)) {
            return url.trim();
        }
        
        // If it's just digits, return as string
        if (/^\d+$/.test(url.trim())) {
            return url.trim();
        }
        
        return null;
    }
    
    async function processReceiptInput(input) {
        const receiptIdentifier = extractReceiptIdentifierFromUrl(input);
        if (!receiptIdentifier) {
            showNotification('Invalid receipt URL, ID, or receipt number. Format: /receipt/123, /receipt/POS0001, or just the ID/number', 'error');
            return;
        }
        
        try {
            let data;
            
            // Check if identifier is a number (receipt ID) or string (receipt number)
            const isNumeric = /^\d+$/.test(receiptIdentifier);
            
            if (isNumeric) {
                // Try to fetch by receipt ID
                const response = await fetch(`/api/receipts/${encodeURIComponent(receiptIdentifier)}`);
                data = await response.json();
            } else {
                // It's a receipt number, fetch by receipt_number parameter
                const response = await fetch(`/api/receipts?receipt_number=${encodeURIComponent(receiptIdentifier)}`);
                const listData = await response.json();
                
                if (listData.success && listData.receipts && listData.receipts.length > 0) {
                    // Find exact match
                    const receipt = listData.receipts.find(r => 
                        String(r.receipt_number) === String(receiptIdentifier)
                    ) || listData.receipts[0];
                    
                    if (receipt && receipt.id) {
                        // Now fetch full details using the ID
                        const detailResponse = await fetch(`/api/receipts/${receipt.id}`);
                        data = await detailResponse.json();
                    } else {
                        data = { success: false, message: 'Receipt not found' };
                    }
                } else {
                    data = { success: false, message: 'Receipt not found' };
                }
            }
            
            if (data.success && data.receipt) {
                currentScannedReceipt = data;
                displayScannedReceipt(data);
                
                if (qrScannerMode === 'return') {
                    // For return mode, show items for selection
                    displayReturnItems(data.items);
                } else if (qrScannerMode === 'confirm') {
                    // For confirm mode, automatically confirm the receipt
                    console.log('Auto-confirming receipt after scan...');
                    // Show a brief loading message
                    const detailsDiv = document.getElementById('receiptDetails');
                    if (detailsDiv) {
                        detailsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-600 text-2xl mb-2"></i><p class="text-gray-700">Confirming receipt...</p></div>';
                    }
                    // Check if receipt is already confirmed
                    const isConfirmed = data.receipt.status === 'confirmed' || 
                                       data.receipt.status === 'Confirmed' ||
                                       (data.receipt.cashier_confirmed === 1 || data.receipt.cashier_confirmed === true);
                    
                    if (isConfirmed && data.receipt.status === 'confirmed') {
                        showNotification(`Receipt ${data.receipt.receipt_number} is already confirmed!`, 'info');
                        setTimeout(() => {
                            closeQRScanner();
                        }, 2000);
                    } else {
                        // Automatically confirm after a brief delay to show the receipt was found
                        setTimeout(() => {
                            confirmReceipt();
                        }, 500);
                    }
                } else {
                    displayConfirmSection(data);
                }
            } else {
                showNotification(data.message || 'Receipt not found', 'error');
            }
        } catch (error) {
            console.error('Error fetching receipt:', error);
            showNotification('Error fetching receipt details: ' + (error.message || 'Unknown error'), 'error');
        }
    }
    
    function displayScannedReceipt(receiptData) {
        const receipt = receiptData.receipt;
        const detailsDiv = document.getElementById('receiptDetails');
        
        const statusClass = receipt.status === 'completed' ? 'text-green-600' : 
                           receipt.status === 'confirmed' ? 'text-blue-600' : 'text-orange-600';
        
        detailsDiv.innerHTML = `
            <div class="space-y-2">
                <p><strong>Receipt Number:</strong> ${receipt.receipt_number}</p>
                <p><strong>Employee:</strong> ${receipt.employee_name}</p>
                <p><strong>Date:</strong> ${new Date(receipt.sale_date).toLocaleString()}</p>
                <p><strong>Subtotal:</strong> KSh ${parseFloat(receipt.subtotal || 0).toFixed(2)}</p>
                <p><strong>Tax:</strong> KSh ${parseFloat(receipt.tax_amount || 0).toFixed(2)}</p>
                <p><strong>Total:</strong> KSh ${parseFloat(receipt.total_amount || 0).toFixed(2)}</p>
                <p><strong>Status:</strong> <span class="font-semibold ${statusClass}">${receipt.status || 'pending'}</span></p>
            </div>
        `;
        
        document.getElementById('scannedReceiptDisplay').classList.remove('hidden');
    }
    
    function displayReturnItems(items) {
        const itemsListDiv = document.getElementById('returnItemsList');
        itemsListDiv.innerHTML = '';
        
        if (!items || items.length === 0) {
            itemsListDiv.innerHTML = '<p class="text-gray-500 text-center py-4">No items found in this receipt</p>';
            return;
        }
        
        items.forEach((item, index) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'bg-white border-2 border-gray-200 rounded-lg p-4';
            itemDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800">${item.item_name}</p>
                        <p class="text-sm text-gray-600">Qty: ${item.quantity} × KSh ${parseFloat(item.unit_price || 0).toFixed(2)}</p>
                        <p class="text-sm text-gray-600">Total: KSh ${parseFloat(item.total_price || 0).toFixed(2)}</p>
                    </div>
                    <div class="ml-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" class="return-item-checkbox w-5 h-5 text-orange-600 rounded focus:ring-orange-500" 
                                   data-item-id="${item.id || item.sales_item_id || item.item_id || index}" 
                                   data-item-name="${item.item_name}"
                                   data-quantity="${item.quantity}"
                                   data-unit-price="${item.unit_price || 0}">
                            <span class="ml-2 text-sm text-gray-700">Return</span>
                        </label>
                    </div>
                </div>
            `;
            itemsListDiv.appendChild(itemDiv);
        });
        
        // Enable/disable process button based on selection
        const checkboxes = itemsListDiv.querySelectorAll('.return-item-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const hasSelection = Array.from(checkboxes).some(cb => cb.checked);
                document.getElementById('processReturnBtn').disabled = !hasSelection;
            });
        });
        
        document.getElementById('returnItemsSelection').classList.remove('hidden');
    }
    
    function displayConfirmSection(receiptData) {
        document.getElementById('confirmReceiptSection').classList.remove('hidden');
    }
    
    async function processReturn() {
        const checkboxes = document.querySelectorAll('.return-item-checkbox:checked');
        if (checkboxes.length === 0) {
            showNotification('Please select at least one item to return', 'error');
            return;
        }
        
        const itemsToReturn = Array.from(checkboxes).map(cb => ({
            item_id: cb.dataset.itemId || parseInt(cb.dataset.itemId), // Use sales_item.id
            item_name: cb.dataset.itemName,
            quantity: parseInt(cb.dataset.quantity),
            unit_price: parseFloat(cb.dataset.unitPrice)
        }));
        
        if (!currentScannedReceipt || !currentScannedReceipt.receipt) {
            showNotification('Receipt data not found', 'error');
            return;
        }
        
        if (!currentEmployee || !currentEmployee.id) {
            showNotification('Employee session not found. Please validate your employee code again.', 'error');
            return;
        }
        
        const saleId = currentScannedReceipt.receipt.id;
        const processBtn = document.getElementById('processReturnBtn');
        processBtn.disabled = true;
        processBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        
        try {
            // Use the new receipts return-items API
            const response = await fetch('/api/receipts/return-items', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    receipt_id: saleId,
                    items: itemsToReturn.map(item => ({
                        item_id: item.item_id,
                        quantity: item.quantity,
                        item_name: item.item_name,
                        unit_price: item.unit_price
                    }))
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showNotification(`Successfully returned ${itemsToReturn.length} item(s)${data.restocked_items && data.restocked_items.length > 0 ? ' and restocked inventory' : ''}`, 'success');
                closeQRScanner();
            } else {
                showNotification(data.message || 'Failed to process return', 'error');
                processBtn.disabled = false;
                processBtn.innerHTML = '<i class="fas fa-undo mr-2"></i>Process Return';
            }
        } catch (error) {
            console.error('Error processing return:', error);
            showNotification('Error processing return', 'error');
            processBtn.disabled = false;
            processBtn.innerHTML = '<i class="fas fa-undo mr-2"></i>Process Return';
        }
    }
    
    async function confirmReceipt() {
        if (!currentScannedReceipt || !currentScannedReceipt.receipt) {
            showNotification('Receipt data not found', 'error');
            return;
        }
        
        if (!currentEmployee || !currentEmployee.id) {
            showNotification('Employee session not found. Please validate your employee code again.', 'error');
            return;
        }
        
        const saleId = currentScannedReceipt.receipt.id;
        const receiptNumber = currentScannedReceipt.receipt.receipt_number;
        
        // Update UI to show confirming state
        const detailsDiv = document.getElementById('receiptDetails');
        if (detailsDiv) {
            detailsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-blue-600 text-2xl mb-2"></i><p class="text-gray-700">Confirming receipt...</p></div>';
        }
        
        const confirmBtn = document.getElementById('confirmReceiptBtn');
        if (confirmBtn) {
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Confirming...';
        }
        
        try {
            // First, ensure status is set to 'confirmed' (this is the main requirement)
            const statusResponse = await fetch('/api/receipts/update-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    receipt_ids: [saleId],
                    status: 'confirmed'
                })
            });
            const statusData = await statusResponse.json();
            
            // Then, also set cashier_confirmed
            const confirmResponse = await fetch(`/api/receipts/${saleId}/confirm`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const confirmData = await confirmResponse.json();
            
            // Check if status update was successful (this is the critical one)
            if (statusData.success) {
                // Status update succeeded
                
                // Show success message with receipt number
                showNotification(`Receipt ${receiptNumber} confirmed successfully! Status updated to confirmed.`, 'success');
                
                // Update the receipt details display to show confirmed status
                if (detailsDiv) {
                    detailsDiv.innerHTML = `
                        <div class="text-center py-4 space-y-2">
                            <i class="fas fa-check-circle text-green-600 text-4xl mb-2"></i>
                            <p class="text-green-600 font-semibold text-lg">Receipt Confirmed!</p>
                            <p class="text-gray-700">Receipt Number: ${receiptNumber}</p>
                            <p class="text-gray-600 text-sm">Status: <span class="font-semibold text-green-600">Confirmed</span></p>
                        </div>
                    `;
                }
                
                // Update the current receipt data to reflect confirmed status
                if (currentScannedReceipt && currentScannedReceipt.receipt) {
                    currentScannedReceipt.receipt.status = 'confirmed';
                    currentScannedReceipt.receipt.cashier_confirmed = 1;
                }
                
                // Close scanner after a brief delay to show success
                setTimeout(() => {
                    closeQRScanner();
                }, 2000);
            } else {
                showNotification(statusData.message || 'Failed to confirm receipt', 'error');
                // Restore receipt display
                if (currentScannedReceipt) {
                    displayScannedReceipt(currentScannedReceipt);
                }
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Confirm Receipt';
                }
            }
        } catch (error) {
            console.error('Error confirming receipt:', error);
            showNotification('Error confirming receipt', 'error');
            // Restore receipt display
            if (currentScannedReceipt) {
                displayScannedReceipt(currentScannedReceipt);
            }
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Confirm Receipt';
            }
        }
    }
    
    // Setup QR scanner event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // QR Validation Modal listeners
        const closeQrValidationBtn = document.getElementById('closeQrValidationModal');
        if (closeQrValidationBtn) {
            closeQrValidationBtn.addEventListener('click', closeQrEmployeeValidationModal);
        }
        
        const cancelQrValidationBtn = document.getElementById('cancelQrValidationBtn');
        if (cancelQrValidationBtn) {
            cancelQrValidationBtn.addEventListener('click', closeQrEmployeeValidationModal);
        }
        
        // Use event delegation for QR validation input (works even when modal is shown dynamically)
        document.addEventListener('input', function(e) {
            if (e.target && e.target.id === 'qrEmployeeCodeInput') {
                const input = e.target;
                input.value = input.value.replace(/\D/g, '').slice(0, 4);
                const errorDiv = document.getElementById('qrValidationError');
                const infoDiv = document.getElementById('qrValidationInfo');
                const validateBtn = document.getElementById('validateQrEmployeeBtn');
                
                if (errorDiv) errorDiv.classList.add('hidden');
                if (infoDiv) infoDiv.classList.add('hidden');
                if (validateBtn) validateBtn.disabled = true;
                
                // Live validate when 4 digits are entered
                if (input.value.length === 4) {
                    validateQrEmployeeCode();
                }
            }
        });
        
        // Enter key listener for QR validation
        document.addEventListener('keypress', function(e) {
            if (e.target && e.target.id === 'qrEmployeeCodeInput' && e.key === 'Enter') {
                const input = e.target;
                if (input.value.length === 4) {
                    validateQrEmployeeCode();
                }
            }
        });
        
        // QR Scanner Modal listeners
        const closeBtn = document.getElementById('closeQrScanner');
        if (closeBtn) {
            closeBtn.addEventListener('click', closeQRScanner);
        }
        
        const processManualBtn = document.getElementById('processManualInput');
        if (processManualBtn) {
            processManualBtn.addEventListener('click', () => {
                const input = document.getElementById('manualReceiptInput').value.trim();
                if (input) {
                    processReceiptInput(input);
                }
            });
        }
        
        const manualInput = document.getElementById('manualReceiptInput');
        if (manualInput) {
            manualInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const input = manualInput.value.trim();
                    if (input) {
                        processReceiptInput(input);
                    }
                }
            });
        }
        
        const processReturnBtn = document.getElementById('processReturnBtn');
        if (processReturnBtn) {
            processReturnBtn.addEventListener('click', processReturn);
        }
        
        const confirmReceiptBtn = document.getElementById('confirmReceiptBtn');
        if (confirmReceiptBtn) {
            confirmReceiptBtn.addEventListener('click', confirmReceipt);
        }
    });

    // Track if modal controls are already set up to prevent duplicate listeners
    let printerModalControlsSetup = false;

    // Setup printer modal controls
    function setupPrinterModalControls() {
        if (printerModalControlsSetup) {
            return;
        }
        printerModalControlsSetup = true;

        // Close modal button
        const closeBtn = document.getElementById('closePrinterSetup');
        if (closeBtn && !closeBtn.hasAttribute('data-listener-attached')) {
            closeBtn.setAttribute('data-listener-attached', 'true');
            closeBtn.addEventListener('click', () => {
                // hidePrinterSetupModal will check if printer connection is required
                hidePrinterSetupModal();
            });
        }

        // Close modal when clicking outside (only if not required)
        const modal = document.getElementById('printerSetupModal');
        if (modal && !modal.hasAttribute('data-listener-attached')) {
            modal.setAttribute('data-listener-attached', 'true');
            modal.addEventListener('click', (e) => {
                if (e.target.id === 'printerSetupModal') {
                    // Only allow closing if printer connection is not required
                    if (!printerConnectionRequired) {
                        hidePrinterSetupModal();
                    } else {
                        // Show warning if trying to close when required
                        showNotification('⚠️ You must connect a printer before proceeding. Please connect a printer first.', 'warning');
                    }
                }
            });
        }

        // Scan for printers button
        const scanPrintersBtn = document.getElementById('scan-printers');
        if (scanPrintersBtn && !scanPrintersBtn.hasAttribute('data-listener-attached')) {
            scanPrintersBtn.setAttribute('data-listener-attached', 'true');
            scanPrintersBtn.addEventListener('click', async () => {
                const printerType = document.querySelector('input[name="printer-type"]:checked')?.value;
                if (!printerType) {
                    showNotification('Please select a printer type first', 'error');
                    return;
                }
                
                const printersList = document.getElementById('printers-list');
                scanPrintersBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Scanning...';
                scanPrintersBtn.disabled = true;
                if (printersList) {
                    printersList.innerHTML = '<div class="text-center py-4 text-gray-600">Scanning for printers...</div>';
                }
                
                try {
                    const printers = await scanForPrinters(printerType);
                    displayAvailablePrinters(printers);
                } catch (error) {
                    console.error('Error scanning for printers:', error);
                    if (printersList) {
                        printersList.innerHTML = `<div class="text-center py-4 text-red-600">${error.message || 'Scan failed'}</div>`;
                    }
                    showNotification(error.message || 'Failed to scan for printers', 'error');
                } finally {
                    scanPrintersBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Scan for Printers';
                    scanPrintersBtn.disabled = false;
                }
            });
        }

        // Manual printer connection button
        const connectManualBtn = document.getElementById('connect-manual-printer');
        if (connectManualBtn && !connectManualBtn.hasAttribute('data-listener-attached')) {
            connectManualBtn.setAttribute('data-listener-attached', 'true');
            connectManualBtn.addEventListener('click', async () => {
                const printerName = document.getElementById('printer-name')?.value.trim();
                const printerIp = document.getElementById('printer-ip')?.value.trim();
                const printerPort = document.getElementById('printer-port')?.value.trim() || '9100';
                const printerType = document.querySelector('input[name="printer-type"]:checked')?.value;
                
                if (!printerName || !printerIp || !printerType) {
                    showNotification('Please fill in all printer details', 'error');
                    return;
                }
                
                if (printerType === 'wifi') {
                    // Connect to WiFi printer
                    if (window.wifiPrinterManager) {
                        try {
                            const printerId = window.wifiPrinterManager.addPrinter(printerName, printerIp, parseInt(printerPort));
                            const success = await window.wifiPrinterManager.connectPrinter(printerId);
                            if (success) {
                                showNotification(`Connected to ${printerName}`, 'success');
                                updatePrinterStatus();
                                // Close modal (will check if required mode and allow if printer is connected)
                                hidePrinterSetupModal();
                            } else {
                                showNotification('Failed to connect to printer', 'error');
                            }
                        } catch (error) {
                            showNotification('Error connecting to printer: ' + error.message, 'error');
                        }
                    } else {
                        showNotification('WiFi printer manager not available', 'error');
                    }
                } else if (printerType === 'usb') {
                    showNotification('USB printers must be connected via scan. Please use the "Scan for Printers" button.', 'info');
                } else {
                    showNotification('Bluetooth manual connection not supported. Please use scan.', 'error');
                }
            });
        }
        
        // Disconnect printer button
        const disconnectBtn = document.getElementById('disconnect-printer');
        if (disconnectBtn && !disconnectBtn.hasAttribute('data-listener-attached')) {
            disconnectBtn.setAttribute('data-listener-attached', 'true');
            disconnectBtn.addEventListener('click', async () => {
                try {
                    let disconnected = false;
                    let disconnectCount = 0;
                    
                    // First, try unified printer manager (if available)
                    if (window.unifiedPrinterManager && typeof window.unifiedPrinterManager.disconnectAllPrinters === 'function') {
                        try {
                            await window.unifiedPrinterManager.disconnectAllPrinters();
                            disconnected = true;
                            disconnectCount++;
                            console.log('Disconnected printers via unified manager');
                        } catch (e) {
                            console.warn('Error disconnecting via unified manager:', e);
                        }
                    }
                    
                    // Disconnect Bluetooth printers
                    if (window.bluetoothPrinterManager && typeof window.bluetoothPrinterManager.disconnectAllPrinters === 'function') {
                        try {
                            const bluetoothPrinters = window.bluetoothPrinterManager.getConnectedPrinters();
                            if (bluetoothPrinters && bluetoothPrinters.length > 0) {
                                window.bluetoothPrinterManager.disconnectAllPrinters();
                                disconnected = true;
                                disconnectCount += bluetoothPrinters.length;
                                console.log(`Disconnected ${bluetoothPrinters.length} Bluetooth printer(s)`);
                            }
                        } catch (e) {
                            console.warn('Error disconnecting Bluetooth printers:', e);
                        }
                    }
                    
                    // Disconnect WiFi printers (standard)
                    if (window.wifiPrinterManager) {
                        try {
                            // Check if getConnectedPrinters exists and is a function
                            if (typeof window.wifiPrinterManager.getConnectedPrinters === 'function') {
                                const wifiPrinters = window.wifiPrinterManager.getConnectedPrinters();
                                if (wifiPrinters && Array.isArray(wifiPrinters) && wifiPrinters.length > 0) {
                                    // Use disconnectAllPrinters if available, otherwise disconnect individually
                                    if (typeof window.wifiPrinterManager.disconnectAllPrinters === 'function') {
                                        const disconnectedCount = window.wifiPrinterManager.disconnectAllPrinters();
                                        if (disconnectedCount > 0) {
                                            disconnected = true;
                                            disconnectCount += disconnectedCount;
                                            console.log(`Disconnected ${disconnectedCount} WiFi printer(s)`);
                                        }
                                    } else {
                                        // Fallback: disconnect individually
                                        let individualCount = 0;
                                        for (const printer of wifiPrinters) {
                                            if (printer && printer.id) {
                                                try {
                                                    const result = window.wifiPrinterManager.disconnectPrinter(printer.id);
                                                    if (result !== false) {
                                                        individualCount++;
                                                    }
                                                } catch (e) {
                                                    console.warn(`Error disconnecting WiFi printer ${printer.id}:`, e);
                                                }
                                            }
                                        }
                                        if (individualCount > 0) {
                                            disconnected = true;
                                            disconnectCount += individualCount;
                                            console.log(`Disconnected ${individualCount} WiFi printer(s) individually`);
                                        }
                                    }
                                } else {
                                    console.log('No WiFi printers connected to disconnect');
                                }
                            } else {
                                console.warn('WiFi printer manager getConnectedPrinters method not available');
                            }
                        } catch (e) {
                            console.warn('Error disconnecting WiFi printers:', e);
                            // Continue with other printer types even if WiFi fails
                        }
                    }
                    
                    // Disconnect WiFi thermal printers (if separate manager exists)
                    if (window.wifiThermalPrinterManager) {
                        try {
                            const thermalPrinters = window.wifiThermalPrinterManager.getConnectedPrinters();
                            if (thermalPrinters && thermalPrinters.length > 0) {
                                for (const printer of thermalPrinters) {
                                    if (printer && printer.id) {
                                        try {
                                            await window.wifiThermalPrinterManager.disconnectThermalPrinter(printer.id);
                                        } catch (e) {
                                            console.warn(`Error disconnecting thermal printer ${printer.id}:`, e);
                                        }
                                    }
                                }
                                disconnected = true;
                                disconnectCount += thermalPrinters.length;
                                console.log(`Disconnected ${thermalPrinters.length} WiFi thermal printer(s)`);
                            }
                        } catch (e) {
                            console.warn('Error disconnecting WiFi thermal printers:', e);
                        }
                    }
                    
                    // Disconnect USB printers
                    if (window.usbPrinterManager && typeof window.usbPrinterManager.disconnectAll === 'function') {
                        try {
                            const usbPrinters = window.usbPrinterManager.getConnectedPrinters();
                            if (usbPrinters && usbPrinters.length > 0) {
                                await window.usbPrinterManager.disconnectAll();
                                disconnected = true;
                                disconnectCount += usbPrinters.length;
                                console.log(`Disconnected ${usbPrinters.length} USB printer(s)`);
                            }
                        } catch (e) {
                            console.warn('Error disconnecting USB printers:', e);
                        }
                    }
                    
                    // Update UI
                    updatePrinterStatus();
                    
                    if (disconnected && disconnectCount > 0) {
                        showNotification(`Successfully disconnected ${disconnectCount} printer(s)`, 'success');
                        // Don't close modal if printer connection is required (user just disconnected)
                        if (!printerConnectionRequired) {
                            hidePrinterSetupModal();
                        } else {
                            showNotification('⚠️ Printer connection is required. Please connect a printer to proceed.', 'warning');
                        }
                    } else {
                        showNotification('No printers connected to disconnect', 'info');
                    }
                } catch (error) {
                    console.error('Error disconnecting printers:', error);
                    showNotification('Error disconnecting printers: ' + (error.message || 'Unknown error'), 'error');
                }
            });
        }
        
        // Show/hide manual connection section and USB info based on printer type
        const printerTypeRadios = document.querySelectorAll('input[name="printer-type"]');
        const manualSection = document.getElementById('manualSection');
        const usbInfoSection = document.getElementById('usbInfoSection');
        
        printerTypeRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (manualSection) {
                    if (radio.value === 'wifi') {
                        manualSection.classList.remove('hidden');
                    } else {
                        manualSection.classList.add('hidden');
                    }
                }
                
                if (usbInfoSection) {
                    if (radio.value === 'usb') {
                        usbInfoSection.classList.remove('hidden');
                    } else {
                        usbInfoSection.classList.add('hidden');
                    }
                }
            });
        });
    }

    // Track if printer connection is required (non-dismissible mode)
    let printerConnectionRequired = false;

    // Show printer setup modal
    function showPrinterSetupModal(required = false) {
        const modal = document.getElementById('printerSetupModal');
        const warningDiv = document.getElementById('requiredPrinterWarning');
        const closeBtn = document.getElementById('closePrinterSetup');
        
        if (modal) {
            printerConnectionRequired = required;
            
            // Show/hide warning message
            if (warningDiv) {
                if (required) {
                    warningDiv.classList.remove('hidden');
                } else {
                    warningDiv.classList.add('hidden');
                }
            }
            
            // Disable/enable close button
            if (closeBtn) {
                if (required) {
                    closeBtn.style.display = 'none'; // Hide close button when required
                } else {
                    closeBtn.style.display = 'block'; // Show close button when optional
                }
            }
            
            modal.classList.remove('hidden');
        }
    }

    // Hide printer setup modal (only if printer is connected when required)
    function hidePrinterSetupModal() {
        // If printer connection is required, check if printer is connected before allowing close
        if (printerConnectionRequired) {
            if (!isPrinterConnected()) {
                showNotification('⚠️ You must connect a printer before proceeding. Please connect a printer first.', 'warning');
                return; // Prevent closing if printer is not connected
            }
            // Printer is connected, allow closing and reset the flag
            printerConnectionRequired = false;
        }
        
        const modal = document.getElementById('printerSetupModal');
        const warningDiv = document.getElementById('requiredPrinterWarning');
        
        if (modal) {
            modal.classList.add('hidden');
        }
        
        // Hide warning when modal closes
        if (warningDiv) {
            warningDiv.classList.add('hidden');
        }
    }

    // Display available printers
    function displayAvailablePrinters(printers) {
        const printersList = document.getElementById('printers-list');
        if (!printersList) return;
        
        if (!printers || printers.length === 0) {
            printersList.innerHTML = '<div class="text-center py-4 text-gray-600">No printers found. Try manual setup.</div>';
            return;
        }
        
        // Store printers globally for connection
        window.scannedPrinters = printers;
        window.lastScannedPrinters = printers;
        
        printersList.innerHTML = printers.map((printer, index) => `
            <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 mb-2">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">${printer.name || 'Unknown Printer'}</div>
                        ${printer.ip ? `<div class="text-sm text-gray-600">IP: ${printer.ip}:${printer.port || 9100}</div>` : ''}
                        ${printer.type ? `<div class="text-xs text-gray-500">Type: ${printer.type}</div>` : ''}
                    </div>
                    <button onclick="connectToScannedPrinter(${index})" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition-colors ml-3">
                        <i class="fas fa-link mr-1"></i>Connect
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Universal scanForPrinters function
    async function scanForPrinters(printerType) {
        console.log('scanForPrinters called with type:', printerType);
        
        if (printerType === 'bluetooth') {
            // For Bluetooth, we need to trigger the device selection
            // Web Bluetooth API doesn't allow scanning - only device selection
            await scanForBluetoothPrinters();
            // Return empty array as Bluetooth requires user interaction
            return [];
        } else if (printerType === 'wifi') {
            // Use WiFi scanning function and return results
            return await scanForWiFiPrinters();
        } else if (printerType === 'usb') {
            // Use USB scanning function and return results
            return await scanForUSBPrinters();
        } else {
            throw new Error('Invalid printer type');
        }
    }
    
    // USB printer scanning function
    async function scanForUSBPrinters() {
        try {
            if (!window.usbPrinterManager) {
                throw new Error('USB printer manager not available. Please refresh the page.');
            }

            if (!window.usbPrinterManager.isSupported()) {
                throw new Error('WebUSB is not supported in this browser. Please use Chrome, Edge, or Opera.');
            }

            showNotification('Select a USB printer from the device list...', 'info');
            
            const printers = await window.usbPrinterManager.scanForPrinters();
            
            if (printers && printers.length > 0) {
                showNotification(`Found ${printers.length} USB printer(s)!`, 'success');
                return printers;
            } else {
                showNotification('No USB printers found', 'warning');
                return [];
            }
        } catch (error) {
            console.error('USB scanning error:', error);
            if (error.name === 'NotFoundError') {
                showNotification('No USB device selected', 'warning');
            } else if (error.name === 'SecurityError') {
                showNotification('USB permission denied. Please allow USB access in your browser settings.', 'error');
            } else {
                showNotification('USB scan failed: ' + error.message, 'error');
            }
            return [];
        }
    }

    // WiFi printer scanning function
    async function scanForWiFiPrinters() {
        try {
            showNotification('Scanning for thermal printers on network...', 'info');
            
            // Check if we're in a hosted environment
            const isHosted = window.location.hostname.includes('mmuchafua.co.ke') || 
                            window.location.hostname.includes('github.io') || 
                            window.location.hostname.includes('netlify.app') ||
                            window.location.hostname.includes('vercel.app') ||
                            window.location.hostname.includes('herokuapp.com') ||
                            window.location.hostname.includes('railway.app') ||
                            window.location.hostname.includes('render.com') ||
                            window.location.hostname.includes('fly.dev') ||
                            window.location.hostname.includes('aws.amazon.com') ||
                            window.location.hostname.includes('azure.com') ||
                            window.location.hostname.includes('digitalocean.com') ||
                            (window.location.hostname !== 'localhost' && 
                             window.location.hostname !== '127.0.0.1' &&
                             !window.location.hostname.match(/^\d+\.\d+\.\d+\.\d+$/));
            
            if (isHosted) {
                console.log('Hosted environment detected, using client-side scanning approach');
                // For hosted environments, use client-side scanning
                const printers = await performClientSideWiFiScan();
                return printers || [];
            } else {
                // Use server-side scanning for local environments
                return await performServerSideWiFiScan();
            }
        } catch (error) {
            console.error('WiFi scanning error:', error);
            showNotification('WiFi scanning failed: ' + error.message, 'error');
            return [];
        }
    }

    // Server-side WiFi scanning with local agent support
    async function performServerSideWiFiScan() {
        try {
            // Check if we're in cPanel environment
            const isCPanel = window.location.hostname.includes('cpanel') || 
                           window.location.hostname.includes('shared') ||
                           window.location.hostname.includes('hosting');
            
            // Try to get latest agent scan results first if in cPanel
            if (isCPanel) {
                try {
                    showNotification('Checking for local agent scan results...', 'info');
                    // First, try to get existing scan results
                    const agentResultsResponse = await fetch('/api/agent/scan-results', {
                        method: 'GET'
                    });
                    
                    if (agentResultsResponse.ok) {
                        const agentResults = await agentResultsResponse.json();
                        if (agentResults.success && agentResults.results && agentResults.results.printers && agentResults.results.printers.length > 0) {
                            console.log('Agent scan results found:', agentResults.results.printers);
                            const formattedPrinters = agentResults.results.printers.map(printer => ({
                                name: printer.name || `Printer at ${printer.ip}:${printer.port}`,
                                ip: printer.ip,
                                port: printer.port || 9100,
                                type: 'wifi',
                                model: printer.model || 'Thermal Printer',
                                discovery_method: 'Local Agent'
                            }));
                            showNotification(`Found ${formattedPrinters.length} printer(s) via local agent!`, 'success');
                            return formattedPrinters;
                        }
                    }
                    
                    // If no results, trigger a new scan
                    showNotification('Triggering local agent scan for cPanel...', 'info');
                    const agentResponse = await fetch('/api/agent/trigger-scan', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ network_range: '192.168.1' })
                    });
                    
                    if (agentResponse.ok) {
                        const agentData = await agentResponse.json();
                        if (agentData.success) {
                            // Wait a bit for scan to complete, then fetch results
                            await new Promise(resolve => setTimeout(resolve, 3000));
                            const resultsResponse = await fetch('/api/agent/scan-results');
                            if (resultsResponse.ok) {
                                const results = await resultsResponse.json();
                                if (results.success && results.results && results.results.printers && results.results.printers.length > 0) {
                                    const formattedPrinters = results.results.printers.map(printer => ({
                                        name: printer.name || `Printer at ${printer.ip}:${printer.port}`,
                                        ip: printer.ip,
                                        port: printer.port || 9100,
                                        type: 'wifi',
                                        model: printer.model || 'Thermal Printer',
                                        discovery_method: 'Local Agent'
                                    }));
                                    showNotification(`Found ${formattedPrinters.length} printer(s) via local agent!`, 'success');
                                    return formattedPrinters;
                                }
                            }
                        }
                    }
                } catch (agentError) {
                    console.warn('Agent scan failed, falling back to API scan:', agentError);
                }
            }
            
            const apiUrl = `${window.location.protocol}//${window.location.host}/api/scan-thermal-printers`;
            console.log('Calling thermal printer scan API:', apiUrl);
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Scan response data:', data);
            
            if (data.success) {
                // Only use real printers from the scan - NO dummy data
                if (data.printers && data.printers.length > 0) {
                    // Format printers for display - these are REAL printers found on network
                    const formattedPrinters = data.printers.map(printer => ({
                        name: printer.name || `Printer at ${printer.ip}:${printer.port}`,
                        ip: printer.ip,
                        port: printer.port || 9100,
                        type: 'wifi',
                        model: printer.model || 'ESC/POS Thermal Printer',
                        discovery_method: printer.discovery_method || 'Network Scan'
                    }));
                    
                    console.log(`✅ Found ${formattedPrinters.length} REAL thermal printer(s) on network:`, formattedPrinters);
                    showNotification(`Found ${formattedPrinters.length} real thermal printer(s) on network!`, 'success');
                    return formattedPrinters;
                } else {
                    // No printers found - this is normal, return empty array
                    console.log('ℹ️ No thermal printers found on network. This is normal if no printers are connected.');
                    showNotification(data.message || 'No thermal printers found on network. Use manual setup to add printer IP address.', 'info');
                    return []; // Return empty - NO dummy data
                }
            } else {
                // Scan failed
                console.error('❌ WiFi scan failed:', data.error || 'Unknown error');
                showNotification(data.message || data.error || 'WiFi scan failed. Try manual setup.', 'warning');
                return []; // Return empty - NO dummy data
            }
        } catch (error) {
            console.error('Server-side WiFi scan error:', error);
            showNotification('Server-side scan failed. Trying client-side scan...', 'warning');
            // Fallback to client-side scanning
            return await performClientSideWiFiScan();
        }
    }

    // Client-side WiFi scanning
    async function performClientSideWiFiScan() {
        try {
            console.log('Performing client-side WiFi scan...');
            const printers = [];
            
            // Get local network IP range
            const localIP = await getLocalIP();
            if (localIP) {
                const baseIP = localIP.split('.').slice(0, 3).join('.');
                console.log('Scanning local network:', baseIP + '.x');
                
                // Scan common IPs in the local network
                const scanPromises = [];
                for (let i = 1; i <= 254; i++) {
                    const ip = `${baseIP}.${i}`;
                    scanPromises.push(checkPrinterAtIP(ip, 9100));
                }
                
                const results = await Promise.allSettled(scanPromises);
                results.forEach((result, index) => {
                    if (result.status === 'fulfilled' && result.value) {
                        printers.push(result.value);
                    }
                });
            }
            
            if (printers.length > 0) {
                showNotification(`Found ${printers.length} printer(s) via client-side scan!`, 'success');
            } else {
                showNotification('No printers found. Please use manual setup.', 'warning');
            }
            
            return printers;
        } catch (error) {
            console.error('Client-side WiFi scan error:', error);
            showNotification('Client-side scan failed: ' + error.message, 'error');
            return [];
        }
    }

    // Check if printer exists at IP
    async function checkPrinterAtIP(ip, port) {
        return new Promise((resolve) => {
            const img = new Image();
            const timeout = setTimeout(() => resolve(null), 100);
            
            img.onload = () => {
                clearTimeout(timeout);
                resolve({
                    name: `Printer at ${ip}`,
                    ip: ip,
                    port: port,
                    type: 'wifi'
                });
            };
            
            img.onerror = () => {
                clearTimeout(timeout);
                resolve(null);
            };
            
            // Try to connect to printer port
            img.src = `http://${ip}:${port}`;
        });
    }

    // Get local IP address
    async function getLocalIP() {
        return new Promise((resolve) => {
            const RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
            if (!RTCPeerConnection) {
                resolve(null);
                return;
            }
            
            const pc = new RTCPeerConnection({ iceServers: [] });
            pc.createDataChannel('');
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    const candidate = event.candidate.candidate;
                    const match = candidate.match(/([0-9]{1,3}(\.[0-9]{1,3}){3})/);
                    if (match) {
                        const ip = match[1];
                        if (ip.startsWith('192.168.') || ip.startsWith('10.') || ip.startsWith('172.')) {
                            pc.close();
                            resolve(ip);
                        }
                    }
                }
            };
            pc.createOffer().then(offer => pc.setLocalDescription(offer));
            
            setTimeout(() => {
                pc.close();
                resolve(null);
            }, 2000);
        });
    }

    // Bluetooth printer scanning
    async function scanForBluetoothPrinters() {
        try {
            // Check if Web Bluetooth is supported
            if (!navigator.bluetooth || typeof navigator.bluetooth.requestDevice !== 'function') {
                showNotification('Web Bluetooth is not supported in this browser. Please use Chrome, Edge, Opera, or Opera Mini.', 'error');
                return false;
            }

            // Use enhanced manager if available
            const manager = window.enhancedBluetoothPrinterManager || window.bluetoothPrinterManager;
            
            if (!manager) {
                showNotification('Bluetooth manager not available. Please refresh the page.', 'error');
                return false;
            }

            showNotification('Select a Bluetooth printer from the device list...', 'info');

            // Request Bluetooth device with improved filters
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: [
                    '000018f0-0000-1000-8000-00805f9b34fb', // BLE thermal printer
                    '00001800-0000-1000-8000-00805f9b34fb', // Generic Access
                    '00001801-0000-1000-8000-00805f9b34fb', // Generic Attribute
                    '00001101-0000-1000-8000-00805f9b34fb', // Serial Port Profile
                    '0000ffe0-0000-1000-8000-00805f9b34fb', // Custom service
                    '0000ffe1-0000-1000-8000-00805f9b34fb'  // Custom characteristic
                ]
            });

            // Check if device was selected (not cancelled)
            if (device) {
                showNotification('Connecting to device...', 'info');
                
                let server = null;
                let retryCount = 0;
                const maxRetries = 3;
                
                // Improved connection with retry logic
                while (retryCount < maxRetries) {
                    try {
                        // Connect to the device
                        server = await device.gatt.connect();
                        
                        // Wait a bit for connection to stabilize
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        // Add printer to manager
                        const printerId = await manager.addPrinter(device, server);
                        
                        // Set up disconnect handler
                        device.addEventListener('gattserverdisconnected', () => {
                            showNotification(`Bluetooth printer "${device.name || 'Unknown'}" disconnected`, 'warning');
                            updatePrinterStatus();
                        });
                        
                        // Show success and close modal
                        showNotification(`Printer "${device.name || 'Unknown Device'}" connected successfully!`, 'success');
                        
                        // Update UI
                        updatePrinterStatus();
                        
                        // Close modal (will check if required mode and allow if printer is connected)
                        hidePrinterSetupModal();
                        
                        return true;
                    } catch (connectError) {
                        retryCount++;
                        console.warn(`Bluetooth connection attempt ${retryCount} failed:`, connectError);
                        
                        if (retryCount < maxRetries) {
                            showNotification(`Connection attempt ${retryCount} failed, retrying...`, 'info');
                            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount)); // Exponential backoff
                        } else {
                            throw connectError;
                        }
                    }
                }
            } else {
                // User cancelled the selection
                return false;
            }
        } catch (error) {
            console.error('Bluetooth scanning error:', error);
            if (error.name === 'NotFoundError') {
                showNotification('No Bluetooth device selected', 'warning');
            } else if (error.name === 'SecurityError') {
                showNotification('Bluetooth permission denied. Please allow Bluetooth access in your browser settings.', 'error');
            } else if (error.name === 'NetworkError') {
                showNotification('Bluetooth connection failed. Make sure the device is turned on and in range.', 'error');
            } else if (error.message && error.message.includes('GATT')) {
                showNotification('Bluetooth GATT error. Try disconnecting and reconnecting the device.', 'error');
            } else {
                showNotification('Bluetooth scan failed: ' + (error.message || error.toString()), 'error');
            }
            return false;
        }
    }

    // Connect to scanned printer
    async function connectToScannedPrinter(index) {
        const printers = window.scannedPrinters || window.lastScannedPrinters || [];
        if (!printers || !printers[index]) {
            showNotification('Printer not found', 'error');
            return;
        }
        
        const printer = printers[index];
        
        if (printer.type === 'wifi' && printer.ip) {
            if (window.wifiPrinterManager) {
                try {
                    const printerId = window.wifiPrinterManager.addPrinter(
                        printer.name || `WiFi Printer at ${printer.ip}`,
                        printer.ip,
                        printer.port || 9100
                    );
                    const success = await window.wifiPrinterManager.connectPrinter(printerId);
                    if (success) {
                        showNotification(`Connected to ${printer.name || printer.ip}`, 'success');
                        updatePrinterStatus();
                        // Close modal (will check if required mode and allow if printer is connected)
                        hidePrinterSetupModal();
                    } else {
                        showNotification('Failed to connect to printer', 'error');
                    }
                } catch (error) {
                    showNotification('Error connecting to printer: ' + error.message, 'error');
                }
            } else {
                showNotification('WiFi printer manager not available', 'error');
            }
        } else if (printer.type === 'usb' && printer.device) {
            if (window.usbPrinterManager) {
                try {
                    showNotification('Connecting to USB printer...', 'info');
                    const printerId = await window.usbPrinterManager.connectToPrinter(printer.device);
                    if (printerId) {
                        showNotification(`Connected to ${printer.name || 'USB Printer'}`, 'success');
                        updatePrinterStatus();
                        // Close modal (will check if required mode and allow if printer is connected)
                        hidePrinterSetupModal();
                    } else {
                        showNotification('Failed to connect to USB printer', 'error');
                    }
                } catch (error) {
                    console.error('USB connection error:', error);
                    let errorMessage = 'Error connecting to USB printer: ';
                    
                    if (error.message && (error.message.includes('Access denied') || error.message.includes('already claimed'))) {
                        errorMessage = 'USB printer access denied. The printer may be in use by another application.\n\n' +
                                      'Please try:\n' +
                                      '1. Close any other programs using this printer\n' +
                                      '2. Unplug and replug the USB printer\n' +
                                      '3. Wait a few seconds and try again';
                    } else if (error.message && error.message.includes('not found')) {
                        errorMessage = 'USB printer not found. Please make sure it is connected and try again.';
                    } else if (error.message) {
                        errorMessage += error.message;
                    } else {
                        errorMessage += 'Unknown error occurred';
                    }
                    
                    showNotification(errorMessage, 'error');
                }
            } else {
                showNotification('USB printer manager not available', 'error');
            }
        } else if (printer.type === 'usb' && printer.device) {
            if (window.usbPrinterManager) {
                try {
                    showNotification('Connecting to USB printer...', 'info');
                    const printerId = await window.usbPrinterManager.connectToPrinter(printer.device);
                    if (printerId) {
                        showNotification(`Connected to ${printer.name || 'USB Printer'}`, 'success');
                        updatePrinterStatus();
                        // Close modal (will check if required mode and allow if printer is connected)
                        hidePrinterSetupModal();
                    } else {
                        showNotification('Failed to connect to USB printer', 'error');
                    }
                } catch (error) {
                    console.error('USB connection error:', error);
                    let errorMessage = 'Error connecting to USB printer: ';
                    
                    if (error.message && (error.message.includes('Access denied') || error.message.includes('already claimed'))) {
                        errorMessage = 'USB printer access denied. The printer may be in use by another application.\n\n' +
                                      'Please try:\n' +
                                      '1. Close any other programs using this printer\n' +
                                      '2. Unplug and replug the USB printer\n' +
                                      '3. Wait a few seconds and try again';
                    } else if (error.message && error.message.includes('not found')) {
                        errorMessage = 'USB printer not found. Please make sure it is connected and try again.';
                    } else if (error.message) {
                        errorMessage += error.message;
                    } else {
                        errorMessage += 'Unknown error occurred';
                    }
                    
                    showNotification(errorMessage, 'error');
                }
            } else {
                showNotification('USB printer manager not available', 'error');
            }
        } else {
            showNotification('Unsupported printer type', 'error');
        }
    }
</script>
{% endblock %}

